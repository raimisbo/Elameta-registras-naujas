{% extends "base.html" %}
{% load static %}

{% block title %}Index{% endblock %}

{# Vietinis CSS tik šiam puslapiui — atkuria ankstesnę išvaizdą #}
{% block page_css %}
<style>
  .header-container{display:flex;justify-content:space-between;align-items:center;height:20%;padding:10px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
  .header-links{display:flex;flex-direction:column}
  .header-links a{margin-bottom:10px}

  .chart-container{width:300px;max-width:300px;height:300px;padding:10px}
  .chart-container canvas{width:100% !important;height:100% !important}

  .main-content{flex:1;overflow:auto;display:flex;flex-direction:column;padding:20px}
  .table-container{flex:1;overflow:auto;display:flex;flex-direction:column}
  .scrollable-table{display:block;height:100%;overflow-y:auto}

  table{width:100%;border-collapse:collapse;table-layout:fixed}
  th,td{padding:8px;text-align:left;border-bottom:1px solid #ddd}
  thead th{position:sticky;top:0;background:#f4f4f4;z-index:2}
  .filter-input{width:100%}

  .view-button{cursor:pointer;color:#007BFF;text-decoration:underline}
  .view-button:hover{color:#0056b3}

  .notes-cell,.detale-pavadinimas-cell{max-width:300px;word-wrap:break-word}
</style>
{% endblock %}

{# Diagrama dešinėje – kaip buvo #}
{% block header_right %}
<div class="chart-container">
  <canvas id="detaliuGrafikas"></canvas>
</div>
{% endblock %}

{% block content %}

  {# Paieškos forma (kaip anksčiau) #}
  <div class="UzklausaFilterForm">
    <form method="get" action="{% url 'perziureti_uzklausas' klientas_id=0 %}">
      {% csrf_token %}
      {{ form.as_p }}
      <input type="text" name="q" placeholder="Ieškoti..." value="{{ request.GET.q }}">
      {% for key, value in request.GET.items %}
        {% if key != 'q' %}
          <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
      {% endfor %}
      <button type="submit">Ieškoti</button>
    </form>
  </div>

  <div class="UzklausaFilterForm">
    <hr>
    <button type="button" onclick="clearFilters()">Išvalyti filtrus</button>
  </div>

  {# Lentelė su ANTROSIOS eilutės filtrais (atkūriau pilnai) #}
  <div class="table-container">
    <div class="scrollable-table">
      <table>
        <thead>
          <tr>
            <th>Kliento pavadinimas</th>
            <th>Projekto pavadinimas</th>
            <th>Detalės pavadinimas</th>
            <th>Užklausos data</th>
            <th>Pasiūlymo data</th>
            <th>Brėžinio nr.</th>
            <th>Kainos būsena</th>
            <th>Detalės kainos suma</th>
            <th>Kainos fiksuotas kiekis</th>
            <th>Kainos matas</th>
            <th>Kiekis rėme</th>
            <th>Pastabos</th>
            <th>Veiksmai</th>
          </tr>
          <tr>
            <th><input class="filter-input" type="text"  placeholder="Filtruoti..." oninput="filterTable(0)"></th>
            <th><input class="filter-input" type="text"  placeholder="Filtruoti..." oninput="filterTable(1)"></th>
            <th><input class="filter-input" type="text"  placeholder="Filtruoti..." oninput="filterTable(2)"></th>
            <th><input class="filter-input" type="date"  oninput="filterTable(3)"></th>
            <th><input class="filter-input" type="date"  oninput="filterTable(4)"></th>
            <th><input class="filter-input" type="text"  placeholder="Filtruoti..." oninput="filterTable(5)"></th>
            <th><input class="filter-input" type="text"  placeholder="Filtruoti..." oninput="filterTable(6)"></th>
            <th><input class="filter-input" type="number" placeholder="Filtruoti..." oninput="filterTable(7)"></th>
            <th><input class="filter-input" type="number" placeholder="Filtruoti..." oninput="filterTable(8)"></th>
            <th><input class="filter-input" type="text"  placeholder="Filtruoti..." oninput="filterTable(9)"></th>
            <th><input class="filter-input" type="number" placeholder="Filtruoti..." oninput="filterTable(10)"></th>
            <th><input class="filter-input" type="text"  placeholder="Filtruoti..." oninput="filterTable(11)"></th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for uzklausa in uzklausos %}
          <tr>
            <td>{{ uzklausa.klientas.vardas }}</td>
            <td>{{ uzklausa.projektas.pavadinimas }}</td>
            <td class="detale-pavadinimas-cell">{{ uzklausa.detale.pavadinimas }}</td>
            <td>{{ uzklausa.projektas.uzklausos_data }}</td>
            <td>{{ uzklausa.projektas.pasiulymo_data }}</td>
            <td>{{ uzklausa.detale.brezinio_nr }}</td>
            <td>
              {% if uzklausa.detale.kainos.all %}
                {{ uzklausa.detale.kainos.last.busena }}
              {% else %} N/A {% endif %}
            </td>
            <td>
              {% if uzklausa.detale.kainos.all %}
                {{ uzklausa.detale.kainos.last.suma }}
              {% else %} N/A {% endif %}
            </td>
            <td>
              {% if uzklausa.detale.kainos.all %}
                {{ uzklausa.detale.kainos.last.fiksuotas_kiekis }}
              {% else %} N/A {% endif %}
            </td>
            <td>
              {% if uzklausa.detale.kainos.all %}
                {{ uzklausa.detale.kainos.last.kainos_matas }}
              {% else %} N/A {% endif %}
            </td>
            <td>
              {% if uzklausa.detale.kainos.all %}
                {{ uzklausa.detale.kiekis_reme }}
              {% else %} N/A {% endif %}
            </td>
            <td class="notes-cell">{{ uzklausa.detale.pastabos }}</td>
            <td>
              <a class="view-button" href="{% url 'perziureti_uzklausa' uzklausa_id=uzklausa.id %}">Peržiūrėti</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block page_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // STULPELIŲ FILTRAI — kaip buvo
  function filterTable(columnIndex) {
    var table = document.querySelector("table");
    var tr = table.getElementsByTagName("tr");
    var input = tr[1].getElementsByTagName("th")[columnIndex].getElementsByTagName("input")[0];
    var filter = (input.value || "").toLowerCase();

    for (var i = 2; i < tr.length; i++) {
      var td = tr[i].getElementsByTagName("td")[columnIndex];
      if (td) {
        var txtValue = (td.textContent || td.innerText || "").toLowerCase();
        tr[i].style.display = (txtValue.indexOf(filter) > -1) ? "" : "none";
      }
    }
  }
  function clearFilters() {
    var inputs = document.querySelectorAll('.filter-input');
    inputs.forEach(input => input.value = '');
    var tr = document.querySelectorAll("table tr");
    for (var i = 2; i < tr.length; i++) tr[i].style.display = "";
  }

  // DIAGRAMA — stabilus dydis (be „slidinėjimo“), bet vizualiai kaip buvo
  var ctx = document.getElementById('detaliuGrafikas').getContext('2d');
  var klientuDuomenys = {{ klientu_duomenys_json|safe }};

  function getRandomColor(){
    var letters='0123456789ABCDEF', color='#';
    for (var i=0;i<6;i++) color+=letters[Math.floor(Math.random()*16)];
    return color;
  }

  var labels=[], data=[], urls=[], backgroundColors=[], borderColors=[];
  for (var i=0;i<klientuDuomenys.length;i++){
    labels.push(klientuDuomenys[i].klientas__vardas);
    data.push(klientuDuomenys[i].kiekis);
    urls.push("{% url 'perziureti_uzklausas' klientas_id=0 %}".replace("0", klientuDuomenys[i].klientas__id));
    var c=getRandomColor(); backgroundColors.push(c+'80'); borderColors.push(c);
  }

  var chart = new Chart(ctx, {
    type: 'pie',
    data: { labels: labels,
      datasets: [{ label:'Užklausų kiekis', data:data, backgroundColor:backgroundColors, borderColor:borderColors, borderWidth:1 }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      onClick: function(evt, item){
        if (item.length>0){
          var url = urls[item[0].index];
          if (url) window.location.href = url;
        }
      },
      plugins: { legend: { display:true, position:'right' } }
    }
  });
</script>
{% endblock %}
