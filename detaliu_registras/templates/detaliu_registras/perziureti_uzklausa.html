{# templates/detaliu_registras/perziureti_uzklausa.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}{{ uzklausa.klientas.vardas|default:"Užklausa" }}{% endblock %}

{% block content %}
<h1>{{ uzklausa.klientas.vardas|default:"Užklausa" }}</h1>

<section>
  <h2>Pagrindiniai duomenys</h2>
  <dl>
    <dt>Klientas</dt>
    <dd>{{ uzklausa.klientas.vardas|default:"—" }}</dd>

    <dt>Projektas</dt>
    <dd>
      {% if uzklausa.projektas %}
        {{ uzklausa.projektas.pavadinimas }}
        {% if uzklausa.projektas.aprasymas %} — {{ uzklausa.projektas.aprasymas }}{% endif %}
      {% else %}—{% endif %}
    </dd>

    <dt>Pastabos</dt>
    <dd>{{ uzklausa.pastabos|linebreaksbr|default:"—" }}</dd>
  </dl>
</section>

<hr>

<section>
  <h2>Detalė</h2>
  {% if detale_obj %}
    <dl>
      <dt>Pavadinimas</dt>
      <dd>{{ detale_obj.pavadinimas|default:"—" }}</dd>

      <dt>Brėžinio Nr.</dt>
      <dd>{{ detale_obj.brezinio_nr|default:"—" }}</dd>

      <dt>Nuoroda į brėžinį</dt>
      <dd>
        {% if detale_obj.nuoroda_brezinio %}
          <a href="{{ detale_obj.nuoroda_brezinio }}" target="_blank" rel="noopener">Atidaryti</a>
        {% else %}—{% endif %}
      </dd>

      <dt>Nuoroda į pasiūlymą</dt>
      <dd>
        {% if detale_obj.nuoroda_pasiulymo %}
          <a href="{{ detale_obj.nuoroda_pasiulymo }}" target="_blank" rel="noopener">Atidaryti</a>
        {% else %}—{% endif %}
      </dd>

      <dt>Kabinimas</dt>
      <dd>
        {% firstof detale_obj.kabinimo_budas "—" %}
        {% if detale_obj.kabliuku_kiekis %} • kabliukų: {{ detale_obj.kabliuku_kiekis }}{% endif %}
        {% if detale_obj.kabinimo_anga_mm %} • anga: {{ detale_obj.kabinimo_anga_mm }} mm{% endif %}
        {% if detale_obj.kabinti_per %} • per: {{ detale_obj.kabinti_per }}{% endif %}
      </dd>

      <dt>Pakuotė</dt>
      <dd>
        {% firstof detale_obj.pakuotes_tipas "—" %}
        {% if detale_obj.vienetai_dezeje %} • dėžė: {{ detale_obj.vienetai_dezeje }}{% endif %}
        {% if detale_obj.vienetai_paleje %} • paletė: {{ detale_obj.vienetai_paleje }}{% endif %}
        {% if detale_obj.pakuotes_pastabos %} • {{ detale_obj.pakuotes_pastabos }}{% endif %}
      </dd>

      <dt>Dokumentai / pastabos</dt>
      <dd>
        {% if detale_obj.ppap_dokumentai %}PPAP: {{ detale_obj.ppap_dokumentai }}{% else %}—{% endif %}
        {% if detale_obj.priedai_info %} • {{ detale_obj.priedai_info }}{% endif %}
      </dd>

      {# --- ISTORIJA: tame pačiame bloke kaip ir kiti duomenys --- #}
      <details open>
        <summary><strong>Detalės pakeitimų istorija</strong></summary>
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Veiksmas</th>
              <th>Vartotojas</th>
              <th>Kabinimas</th>
              <th>Pakuotė</th>
              <th>Dok./Pastabos</th>
            </tr>
          </thead>
          <tbody>
            {% for r in detale_istorija %}
              <tr>
                <td>{{ r.history_date|date:"Y-m-d H:i" }}</td>
                <td>
                  {% if r.history_type == "+" %}Sukurta{% elif r.history_type == "~" %}Atnaujinta{% elif r.history_type == "-" %}Ištrinta{% endif %}
                </td>
                <td>{{ r.history_user__username|default:"–" }}</td>
                <td>
                  {{ r.kabinimo_budas|default:"—" }}
                  {% if r.kabliuku_kiekis %} ({{ r.kabliuku_kiekis }} vnt.){% endif %}
                  {% if r.kabinimo_anga_mm %} • anga: {{ r.kabinimo_anga_mm }} mm{% endif %}
                  {% if r.kabinti_per %} • per: {{ r.kabinti_per }}{% endif %}
                </td>
                <td>
                  {{ r.pakuotes_tipas|default:"—" }}
                  {% if r.vienetai_dezeje %} • dėžė: {{ r.vienetai_dezeje }}{% endif %}
                  {% if r.vienetai_paleje %} • paletė: {{ r.vienetai_paleje }}{% endif %}
                  {% if r.pakuotes_pastabos %} • {{ r.pakuotes_pastabos }}{% endif %}
                </td>
                <td>
                  {% if r.ppap_dokumentai %}PPAP: {{ r.ppap_dokumentai }}{% else %}—{% endif %}
                  {% if r.priedai_info %} • {{ r.priedai_info }}{% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6">Istorijos nėra.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </details>
    </dl>
  {% else %}
    <p>Šiai užklausai detalė nepriskirta.</p>
  {% endif %}
</section>

<hr>

<section>
  <h2>Kainos</h2>

  <h3>Dabartinė kaina</h3>
  {% if dabartine_kaina %}
    <p>{{ dabartine_kaina }}</p>
  {% else %}
    <p>—</p>
  {% endif %}

  <details>
    <summary><strong>Kainų istorija</strong></summary>
    <table>
      <thead>
        <tr>
          <th>Nuo</th>
          <th>Iki</th>
          <th>Suma</th>
          <th>Valiuta</th>
          <th>Statusas</th>
        </tr>
      </thead>
      <tbody>
        {% for k in kainu_istorija %}
          <tr>
            <td>{{ k.galioja_nuo|date:"Y-m-d" }}</td>
            <td>{{ k.galioja_iki|date:"Y-m-d"|default:"—" }}</td>
            <td>{{ k.suma }}</td>
            <td>{{ k.valiuta }}</td>
            <td>{% if k.yra_aktuali %}AKTUALI{% else %}sena{% endif %}</td>
          </tr>
        {% empty %}
          <tr><td colspan="5">Istorijos nėra.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </details>
</section>
{% endblock %}
