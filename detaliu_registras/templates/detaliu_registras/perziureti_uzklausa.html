{% extends "base.html" %}
{% block title %}Užklausa #{{ uzklausa.pk }}{% endblock %}

{% block content %}
<div class="container">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin:12px 0">
    <h1 style="margin:0">Užklausa #{{ uzklausa.pk }}</h1>
    <div style="display:flex;gap:8px">
      <a class="btn btn-secondary" href="{% url 'detaliu_registras:uzklausa_list' %}">← Į sąrašą</a>
      <a class="btn" href="{% url 'detaliu_registras:redaguoti_uzklausa' uzklausa.pk %}">Redaguoti</a>
    </div>
  </header>

  <!-- Valdiklis blokams rodyti/slėpti (įsimena būseną) -->
  <div class="cols-config" id="cols-config" style="display:flex;align-items:center;gap:12px;margin:8px 0 10px">
    <button type="button" class="btn" id="cols-toggle">⚙️ Stulpeliai</button>
    <div class="cols-panel" id="cols-panel"
         style="display:none;gap:12px;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;background:#fff">
      <label><input type="checkbox" data-block="main" checked> Pagrindinė</label>
      <label><input type="checkbox" data-block="spec" checked> Specifikacija</label>
      <label><input type="checkbox" data-block="coats" checked> Paviršių dangos</label>
      <label><input type="checkbox" data-block="qty" checked> Kiekiai</label>
      <label><input type="checkbox" data-block="dims" checked> Matmenys</label>
      <label><input type="checkbox" data-block="hang" checked> Kabinimas</label>
      <label><input type="checkbox" data-block="pack" checked> Pakuotė</label>
      <label><input type="checkbox" data-block="qa" checked> Testai / Kokybė</label>
      <label><input type="checkbox" data-block="docs" checked> Dokumentai / Pastabos</label>
    </div>
  </div>

  {# 1) PAGRINDINĖ #}
  <section class="box block" data-block="main">
    <h3>Pagrindinė informacija</h3>
    <div class="grid">
      <div><strong>Klientas:</strong> {{ uzklausa.klientas|default:"—" }}</div>
      <div><strong>Projektas:</strong> {{ uzklausa.projektas|default:"—" }}</div>
      <div><strong>Detalė:</strong> {{ uzklausa.detale.pavadinimas|default:"—" }}</div>
      <div><strong>Brėžinio nr.:</strong> {{ uzklausa.detale.brezinio_nr|default:"—" }}</div>
      {# DATA greičiausiai DateField → be H:i #}
      <div><strong>Sukurta:</strong> {{ uzklausa.data|date:"Y-m-d" }}</div>
    </div>
  </section>

  {# 2) SPECIFIKACIJA #}
  <section class="box block" data-block="spec">
    <h3>Specifikacija</h3>
    {% if uzklausa.detale.specifikacija %}
      <div class="grid">
        <div><strong>Metalas:</strong> {{ uzklausa.detale.specifikacija.metalas|default:"—" }}</div>
        <div><strong>Plotas m²:</strong> {{ uzklausa.detale.specifikacija.plotas_m2|default:"—" }}</div>
        <div><strong>Svoris kg:</strong> {{ uzklausa.detale.specifikacija.svoris_kg|default:"—" }}</div>
        <div><strong>Medžiagos kodas:</strong> {{ uzklausa.detale.specifikacija.medziagos_kodas|default:"—" }}</div>
      </div>
    {% else %}
      <p>—</p>
    {% endif %}
  </section>

  {# 3) PAVIRŠIŲ DANGOS #}
  <section class="box block" data-block="coats">
    <h3>Paviršių dangos</h3>
    {% if uzklausa.detale.pavirsiu_dangos %}
      <div class="grid">
        <div><strong>KTL / e-coating:</strong> {{ uzklausa.detale.pavirsiu_dangos.ktl_ec_name|default:"—" }}</div>
        <div><strong>Miltelinis padengimas:</strong> {{ uzklausa.detale.pavirsiu_dangos.miltelinis_name|default:"—" }}</div>
        <div><strong>RAL / spalva:</strong> {{ uzklausa.detale.pavirsiu_dangos.spalva_ral|default:"—" }}</div>
        <div><strong>Blizgumas / tekstūra:</strong> {{ uzklausa.detale.pavirsiu_dangos.blizgumas|default:"—" }}</div>
      </div>
    {% else %}
      <p>—</p>
    {% endif %}
  </section>

  {# 4) KIEKIAI #}
  <section class="box block" data-block="qty">
    <h3>Kiekiai</h3>
    <div class="grid">
      <div><strong>Kiekis per metus:</strong> {{ uzklausa.detale.kiekis_metinis|default:"—" }}</div>
      <div><strong>Kiekis per mėnesį:</strong> {{ uzklausa.detale.kiekis_menesis|default:"—" }}</div>
      <div><strong>Kiekis partijai:</strong> {{ uzklausa.detale.kiekis_partijai|default:"—" }}</div>
      <div><strong>Gaminių/val. (jei nurodyta):</strong> {{ uzklausa.detale.kiekis_per_val|default:"—" }}</div>
    </div>
  </section>

  {# 5) MATMENYS #}
  <section class="box block" data-block="dims">
    <h3>Matmenys</h3>
    <div class="grid">
      <div><strong>Ilgis (mm):</strong> {{ uzklausa.detale.ilgis_mm|default:"—" }}</div>
      <div><strong>Plotis (mm):</strong> {{ uzklausa.detale.plotis_mm|default:"—" }}</div>
      <div><strong>Aukštis (mm):</strong> {{ uzklausa.detale.aukstis_mm|default:"—" }}</div>
      <div><strong>Skersmuo (mm):</strong> {{ uzklausa.detale.skersmuo_mm|default:"—" }}</div>
      <div><strong>Storis (mm):</strong> {{ uzklausa.detale.storis_mm|default:"—" }}</div>
      <div><strong>Paviršiaus plotas (m²):</strong> {{ uzklausa.detale.specifikacija.plotas_m2|default:"—" }}</div>
    </div>
  </section>

  {# 6) KABINIMAS #}
  <section class="box block" data-block="hang">
    <h3>Kabinimas</h3>
    <div class="grid">
      <div><strong>Kabinimo būdas:</strong> {{ uzklausa.detale.kabinimo_budas|default:"—" }}</div>
      <div><strong>Kabliukų kiekis:</strong> {{ uzklausa.detale.kabliuku_kiekis|default:"—" }}</div>
      <div><strong>Kabinimo anga (mm):</strong> {{ uzklausa.detale.kabinimo_anga_mm|default:"—" }}</div>
      <div><strong>Kabinti per:</strong> {{ uzklausa.detale.kabinti_per|default:"—" }}</div>
    </div>
  </section>

  {# 7) PAKUOTĖ #}
  <section class="box block" data-block="pack">
    <h3>Pakuotė</h3>
    <div class="grid">
      <div><strong>Pakuotės tipas:</strong> {{ uzklausa.detale.pakuotes_tipas|default:"—" }}</div>
      <div><strong>Vnt/dėžėje:</strong> {{ uzklausa.detale.vienetai_dezeje|default:"—" }}</div>
      <div><strong>Vnt/palėje:</strong> {{ uzklausa.detale.vienetai_paleje|default:"—" }}</div>
      <div><strong>Spec. žymėjimas:</strong> {{ uzklausa.detale.pakuotes_pastabos|default:"—" }}</div>
    </div>
  </section>

  {# 8) TESTAI / KOKYBĖ #}
  <section class="box block" data-block="qa">
    <h3>Testai / Kokybė</h3>
    <div class="grid">
      <div><strong>Druskos rūkas (val.):</strong> {{ uzklausa.detale.testai_druskos_rukas_val|default:"—" }}</div>
      <div><strong>Adhezijos testas:</strong> {{ uzklausa.detale.testas_adhezija|default:"—" }}</div>
      <div><strong>Storis (µm):</strong> {{ uzklausa.detale.testas_storis_mikronai|default:"—" }}</div>
      <div><strong>Kiti reikalavimai:</strong> {{ uzklausa.detale.testai_kita|default:"—" }}</div>
    </div>
  </section>

  {# 9) DOKUMENTAI / PASTABOS #}
  <section class="box block" data-block="docs">
    <h3>Dokumentai / Pastabos</h3>
    <div class="grid">
      <div><strong>PPAP dokumentai:</strong> {{ uzklausa.detale.ppap_dokumentai|default:"—" }}</div>
      <div><strong>Brėžiniai / priedai:</strong> {{ uzklausa.detale.priedai_info|default:"—" }}</div>
      <div><strong>Projekto aprašymas:</strong> {{ uzklausa.projektas.aprasymas|default:"—" }}</div>
      <div><strong>Užklausos pastabos:</strong> {{ uzklausa.pastabos|default:"—" }}</div>
    </div>
  </section>

  {# --- KAINA --- #}
{% include "detaliu_registras/components/kainos_blokas.html" %}
<section class="box">
  <h3>Kaina</h3>
  <div class="grid">
    <div>
      <strong>Aktuali kaina:</strong>
      {% if kaina_aktuali %}
        {{ kaina_aktuali.suma }} {{ kaina_aktuali.valiuta }} ({{ kaina_aktuali.busena }})
      {% else %}
        — nėra
      {% endif %}
    </div>
    <div>
      <a class="btn" href="{% url 'detaliu_registras:prideti_kaina' uzklausa.pk %}">➕ Nauja kaina</a>
    </div>
  </div>

  {% if kainos %}
    <div style="margin-top:10px">
      <strong>Istorija:</strong>
      <ul style="margin:6px 0 0 18px">
        {% for k in kainos %}
          <li>
            {{ k.suma }} {{ k.valiuta }} — {{ k.busena }} (ID: {{ k.id }})
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</section>
</div>

<style>
.container{max-width:960px;margin:0 auto;padding:0 16px}
.box{border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin:12px 0;background:#fff}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(max-width:640px){.grid{grid-template-columns:1fr}}
</style>

<script>
/* ===== Blokų panelė – toks pat patikimas toggle kaip sąraše ===== */
(function() {
  const STORAGE_KEY = "uzklausa_blocks_v1";       // kuriuos blokus rodyti
  const PANEL_OPEN_KEY = "uzklausa_blocks_panel";  // ar panelė atidaryta

  function init() {
    const wrap  = document.getElementById("cols-config");
    if (!wrap) return;

    const btn   = wrap.querySelector("#cols-toggle");
    const panel = wrap.querySelector("#cols-panel");
    const checks = panel ? panel.querySelectorAll('input[type="checkbox"][data-block]') : [];

    // panelė (įsimenama būsena)
    if (btn && panel) {
      const savedOpen = localStorage.getItem(PANEL_OPEN_KEY);
      panel.style.display = savedOpen === "1" ? "flex" : "none";
      btn.addEventListener("click", function(e){
        e.preventDefault();
        const openNow = panel.style.display === "none";
        panel.style.display = openNow ? "flex" : "none";
        try { localStorage.setItem(PANEL_OPEN_KEY, openNow ? "1" : "0"); } catch {}
      });
    }

    const blocks = document.querySelectorAll(".block[data-block]");

    function apply(map) {
      blocks.forEach(b => {
        const key = b.dataset.block;
        b.style.display = (map[key] !== false) ? "" : "none";
      });
      checks.forEach(ch => {
        if (map.hasOwnProperty(ch.dataset.block)) ch.checked = map[ch.dataset.block] !== false;
        else ch.checked = true;
      });
    }
    function currentFromChecks() {
      const m = {};
      checks.forEach(ch => m[ch.dataset.block] = ch.checked);
      return m;
    }
    function loadPrefs() {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function savePrefs(map) { localStorage.setItem(STORAGE_KEY, JSON.stringify(map)); }

    const saved = loadPrefs();
    if (saved) apply(saved);
    if (!saved) apply(currentFromChecks());

    checks.forEach(ch => ch.addEventListener("change", () => {
      const m = currentFromChecks();
      apply(m);
      savePrefs(m);
    }));
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>
{% endblock %}
