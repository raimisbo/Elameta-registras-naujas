{% extends "base.html" %}
{% block title %}Redaguoti užklausą #{{ form.instance.pk }}{% endblock %}

{% block content %}
<div class="container">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin:12px 0">
    <h1 style="margin:0">Redaguoti užklausą #{{ form.instance.pk }}</h1>
    <div style="display:flex;gap:8px">
      <a class="btn btn-secondary" href="{% url 'detaliu_registras:perziureti_uzklausa' form.instance.pk %}">← Atgal į peržiūrą</a>
      <a class="btn btn-secondary" href="{% url 'detaliu_registras:uzklausa_list' %}">Sąrašas</a>
    </div>
  </header>

  {% if form.non_field_errors %}
    <div class="flash flash-error">{{ form.non_field_errors }}</div>
  {% endif %}

  <!-- Valdiklis blokams rodyti/slėpti -->
  <div class="cols-config" id="cols-config" style="display:flex;align-items:center;gap:12px;margin:8px 0 10px">
    <button type="button" class="btn" id="cols-toggle">⚙️ Stulpeliai</button>
    <div class="cols-panel" id="cols-panel"
         style="display:none;gap:12px;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;background:#fff">
      <label><input type="checkbox" data-block="main" checked> Pagrindinė</label>
      <label><input type="checkbox" data-block="spec" checked> Specifikacija</label>
      <label><input type="checkbox" data-block="coats" checked> Paviršių dangos</label>
      <label><input type="checkbox" data-block="qty" checked> Kiekiai</label>
      <label><input type="checkbox" data-block="dims" checked> Matmenys</label>
      <label><input type="checkbox" data-block="hang" checked> Kabinimas</label>
      <label><input type="checkbox" data-block="pack" checked> Pakuotė</label>
      <label><input type="checkbox" data-block="qa" checked> Testai / Kokybė</label>
      <label><input type="checkbox" data-block="docs" checked> Dokumentai / Pastabos</label>
    </div>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- 1) Pagrindinė -->
    <section class="box block" data-block="main">
      <h3>Pagrindinė</h3>
      <div class="grid">
        <label class="field"><span>Klientas</span>{{ form.klientas }}</label>
        <label class="field"><span>Projektas</span>{{ form.projektas }}</label>
        <label class="field"><span>Detalė</span>{{ form.detale }}</label>
        <label class="field"><span>Detalės pavadinimas</span>{{ form.detale_pavadinimas }}</label>
        <label class="field"><span>Brėžinio nr.</span>{{ form.detale_brezinio_nr }}</label>
      </div>
    </section>

    <!-- 2) Specifikacija -->
    <section class="box block" data-block="spec">
      <h3>Specifikacija</h3>
      <div class="grid">
        <label class="field"><span>Metalas</span>{{ form.metalas }}</label>
        <label class="field"><span>Plotas m²</span>{{ form.plotas_m2 }}</label>
        <label class="field"><span>Svoris kg</span>{{ form.svoris_kg }}</label>
        <label class="field"><span>Medžiagos kodas</span>{{ form.medziagos_kodas }}</label>
      </div>
    </section>

    <!-- 3) Dangos -->
    <section class="box block" data-block="coats">
      <h3>Paviršių dangos</h3>
      <div class="grid">
        <label class="field"><span>KTL / e-coating</span>{{ form.ktl_ec_name }}</label>
        <label class="field"><span>Miltelinis padengimas</span>{{ form.miltelinis_name }}</label>
        <label class="field"><span>RAL / spalva</span>{{ form.spalva_ral }}</label>
        <label class="field"><span>Blizgumas / tekstūra</span>{{ form.blizgumas }}</label>
      </div>
    </section>

    <!-- 4) Kiekiai -->
    <section class="box block" data-block="qty">
      <h3>Kiekiai</h3>
      <div class="grid">
        <label class="field"><span>Kiekis per metus</span>{{ form.kiekis_metinis }}</label>
        <label class="field"><span>Kiekis per mėnesį</span>{{ form.kiekis_menesis }}</label>
        <label class="field"><span>Kiekis partijai</span>{{ form.kiekis_partijai }}</label>
        <label class="field"><span>Gaminių/val.</span>{{ form.kiekis_per_val }}</label>
      </div>
    </section>

    <!-- 5) Matmenys -->
    <section class="box block" data-block="dims">
      <h3>Matmenys</h3>
      <div class="grid">
        <label class="field"><span>Ilgis (mm)</span>{{ form.ilgis_mm }}</label>
        <label class="field"><span>Plotis (mm)</span>{{ form.plotis_mm }}</label>
        <label class="field"><span>Aukštis (mm)</span>{{ form.aukstis_mm }}</label>
        <label class="field"><span>Skersmuo (mm)</span>{{ form.skersmuo_mm }}</label>
        <label class="field"><span>Storis (mm)</span>{{ form.storis_mm }}</label>
      </div>
    </section>

    <!-- 6) Kabinimas -->
    <section class="box block" data-block="hang">
      <h3>Kabinimas</h3>
      <div class="grid">
        <label class="field"><span>Kabinimo būdas</span>{{ form.kabinimo_budas }}</label>
        <label class="field"><span>Kabliukų kiekis</span>{{ form.kabliuku_kiekis }}</label>
        <label class="field"><span>Kabinimo anga (mm)</span>{{ form.kabinimo_anga_mm }}</label>
        <label class="field"><span>Kabinti per</span>{{ form.kabinti_per }}</label>
      </div>
    </section>

    <!-- 7) Pakuotė -->
    <section class="box block" data-block="pack">
      <h3>Pakuotė</h3>
      <div class="grid">
        <label class="field"><span>Pakuotės tipas</span>{{ form.pakuotes_tipas }}</label>
        <label class="field"><span>Vnt/dėžėje</span>{{ form.vienetai_dezeje }}</label>
        <label class="field"><span>Vnt/palėje</span>{{ form.vienetai_paleje }}</label>
        <label class="field"><span>Spec. žymėjimas</span>{{ form.pakuotes_pastabos }}</label>
      </div>
    </section>

    <!-- 8) Testai / Kokybė -->
    <section class="box block" data-block="qa">
      <h3>Testai / Kokybė</h3>
      <div class="grid">
        <label class="field"><span>Druskos rūkas (val.)</span>{{ form.testai_druskos_rukas_val }}</label>
        <label class="field"><span>Adhezijos testas</span>{{ form.testas_adhezija }}</label>
        <label class="field"><span>Storis (µm)</span>{{ form.testas_storis_mikronai }}</label>
        <label class="field"><span>Kiti reikalavimai</span>{{ form.testai_kita }}</label>
      </div>
    </section>

    <!-- 9) Dokumentai / Pastabos -->
    <section class="box block" data-block="docs">
      <h3>Dokumentai / Pastabos</h3>
      <div class="grid">
        <label class="field"><span>PPAP dokumentai</span>{{ form.ppap_dokumentai }}</label>
        <label class="field"><span>Brėžiniai / priedai</span>{{ form.priedai_info }}</label>
        <label class="field"><span>Projekto aprašymas</span>{{ form.projekto_aprasymas }}</label>
        {% if form.uzklausos_pastabos %}
          <label class="field"><span>Užklausos pastabos</span>{{ form.uzklausos_pastabos }}</label>
        {% endif %}
      </div>
    </section>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px">
      <button class="btn" type="submit">Išsaugoti</button>
      <a class="btn btn-secondary" href="{% url 'detaliu_registras:perziureti_uzklausa' form.instance.pk %}">Atšaukti</a>
    </div>
  </form>
</div>

<style>
.container{max-width:960px;margin:0 auto;padding:0 16px}
.box{border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin:12px 0;background:#fff}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(max-width:640px){.grid{grid-template-columns:1fr}}
.field{display:flex;flex-direction:column;gap:6px}
.field input,.field select,.field textarea{padding:8px 10px;border:1px solid #d1d5db;border-radius:6px}
</style>

<script>
(function() {
  const STORAGE_KEY = "uzklausa_edit_blocks_v1";  // kurie blokai matomi
  const PANEL_OPEN_KEY = "uzklausa_edit_blocks_panel";

  function init() {
    const wrap  = document.getElementById("cols-config");
    if (!wrap) return;

    const btn   = wrap.querySelector("#cols-toggle");
    const panel = wrap.querySelector("#cols-panel");
    const checks = panel ? panel.querySelectorAll('input[type="checkbox"][data-block]') : [];
    const blocks = document.querySelectorAll(".block[data-block]");

    if (btn && panel) {
      const savedOpen = localStorage.getItem(PANEL_OPEN_KEY);
      panel.style.display = savedOpen === "1" ? "flex" : "none";
      btn.addEventListener("click", function(e){
        e.preventDefault();
        const openNow = panel.style.display === "none";
        panel.style.display = openNow ? "flex" : "none";
        try { localStorage.setItem(PANEL_OPEN_KEY, openNow ? "1" : "0"); } catch {}
      });
    }

    function apply(map) {
      blocks.forEach(b => {
        const key = b.dataset.block;
        b.style.display = (map[key] !== false) ? "" : "none";
      });
      checks.forEach(ch => {
        if (map.hasOwnProperty(ch.dataset.block)) ch.checked = map[ch.dataset.block] !== false;
        else ch.checked = true;
      });
    }
    function currentFromChecks() {
      const m = {};
      checks.forEach(ch => m[ch.dataset.block] = ch.checked);
      return m;
    }
    function loadPrefs() {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function savePrefs(map) { localStorage.setItem(STORAGE_KEY, JSON.stringify(map)); }

    const saved = loadPrefs();
    if (saved) apply(saved);
    if (!saved) apply(currentFromChecks());

    checks.forEach(ch => ch.addEventListener("change", () => {
      const m = currentFromChecks();
      apply(m);
      savePrefs(m);
    }));
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>
{% endblock %}
