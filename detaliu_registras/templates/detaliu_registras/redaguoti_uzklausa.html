{% extends "base.html" %}
{% block title %}Redaguoti užklausą{% endblock %}

{% block content %}
<h1>Redaguoti užklausą #{{ object.id }}</h1>

<form method="post" novalidate>
  {% csrf_token %}
  {% if form.non_field_errors %}
    <div class="flash flash-error">{{ form.non_field_errors }}</div>
  {% endif %}

  <section>
    <h3>Pagrindinė informacija</h3>
    <div class="form-grid">
      <div class="form-field">
        <label>Klientas</label>
        {{ form.klientas }}
      </div>
      <div class="form-field">
        <label>Projektas</label>
        {{ form.projektas }}
      </div>
      <div class="form-field">
        <label>Detalė</label>
        {{ form.detale }}
      </div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Detalės bazė</h3>
    <div class="form-grid">
      <div class="form-field">
        <label>Detalės pavadinimas</label>
        {{ form.detale_pavadinimas }}
      </div>
      <div class="form-field">
        <label>Brėžinio nr.</label>
        {{ form.detale_brezinio_nr }}
      </div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Kiekiai</h3>
    <div class="form-grid">
      <div class="form-field">{{ form.kiekis_metinis.label_tag }}{{ form.kiekis_metinis }}</div>
      <div class="form-field">{{ form.kiekis_menesis.label_tag }}{{ form.kiekis_menesis }}</div>
      <div class="form-field">{{ form.kiekis_partijai.label_tag }}{{ form.kiekis_partijai }}</div>
      <div class="form-field">{{ form.kiekis_per_val.label_tag }}{{ form.kiekis_per_val }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Matmenys</h3>
    <div class="form-grid">
      <div class="form-field">{{ form.ilgis_mm.label_tag }}{{ form.ilgis_mm }}</div>
      <div class="form-field">{{ form.plotis_mm.label_tag }}{{ form.plotis_mm }}</div>
      <div class="form-field">{{ form.aukstis_mm.label_tag }}{{ form.aukstis_mm }}</div>
      <div class="form-field">{{ form.skersmuo_mm.label_tag }}{{ form.skersmuo_mm }}</div>
      <div class="form-field">{{ form.storis_mm.label_tag }}{{ form.storis_mm }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Specifikacija</h3>
    <div class="form-grid">
      <div class="form-field">{{ form.metalas.label_tag }}{{ form.metalas }}</div>
      <div class="form-field">{{ form.plotas_m2.label_tag }}{{ form.plotas_m2 }}</div>
      <div class="form-field">{{ form.svoris_kg.label_tag }}{{ form.svoris_kg }}</div>
      <div class="form-field">{{ form.medziagos_kodas.label_tag }}{{ form.medziagos_kodas }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Dangos</h3>
    <div class="form-grid">
      <div class="form-field">{{ form.ktl_ec_name.label_tag }}{{ form.ktl_ec_name }}</div>
      <div class="form-field">{{ form.miltelinis_name.label_tag }}{{ form.miltelinis_name }}</div>
      <div class="form-field">{{ form.spalva_ral.label_tag }}{{ form.spalva_ral }}</div>
      <div class="form-field">{{ form.blizgumas.label_tag }}{{ form.blizgumas }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Kabinimas</h3>
    <div class="form-grid">
      <div class="form-field">{{ form.kabinimo_budas.label_tag }}{{ form.kabinimo_budas }}</div>
      <div class="form-field">{{ form.kabliuku_kiekis.label_tag }}{{ form.kabliuku_kiekis }}</div>
      <div class="form-field">{{ form.kabinimo_anga_mm.label_tag }}{{ form.kabinimo_anga_mm }}</div>
      <div class="form-field">{{ form.kabinti_per.label_tag }}{{ form.kabinti_per }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Pakuotė</h3>
    <div class="form-grid">
      <div class="form-field">{{ form.pakuotes_tipas.label_tag }}{{ form.pakuotes_tipas }}</div>
      <div class="form-field">{{ form.vienetai_dezeje.label_tag }}{{ form.vienetai_dezeje }}</div>
      <div class="form-field">{{ form.vienetai_paleje.label_tag }}{{ form.vienetai_paleje }}</div>
      <div class="form-field">{{ form.pakuotes_pastabos.label_tag }}{{ form.pakuotes_pastabos }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Testai / Kokybė</h3>
    <div class="form-grid">
      <div class="form-field">{{ form.testai_druskos_rukas_val.label_tag }}{{ form.testai_druskos_rukas_val }}</div>
      <div class="form-field">{{ form.testas_adhezija.label_tag }}{{ form.testas_adhezija }}</div>
      <div class="form-field">{{ form.testas_storis_mikronai.label_tag }}{{ form.testas_storis_mikronai }}</div>
      <div class="form-field">{{ form.testai_kita.label_tag }}{{ form.testai_kita }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Dokumentai / Pastabos</h3>
    <div class="form-grid">
      <div class="form-field" style="grid-column:1/-1">{{ form.projekto_aprasymas.label_tag }}{{ form.projekto_aprasymas }}</div>
      <div class="form-field" style="grid-column:1/-1">{{ form.uzklausos_pastabos.label_tag }}{{ form.uzklausos_pastabos }}</div>
    </div>
  </section>

  <section style="margin-top:18px">
    <h3>Kaina (mini)</h3>

    {% if dabartine_kaina %}
      <p><strong>Dabartinė:</strong> {{ dabartine_kaina.suma }} {{ dabartine_kaina.valiuta }}
        <small>(nuo {{ dabartine_kaina.galioja_nuo }})</small>
        {% if not dabartine_kaina.yra_aktuali %}<em> (sena)</em>{% endif %}
      </p>
    {% endif %}

    <p class="help" style="margin:6px 0 12px; color:#475569">
      Nurodžius naują sumą – bus sukurta nauja kaina ir uždaryta sena.
    </p>

    <div class="form-grid">
      <div class="form-field">
        <label>Nauja kaina</label>
        {{ form.kaina_suma }}
      </div>
      <div class="form-field">
        <label>Valiuta</label>
        {{ form.kaina_valiuta }}
      </div>
      <div class="form-field" style="grid-column: 1 / -1;">
        <label>Keitimo priežastis</label>
        {{ form.kaina_priezastis }}
      </div>
    </div>

    <p style="margin-top:10px">
      <a class="btn btn-secondary"
         href="{% url 'detaliu_registras:prideti_kaina' object.id %}"
         target="_blank" rel="noopener">
        Išsamiai redaguoti kainą
      </a>
    </p>

    {% if kainu_istorija_trumpa %}
      <details style="margin-top:12px;">
        <summary><strong>Paskutiniai kainų keitimai</strong></summary>
        <ul style="margin-top:8px">
          {% for k in kainu_istorija_trumpa %}
            <li>
              {{ k.galioja_nuo }} — {{ k.suma }} {{ k.valiuta }}
              {% if k.yra_fiksuota and k.fiksuotas_kiekis %} ({{ k.fiksuotas_kiekis }} {{ k.kainos_matas }}){% endif %}
              {% if not k.yra_aktuali %} <em>(sena)</em>{% endif %}
            </li>
          {% empty %}
            <li><em>Įrašų nėra.</em></li>
          {% endfor %}
        </ul>
      </details>
    {% endif %}
  </section>

  <div style="margin-top:20px">
    <button class="btn" type="submit">Išsaugoti</button>
    <a class="btn btn-secondary" href="{% url 'detaliu_registras:uzklausa_list' %}">Atgal</a>
  </div>
</form>
{% endblock %}

{% block extra_head %}
<style>
  .form-field{margin:8px 0}
  .form-grid{display:grid; gap:12px; grid-template-columns: repeat(2, minmax(0,1fr));}
  @media (max-width: 720px){ .form-grid{grid-template-columns: 1fr;} }
  label{display:block; font-weight:600; margin-bottom:4px}
  input, select, textarea{width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:8px; background:#fff}
</style>
{% endblock %}
