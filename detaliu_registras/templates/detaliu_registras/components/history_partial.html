{% if error %}
  <div style="padding:8px 10px;border:1px solid #fecaca;background:#fee2e2;border-radius:6px;color:#7f1d1d">
    {{ error }}
  </div>
{% else %}
  <style>
    /* Scoped tik šiam fragmentui */
    .hist-card{border:1px solid #e5e7eb;border-radius:8px;background:#fff;margin-top:6px;overflow:hidden}
    .hist-head{background:#f9fafb;color:#374151;font-size:.85rem;padding:6px 10px;border-bottom:1px solid #e5e7eb}
    .hist-table{width:100%;border-collapse:collapse}
    .hist-table th,.hist-table td{
      padding:8px 10px;border-bottom:1px solid #f3f4f6;vertical-align:top;text-align:center
    }
    .hist-table th{font-weight:600}
    .hist-table td.date{font-variant-numeric:tabular-nums}
    /* Pokyčių stulpelis: kai yra realūs pokyčiai -> kairinis lygiavimas */
    .hist-table td.changes.left{text-align:left}
    .hist-foot{padding:6px 10px}
    .hist-note{color:#6b7280;margin:6px 0}
    .hist-more{display:inline-block;text-decoration:none}
    .hist-more:hover{text-decoration:underline}
  </style>

  {% if history_diffs %}
    <div class="hist-card">
      <div class="hist-head">Istorija</div>
      <table class="hist-table">
        <thead>
          <tr>
            <th>Data</th>
            <th>Vartotojas</th>
            <th>Tipas</th>
            <th>Pokyčiai</th>
          </tr>
        </thead>
        <tbody>
          {% for row in history_diffs %}
            {% with h=row.h changes=row.changes %}
              <tr>
                <td class="date">{{ h.history_date|date:"Y-m-d H:i" }}</td>
                <td class="user">{% firstof h.history_user.get_full_name h.history_user.username "—" %}</td>
                <td class="type">
                  {% if h.history_type == "+" %}Sukurta
                  {% elif h.history_type == "~" %}Pakeista
                  {% elif h.history_type == "-" %}Ištrinta
                  {% else %}—{% endif %}
                </td>
                <td class="changes {% if changes %}left{% endif %}">
                  {% if changes %}
                    {% for c in changes %}
                      <div><strong>{{ c.field }}:</strong> “{{ c.old|default:"—" }}” → “{{ c.new|default:"—" }}”</div>
                    {% endfor %}
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% endwith %}
          {% endfor %}
        </tbody>
      </table>

      <div class="hist-foot">
        <a
          class="hist-more js-history-link"
          data-target="closest"
          data-mode="more"
          href="{% url 'detaliu_registras_history:history_partial' uzklausa_pk model obj_pk %}?limit={{ limit|add:'20' }}"
        >Rodyti daugiau</a>
      </div>
    </div>

    <div class="hist-note">
      Jei „Vartotojas“ rodo „—“, įrašas sukurtas be prisijungusio naudotojo
      arba dar neįjungtas <code>HistoryRequestMiddleware</code>.
    </div>
  {% else %}
    <div class="hist-note">Istorijos įrašų dar nėra.</div>
  {% endif %}
{% endif %}
