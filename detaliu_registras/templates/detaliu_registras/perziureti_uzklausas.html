{# templates/detaliu_registras/perziureti_uzklausas.html #}
{% extends "base.html" %}

{% block title %}Užklausos{% endblock %}

{% block extra_head %}
<style>
  /* Sticky thead */
  .table thead th{
    position: sticky; top: 0; z-index: 3;
    background: #f3f4f6; border-bottom: 1px solid #e5e7eb;
  }

  /* Stulpelių valdymas – mygtukas + horizontali panelė vienoje eilėje */
  #cols-config{ display:flex; align-items:center; gap:8px; }
  #cols-panel{
    display:none;           /* slepiam kol nepaspaustas mygtukas */
    margin-left:8px;
    padding:6px 8px;
    border:1px solid #e5e7eb; border-radius:8px; background:#fff;
    white-space:nowrap;     /* viena eilutė */
    overflow-x:auto;        /* jei netelpa – horizontaliai scroll'inam */
    -webkit-overflow-scrolling:touch;
  }
  #cols-panel.show{
    display:inline-flex; align-items:center; gap:12px; flex-wrap:nowrap;
  }
  #cols-panel label{
    display:inline-flex; align-items:center; gap:6px; font-size:13px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <!-- Antraštė + donut (be pokyčių) -->
  <header class="list-header" style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin:16px 0 12px;">
    <h1 style="margin:0">Užklausos</h1>
    <div class="donut" id="donut" data-total="{{ chart_total|default:0 }}" style="position:relative;display:flex;align-items:center;gap:14px;">
      <svg viewBox="0 0 120 120" class="donut-svg" aria-hidden="true" style="width:120px;height:120px;display:block">
        <circle class="ring-bg" cx="60" cy="60" r="54" style="fill:none;stroke:#e5e7eb;stroke-width:12;stroke-linecap:round;" />
        <g class="segments"></g>
      </svg>
      <div class="donut-center" style="position:absolute;left:0;top:0;width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;">
        <div class="donut-total" style="font-size:22px;font-weight:700;line-height:1">{{ chart_total|default:0 }}</div>
        <div class="donut-label" style="font-size:12px;color:#6b7280">įrašų</div>
      </div>
      <div class="donut-legend" id="donut-legend" style="display:flex;flex-direction:column;gap:4px;min-width:160px"></div>
    </div>
    {{ chart_segments|json_script:"segments-data" }}
  </header>

  <!-- Filtrai -->
  <section class="filters-wrap" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px">
    <form method="get" class="filters-form" style="display:flex;flex-direction:column;gap:12px">
      {% if active_seg %}<input type="hidden" name="seg" value="{{ active_seg }}">{% endif %}

      <div class="filters-grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Paieška</span>{{ filter_form.q }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Klientas</span>{{ filter_form.klientas }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Projektas</span>{{ filter_form.projektas }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Detalė</span>{{ filter_form.detale }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Brėžinio nr.</span>{{ filter_form.brezinio_nr }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Metalas</span>{{ filter_form.metalas }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Padengimas</span>{{ filter_form.padengimas }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Kaina nuo (€)</span>{{ filter_form.kaina_nuo }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Kaina iki (€)</span>{{ filter_form.kaina_iki }}</label>
      </div>

      <div class="filters-actions" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <a class="btn" href="{% url 'detaliu_registras:ivesti_uzklausa' %}">+ Nauja užklausa</a>

        <!-- Stulpelių mygtukas + HORIZONTALI panelė TOJE PAČIOJE EILĖJE -->
        <div id="cols-config">
          <button type="button" class="btn btn-secondary" id="cols-toggle">⚙️ Stulpeliai</button>
          <div class="cols-panel" id="cols-panel">
            <label><input type="checkbox" data-col="id" checked> ID</label>
            <label><input type="checkbox" data-col="klientas" checked> Klientas</label>
            <label><input type="checkbox" data-col="projektas" checked> Projektas</label>
            <label><input type="checkbox" data-col="detale" checked> Detalė</label>
            <label><input type="checkbox" data-col="brezinys" checked> Brėžinio nr.</label>
            <label><input type="checkbox" data-col="metalas" checked> Metalas</label>
            <label><input type="checkbox" data-col="padengimas" checked> KTL/Milt.</label>
            <label><input type="checkbox" data-col="sukurta" checked> Sukurta</label>
            <label><input type="checkbox" data-col="veiksmai" checked> Veiksmai</label>
          </div>
        </div>

        <span style="flex:1"></span>
        <button class="btn" type="submit">Filtruoti</button>
        <a class="btn" href="{% url 'detaliu_registras:uzklausa_list' %}">Išvalyti</a>
      </div>
    </form>
  </section>

  <!-- Lentelė -->
  <section class="table-wrap" style="max-height:75vh; overflow:auto; position:relative">
    <table class="table" style="width:100%; border-collapse:separate; border-spacing:0">
      <thead>
        <tr>
          <th data-col="id">ID</th>
          <th data-col="klientas">Klientas</th>
          <th data-col="projektas">Projektas</th>
          <th data-col="detale">Detalė</th>
          <th data-col="brezinys">Brėžinio nr.</th>
          <th data-col="metalas">Metalas</th>
          <th data-col="padengimas">KTL/Milt.</th>
          <th data-col="sukurta">Sukurta</th>
          <th data-col="veiksmai" style="text-align:right">Veiksmai</th>
        </tr>
      </thead>
      <tbody>
        {% for u in uzklausos %}
          <tr>
            <td data-col="id"><a href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">#{{ u.pk }}</a></td>
            <td data-col="klientas">{{ u.klientas|default:"—" }}</td>
            <td data-col="projektas">{{ u.projektas|default:"—" }}</td>
            <td data-col="detale">{{ u.detale.pavadinimas|default:"—" }}</td>
            <td data-col="brezinys" style="font-family:ui-monospace,Menlo,monospace">{{ u.detale.brezinio_nr|default:"—" }}</td>
            <td data-col="metalas">
              {% if u.detale.specifikacija %}{{ u.detale.specifikacija.metalas|default:"—" }}{% else %}—{% endif %}
            </td>
            <td data-col="padengimas">
              {% if u.detale.pavirsiu_dangos %}
                {{ u.detale.pavirsiu_dangos.ktl_ec_name|default_if_none:"" }}{% if u.detale.pavirsiu_dangos.ktl_ec_name and u.detale.pavirsiu_dangos.miltelinis_name %} / {% endif %}{{ u.detale.pavirsiu_dangos.miltelinis_name|default_if_none:"" }}
              {% else %}—{% endif %}
            </td>
            <td data-col="sukurta">{{ u.data|date:"Y-m-d" }}</td>
            <td data-col="veiksmai" style="text-align:right">
              <a class="btn" href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">Peržiūrėti</a>
              <a class="btn btn-secondary" href="{% url 'detaliu_registras:redaguoti_uzklausa' u.pk %}">Redaguoti</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="9" style="color:#6b7280;font-style:italic;text-align:center;padding:8px">Įrašų nėra.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  {% if is_paginated %}
    <nav class="pagination" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:12px 0 18px">
      {% if page_obj.has_previous %}
        <a class="page btn btn-secondary" href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">‹</a>
      {% else %}<span class="page btn btn-secondary" style="opacity:.5;pointer-events:none">‹</span>{% endif %}
      <span class="page" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;background:#f3f4f6">Puslapis {{ page_obj.number }} iš {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="page btn btn-secondary" href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">›</a>
      {% else %}<span class="page btn btn-secondary" style="opacity:.5;pointer-events:none">›</span>{% endif %}
    </nav>
  {% endif %}
</div>

<script>
/* ===== Donut grafikas: spalvos + click filtravimas ===== */
(function() {
  const donut = document.getElementById("donut");
  if (!donut) return;

  const total = parseInt(donut.dataset.total || "0", 10);
  const dataEl = document.getElementById("segments-data");
  let segments = [];
  try { segments = JSON.parse(dataEl?.textContent || "[]"); } catch(e) { segments = []; }

  const svg = donut.querySelector(".donut-svg");
  const g = svg.querySelector(".segments");
  const r = 54, C = 2 * Math.PI * r;

  // Spalvų paletė
  const COLORS = ["#2563EB","#10B981","#F59E0B","#EF4444","#8B5CF6","#06B6D4","#22C55E","#D946EF"];

  function goToSeg(slug) {
    const url = new URL(window.location.href);
    const current = url.searchParams.get("seg") || "";
    if (current === slug) url.searchParams.delete("seg");
    else url.searchParams.set("seg", slug);
    window.location.href = url.toString();
  }

  // Išvalom, jei kas nors buvo
  if (g) g.innerHTML = "";

  if (!total || !segments || !segments.length) {
    const legend = document.getElementById("donut-legend");
    if (legend) legend.innerHTML = '<div style="color:#6b7280">Nėra duomenų grafikai.</div>';
    return;
  }

  let offset = 0;
  segments.forEach((s, i) => {
    const val = Number(s.value || 0);
    if (val <= 0) return;

    const dash = Math.max(0.0001, (val / total) * C);
    const gap  = C - dash;

    const arc = document.createElementNS("http://www.w3.org/2000/svg","circle");
    arc.setAttribute("cx","60");
    arc.setAttribute("cy","60");
    arc.setAttribute("r", String(r));
    arc.setAttribute("fill","none");
    arc.setAttribute("stroke-linecap","round");
    arc.setAttribute("stroke-width","12");
    arc.setAttribute("stroke", COLORS[i % COLORS.length]);   // <-- spalvos!
    arc.setAttribute("stroke-dasharray", `${dash} ${gap}`);
    arc.setAttribute("stroke-dashoffset", String(offset));
    arc.style.transform = "rotate(-90deg)";
    arc.style.transformOrigin = "50% 50%";
    arc.style.cursor = "pointer";
    arc.addEventListener("click", () => goToSeg(s.slug || ""));
    g.appendChild(arc);

    offset -= dash;
  });

  const legend = document.getElementById("donut-legend");
  if (legend) {
    legend.innerHTML = "";
    segments.forEach((s, i) => {
      const li = document.createElement("div");
      li.className = "legend-item";
      li.style.cssText = "display:flex;align-items:center;gap:8px;padding:2px 4px;border-radius:6px;cursor:pointer";
      li.innerHTML = `
        <span class="legend-dot" style="background:${COLORS[i % COLORS.length]};width:10px;height:10px;border-radius:999px;display:inline-block"></span>
        <span class="legend-text" style="font-size:13px;color:#374151">${s.label || "—"}: <b>${s.value || 0}</b></span>
      `;
      li.addEventListener("click", () => goToSeg(s.slug || ""));
      legend.appendChild(li);
    });
  }
})();

/* ===== Stulpelių panelė (horizontali, su checkbox) ===== */
(function() {
  const STORAGE_KEY = "uzklausos_cols_v1";
  const wrap  = document.getElementById("cols-config");
  if (!wrap) return;
  const btn   = document.getElementById("cols-toggle");
  const panel = document.getElementById("cols-panel");
  if (!btn || !panel) return;

  btn.addEventListener("click", (e)=>{
    e.preventDefault();
    panel.classList.toggle("show");
  });
  document.addEventListener("click", (ev)=>{
    if (!wrap.contains(ev.target)) panel.classList.remove("show");
  });

  const checks = panel.querySelectorAll('input[type="checkbox"][data-col]');
  const allCells = document.querySelectorAll('th[data-col], td[data-col]');

  function loadPrefs() {
    try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; }
  }
  function savePrefs(map) { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(map)); } catch {} }
  function currentMap() { const m = {}; checks.forEach(ch => m[ch.dataset.col] = ch.checked); return m; }
  function apply(map) {
    allCells.forEach(el => {
      const key = el.dataset.col;
      el.style.display = (map[key] !== false) ? "" : "none";
    });
  }

  const saved = loadPrefs();
  if (saved) {
    checks.forEach(ch => { if (saved.hasOwnProperty(ch.dataset.col)) ch.checked = !!saved[ch.dataset.col]; });
    apply(saved);
  } else {
    apply(currentMap());
  }

  checks.forEach(ch => ch.addEventListener("change", () => {
    const m = currentMap(); savePrefs(m); apply(m);
  }));
})();

</script>
{% endblock %}
