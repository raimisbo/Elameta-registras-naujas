{% extends "base.html" %}
{% block title %}DetaliÅ³ registras{% endblock %}

{% block content %}
<style>
  /* â€”â€”â€” Tik Å¡iam puslapiui â€”â€”â€” */

  /* Horizontalus scroll â€“ tik lentelei */
  .uzklausos-page .table-wrap{
    overflow-x:auto;
    overflow-y:visible !important; /* vertikaliai â€“ body */
    position:relative;
  }

  /* LentelÄ— pleÄiasi pagal turinÄ¯ (ne â€suspaudÅ¾iamaâ€œ) */
  .uzklausos-page #results-table{
    width:auto;
    min-width:max-content;
    table-layout:fixed;
    border-collapse:separate;
    border-spacing:0;
    background:#fff;
  }

  .uzklausos-page #results-table tbody td{
    border-bottom:1px solid #ececec;
    text-align:center;
    overflow-wrap:anywhere;
    line-height:1.3;
    padding:8px 10px;
  }
  .uzklausos-page #results-table tbody tr:nth-child(even) td{ background:#f7f7f7; }
  .uzklausos-page #results-table tbody tr:hover td{ background:#f0f0f0; }

  /* âœ… VISOS Å¾emiau esanÄios min-plotis taisyklÄ—s galioja TIK lentelÄ—s viduje,
     kad nebeiÅ¡pÅ«stÅ³ â€Stulpeliaiâ€œ checkbox meniu (inputs taip pat turi data-col). */
  .uzklausos-page #results-table [data-col="id"]{min-width:70px}
  .uzklausos-page #results-table [data-col="klientas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="projektas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="detale"]{min-width:160px}
  .uzklausos-page #results-table [data-col="brezinys"]{min-width:140px;font-family:ui-monospace,Menlo,monospace}
  .uzklausos-page #results-table [data-col="metalas"]{min-width:120px}
  .uzklausos-page #results-table [data-col="padengimas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="specifikacija"]{min-width:200px}
  .uzklausos-page #results-table [data-col="dangos"]{min-width:200px}
  .uzklausos-page #results-table [data-col="kiekiai"]{min-width:110px}
  .uzklausos-page #results-table [data-col="matmenys"]{min-width:140px}
  .uzklausos-page #results-table [data-col="kabinimas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="pakuote"]{min-width:140px}
  .uzklausos-page #results-table [data-col="kokybe"]{min-width:200px}
  .uzklausos-page #results-table [data-col="dok"]{min-width:220px}
  .uzklausos-page #results-table [data-col="sukurta"]{min-width:120px}
  .uzklausos-page #results-table [data-col="veiksmai"]{min-width:140px;text-align:right;white-space:nowrap}

  /* Inkaras â€“ kad neuÅ¾lÄ¯stÅ³ po sticky/klonuotu headeriu */
  #results-top{ scroll-margin-top: calc(var(--app-header-offset,0px) + 8px); }

  /* Klonuotas (fixed) header â€“ sinch su H-scroll */
  .sticky-table-header{
    position:fixed; z-index:1000; top:0; left:0; width:0;  /* top/left/width nustatys JS */
    pointer-events:none; background:#fff; border-bottom:1px solid #e5e7eb;
  }
  .sticky-table-header .hdr-clip{ overflow:hidden; width:100%; }
  .sticky-table-header .hdr-inner{ will-change: transform; }
  .sticky-table-header table{
    border-collapse:separate; border-spacing:0;
    table-layout:fixed; width:auto; min-width:max-content; background:#fff;
  }
  .sticky-table-header th{ font-weight:600; white-space:nowrap; background:#fff; }

  /* NarÅ¡yklinis sticky OFF â€“ klonas valdo */
  .uzklausos-page #results-table thead th{ position:static !important; top:auto !important; box-shadow:none !important; }
  /* Rodant klonÄ… â€“ tikras THEAD paslepiamas vizualiai (aukÅ¡tis lieka) */
  .uzklausos-page #results-table.thead-hidden thead{ visibility:hidden; }
</style>

<div class="container uzklausos-page">

  <header class="list-header" style="display:flex;align-items:center;gap:16px;justify-content:space-between;margin:16px 0 12px">
    <h1 style="margin:0">DetaliÅ³ registras</h1>

    <!-- Donut -->
    <div id="donut" class="donut" data-total="{{ chart_total|default:0 }}" style="position:relative;display:flex;align-items:center;gap:14px">
      <svg viewBox="0 0 120 120" class="donut-svg" aria-hidden="true" style="width:120px;height:120px;display:block">
        <circle cx="60" cy="60" r="54" style="fill:none;stroke:#e5e7eb;stroke-width:12;stroke-linecap:round"/>
        <g class="segments"></g>
      </svg>
      <div class="donut-center" style="position:absolute;left:0;top:0;width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none">
        <div class="donut-total" style="font-size:22px;font-weight:700;line-height:1">{{ chart_total|default:0 }}</div>
        <div class="donut-label" style="font-size:12px;color:#6b7280">Ä¯raÅ¡Å³</div>
      </div>
      <div id="donut-legend" style="display:flex;flex-direction:column;gap:4px;min-width:160px"></div>
    </div>
    {{ chart_segments|json_script:"segments-data" }}
  </header>

  <!-- StulpeliÅ³ konfigÅ«racija -->
  <div id="cols-config" style="display:flex;align-items:center;gap:12px;margin:8px 0 10px; position:relative;">
    <button type="button" class="btn" id="cols-toggle">âš™ï¸ Stulpeliai</button>
    <div id="cols-panel"
         style="display:none;gap:12px;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;background:#fff">
      <label><input type="checkbox" data-col="id" checked> ID</label>
      <label><input type="checkbox" data-col="klientas" checked> Klientas</label>
      <label><input type="checkbox" data-col="projektas" checked> Projektas</label>
      <label><input type="checkbox" data-col="detale" checked> DetalÄ—</label>
      <label><input type="checkbox" data-col="brezinys" checked> BrÄ—Å¾inio nr.</label>
      <label><input type="checkbox" data-col="metalas" checked> Metalas</label>
      <label><input type="checkbox" data-col="padengimas" checked> KTL/Milt.</label>
      <label><input type="checkbox" data-col="specifikacija" checked> Specifikacija</label>
      <label><input type="checkbox" data-col="dangos" checked> PavirÅ¡iÅ³ dangos</label>
      <label><input type="checkbox" data-col="kiekiai" checked> Kiekiai</label>
      <label><input type="checkbox" data-col="matmenys" checked> Matmenys</label>
      <label><input type="checkbox" data-col="kabinimas" checked> Kabinimas</label>
      <label><input type="checkbox" data-col="pakuote" checked> PakuotÄ—</label>
      <label><input type="checkbox" data-col="kokybe" checked> Testai/KokybÄ—</label>
      <label><input type="checkbox" data-col="dok" checked> Dokumentai/Pastabos</label>
      <label><input type="checkbox" data-col="sukurta" checked> Sukurta</label>
      <label><input type="checkbox" data-col="veiksmai" checked> Veiksmai</label>
      <span style="flex:1"></span>
      <button type="button" class="btn btn-secondary" id="cols-reset">Atstatyti tvarkÄ…</button>
    </div>
  </div>

  <!-- Filtrai (palikta tik bendra paieÅ¡ka) -->
  <section class="filters-wrap" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px">
    <form method="get" class="filters-form" id="search-form" style="display:flex;gap:12px;align-items:center">
      <label class="f" style="flex:1;display:flex;flex-direction:column;gap:6px">
        <span>PaieÅ¡ka</span>
        {{ filter_form.q }}
      </label>
      <button class="btn" type="submit">IeÅ¡koti</button>
      {% if request.GET.q %}
        <a class="btn btn-secondary" id="clear-search" href="{% url 'detaliu_registras:uzklausa_list' %}">IÅ¡valyti</a>
      {% endif %}
    </form>
  </section>

  <!-- Inkaras prieÅ¡ lentelÄ™ -->
  <div id="results-top"></div>

  <!-- âœ… Fiksuotas klonuotas header -->
  <div id="table-sticky-header" class="sticky-table-header" style="display:none" aria-hidden="true">
    <div class="hdr-clip">
      <div class="hdr-inner">
        <table class="hdr-table">
          <colgroup class="hdr-colgroup"></colgroup>
          <thead><tr class="hdr-row"></tr></thead>
        </table>
      </div>
    </div>
  </div>

  <!-- LentelÄ— -->
  <section class="table-wrap" id="table-wrap">
    <table id="results-table" class="table">
      <colgroup id="results-colgroup">
        <col data-col="id"><col data-col="klientas"><col data-col="projektas"><col data-col="detale">
        <col data-col="brezinys"><col data-col="metalas"><col data-col="padengimas">
        <col data-col="specifikacija"><col data-col="dangos"><col data-col="kiekiai"><col data-col="matmenys">
        <col data-col="kabinimas"><col data-col="pakuote"><col data-col="kokybe"><col data-col="dok">
        <col data-col="sukurta"><col data-col="veiksmai">
      </colgroup>
      <thead>
        <tr>
          <th data-col="id">ID</th>
          <th data-col="klientas">Klientas</th>
          <th data-col="projektas">Projektas</th>
          <th data-col="detale">DetalÄ—</th>
          <th data-col="brezinys">BrÄ—Å¾inio nr.</th>
          <th data-col="metalas">Metalas</th>
          <th data-col="padengimas">KTL/Milt.</th>
          <th data-col="specifikacija">Specifikacija</th>
          <th data-col="dangos">PavirÅ¡iÅ³ dangos</th>
          <th data-col="kiekiai">Kiekiai</th>
          <th data-col="matmenys">Matmenys</th>
          <th data-col="kabinimas">Kabinimas</th>
          <th data-col="pakuote">PakuotÄ—</th>
          <th data-col="kokybe">Testai/KokybÄ—</th>
          <th data-col="dok">Dokumentai/Pastabos</th>
          <th data-col="sukurta">Sukurta</th>
          <th data-col="veiksmai" style="text-align:center">Veiksmai</th>
        </tr>
      </thead>
      <tbody id="results-tbody">
        {% for u in uzklausos %}
          <tr>
            <td data-col="id"><a href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">#{{ u.pk }}</a></td>
            <td data-col="klientas">{{ u.klientas|default:"â€”" }}</td>
            <td data-col="projektas">{{ u.projektas|default:"â€”" }}</td>
            <td data-col="detale">{{ u.detale.pavadinimas|default:"â€”" }}</td>
            <td data-col="brezinys">{{ u.detale.brezinio_nr|default:"â€”" }}</td>
            <td data-col="metalas">{% if u.detale.specifikacija %}{{ u.detale.specifikacija.metalas|default:"â€”" }}{% else %}â€”{% endif %}</td>
            <td data-col="padengimas">
              {% if u.detale.pavirsiu_dangos %}
                {{ u.detale.pavirsiu_dangos.ktl_ec_name|default_if_none:"" }}{% if u.detale.pavirsiu_dangos.ktl_ec_name and u.detale.pavirsiu_dangos.miltelinis_name %} / {% endif %}{{ u.detale.pavirsiu_dangos.miltelinis_name|default_if_none:"" }}
              {% else %}â€”{% endif %}
            </td>
            <td data-col="specifikacija">
              {% if u.detale.specifikacija %}
                <div>{% if u.detale.specifikacija.metalas %}Metal.: {{ u.detale.specifikacija.metalas }}{% endif %}</div>
                <div>{% if u.detale.specifikacija.storis %}Storis: {{ u.detale.specifikacija.storis }}{% elif u.detale.specifikacija.storis_mm %}Storis: {{ u.detale.specifikacija.storis_mm }} mm{% endif %}</div>
                <div>{% if u.detale.specifikacija.spalva %}Spalva: {{ u.detale.specifikacija.spalva }}{% endif %}</div>
              {% else %}â€”{% endif %}
            </td>
            <td data-col="dangos">
              {% if u.detale.pavirsiu_dangos %}
                <div>{% if u.detale.pavirsiu_dangos.ktl_ec_name %}KTL/EC: {{ u.detale.pavirsiu_dangos.ktl_ec_name }}{% endif %}</div>
                <div>{% if u.detale.pavirsiu_dangos.miltelinis_name %}Milt.: {{ u.detale.pavirsiu_dangos.miltelinis_name }}{% endif %}</div>
                <div>{% if u.detale.pavirsiu_dangos.kiti %}Kita: {{ u.detale.pavirsiu_dangos.kiti }}{% endif %}</div>
              {% else %}â€”{% endif %}
            </td>
            <td data-col="kiekiai">{% if u.kiekis %}{{ u.kiekis }}{% elif u.detale.kiekis %}{{ u.detale.kiekis }}{% else %}â€”{% endif %}</td>
            <td data-col="matmenys">
              {% if u.detale and u.detale.specifikacija %}
                {% if u.detale.specifikacija.ilgis or u.detale.specifikacija.plotis or u.detale.specifikacija.aukstis %}
                  {{ u.detale.specifikacija.ilgis|default:"" }}Ã—{{ u.detale.specifikacija.plotis|default:"" }}Ã—{{ u.detale.specifikacija.aukstis|default:"" }}
                {% elif u.ilgis or u.plotis or u.aukstis %}
                  {{ u.ilgis|default:"" }}Ã—{{ u.plotis|default:"" }}Ã—{{ u.aukstis|default:"" }}
                {% else %}â€”{% endif %}
              {% else %}
                {% if u.ilgis or u.plotis or u.aukstis %}
                  {{ u.ilgis|default:"" }}Ã—{{ u.plotis|default:"" }}Ã—{{ u.aukstis|default:"" }}
                {% else %}â€”{% endif %}
              {% endif %}
            </td>
            <td data-col="kabinimas">{% if u.detale.kabinimas %}{{ u.detale.kabinimas }}{% elif u.kabinimas %}{{ u.kabinimas }}{% else %}â€”{% endif %}</td>
            <td data-col="pakuote">{% if u.detale.pakuote %}{{ u.detale.pakuote }}{% elif u.pakuote %}{{ u.pakuote }}{% else %}â€”{% endif %}</td>
            <td data-col="kokybe">{% if u.detale.testai %}{{ u.detale.testai }}{% elif u.testai %}{{ u.testai }}{% elif u.kokybe %}{{ u.kokybe }}{% else %}â€”{% endif %}</td>
            <td data-col="dok">
              {% with docs=u.detale.dokumentai.all %}
                {% if docs|length %}{% for d in docs|slice:":3" %}<div>{{ d }}</div>{% endfor %}{% endif %}
              {% endwith %}
              {% if u.pastabos %}<div>{{ u.pastabos }}</div>{% else %}{% with docs=u.detale.dokumentai.all %}{% if docs|length == 0 %}â€”{% endif %}{% endwith %}{% endif %}
            </td>
            <td data-col="sukurta">{{ u.data|date:"Y-m-d" }}</td>
            <td data-col="veiksmai" style="text-align:right">
              <a class="btn" href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">PerÅ¾iÅ«rÄ—ti</a>
              <a class="btn" href="{% url 'detaliu_registras:redaguoti_uzklausa' u.pk %}">Redaguoti</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="17" style="color:#6b7280;font-style:italic;text-align:center;padding:8px">Ä®raÅ¡Å³ nÄ—ra.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <div id="pagination-container">
    {% if is_paginated %}
      <nav class="pagination" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:12px 0 18px">
        {% if page_obj.has_previous %}
          <a class="page btn" href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">â€¹</a>
        {% else %}<span class="page btn" style="opacity:.5;pointer-events:none">â€¹</span>{% endif %}
        <span class="page" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;background:#f3f4f6">Puslapis {{ page_obj.number }} iÅ¡ {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="page btn" href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">â€º</a>
        {% else %}<span class="page btn" style="opacity:.5;pointer-events:none">â€º</span>{% endif %}
      </nav>
    {% endif %}
  </div>
</div>

<!-- Donut (refaktorinta Ä¯ funkcijÄ…, kad bÅ«tÅ³ galima perpieÅ¡ti po paieÅ¡kos) -->
<script>
function renderDonutFromDOM(){
  const donut=document.getElementById("donut");
  if(!donut) return;
  const segScript=document.getElementById("segments-data");
  let seg=[]; try{ seg=JSON.parse(segScript?.textContent||"[]"); }catch(_){ seg=[]; }
  const totalBox=donut.querySelector(".donut-total");
  const legend=document.getElementById("donut-legend");
  const segGroup=donut.querySelector(".segments");

  // iÅ¡valom ankstesnius segmentus
  segGroup.innerHTML = "";
  legend.innerHTML = "";

  const total = seg.reduce((a,b)=>a+(+b.value||0), 0) || parseInt(donut.dataset.total||"0",10);
  totalBox.textContent = total;

  if(!total || !seg.length){
    legend.innerHTML = '<div style="color:#6b7280">NÄ—ra duomenÅ³ grafikai.</div>';
    return;
  }
  const COLORS=["#2563EB","#10B981","#F59E0B","#EF4444","#8B5CF6","#06B6D4","#22C55E","#D946EF"];
  const r=54, C=2*Math.PI*r;
  let off=0;

  function go(slug){
    const u=new URL(location.href);
    const cur=u.searchParams.get("seg")||"";
    if(cur===slug) u.searchParams.delete("seg"); else u.searchParams.set("seg",slug);
    u.searchParams.delete("page"); u.hash="results-top";
    location.href=u.toString();
  }

  seg.forEach((s,i)=>{
    const v=+s.value||0; if(v<=0) return;
    const dash=Math.max(0.0001,(v/total)*C), gap=C-dash;
    const arc=document.createElementNS("http://www.w3.org/2000/svg","circle");
    arc.setAttribute("cx","60"); arc.setAttribute("cy","60"); arc.setAttribute("r","54");
    arc.setAttribute("fill","none"); arc.setAttribute("stroke-linecap","round"); arc.setAttribute("stroke-width","12");
    arc.setAttribute("stroke",COLORS[i%COLORS.length]);
    arc.setAttribute("stroke-dasharray",`${dash} ${gap}`); arc.setAttribute("stroke-dashoffset",String(off));
    arc.style.transform="rotate(-90deg)"; arc.style.transformOrigin="50% 50%"; arc.style.cursor="pointer";
    arc.addEventListener("click",()=>go(s.slug||""));
    segGroup.appendChild(arc);
    off-=dash;
  });

  seg.forEach((s,i)=>{
    const div=document.createElement("div");
    div.style.cssText="display:flex;align-items:center;gap:8px;padding:2px 4px;border-radius:6px;cursor:pointer";
    div.innerHTML=`<span style="width:10px;height:10px;border-radius:999px;display:inline-block;background:${COLORS[i%COLORS.length]}"></span>
                   <span style="font-size:13px;color:#374151">${s.label||"â€”"}: <b>${s.value||0}</b></span>`;
    div.addEventListener("click",()=>go(s.slug||""));
    legend.appendChild(div);
  });
}

// pirmas pieÅ¡imas
renderDonutFromDOM();
</script>

<!-- StulpeliÅ³ rodyti/slÄ—pti (+ reset) â€“ be pakeitimÅ³ elgsenai -->
<script>
(function(){
  const WRAP=document.getElementById("cols-config");
  const TABLE=document.getElementById("results-table");
  const CG=document.getElementById("results-colgroup");
  if(!WRAP||!TABLE||!CG) return;

  const BTN=WRAP.querySelector("#cols-toggle");
  const PANEL=WRAP.querySelector("#cols-panel");
  const RESET=WRAP.querySelector("#cols-reset");
  const KEY=`uzklausos_cols:${TABLE.id||'results-table'}:${location.pathname}`;

  BTN.addEventListener("click",(e)=>{e.preventDefault(); PANEL.style.display=PANEL.style.display==="none"?"flex":"none";});

  function mapFromUI(){
    const m={}; PANEL.querySelectorAll('input[type="checkbox"][data-col]').forEach(ch=> m[ch.dataset.col]=!!ch.checked );
    return m;
  }
  function apply(map){
    Object.keys(map).forEach(k=>{
      const show=!!map[k];
      TABLE.querySelectorAll(`[data-col="${k}"]`).forEach(el=>{
        if(el.tagName==='TH'||el.tagName==='TD'){ el.style.display=show?"":"none"; }
      });
      const col=CG.querySelector(`col[data-col="${k}"]`);
      if(col){ if(show){ col.style.width=col.dataset.width||""; }else{ if(!col.dataset.width) col.dataset.width=col.style.width||""; col.style.width="0px"; } }
    });
    window.dispatchEvent(new Event('table:cols-changed'));
  }
  function load(){ try{return JSON.parse(localStorage.getItem(KEY)||'null');}catch(_){return null;} }
  function save(m){ try{ localStorage.setItem(KEY, JSON.stringify(m)); }catch(_){} }

  PANEL.addEventListener('change',()=>{ const m=mapFromUI(); save(m); apply(m); });

  RESET.addEventListener('click',(e)=>{
    e.preventDefault();
    const base = `${TABLE.id || 'results-table'}:${location.pathname}`;
    localStorage.removeItem(`uzklausos_cols:${base}`);
    localStorage.removeItem(`uzklausos_cols_v3:${base}`);
    localStorage.removeItem(`colOrder:${base}`);
    localStorage.removeItem(`colOrder_v2:${base}`);
    location.reload();
  });

  const saved=load();
  if(saved){ PANEL.querySelectorAll('input[data-col]').forEach(ch=>{ if(saved.hasOwnProperty(ch.dataset.col)) ch.checked=!!saved[ch.dataset.col]; }); apply(saved); }
  else { const init=mapFromUI(); save(init); apply(init); }

  const f=document.getElementById('search-form');
  if(f){ f.addEventListener('submit',(e)=>{ e.preventDefault(); /* submit nenaudojam â€“ turim live paieÅ¡kÄ… */ }); }
})();
</script>

{% include "snippets/columns_dnd.html" %}

<!-- Klonuoto (fixed) headerio logika â€“ lygiavimas ir H-scroll sinchas -->
<script>
(function(){
  const wrap   = document.getElementById('table-wrap');      // H-scroll viewport
  const table  = document.getElementById('results-table');
  const thead  = table?.tHead;
  const sticky = document.getElementById('table-sticky-header');
  if(!wrap || !table || !thead || !sticky) return;

  const inner  = sticky.querySelector('.hdr-inner');
  const hdrCG  = sticky.querySelector('.hdr-colgroup');
  const hdrRow = sticky.querySelector('.hdr-row');

  const px = n => Math.max(0, Math.round(n)) + 'px';
  function appOffsetPx(){
    const h=document.querySelector('header.site'); if(!h) return 0;
    const cs=getComputedStyle(h);
    const overlay=(cs.position==='sticky'||cs.position==='fixed') && h.getBoundingClientRect().top<=0;
    return overlay ? Math.ceil(h.getBoundingClientRect().height) : 0;
  }
  function visibleHeaders(){
    return Array.from(thead.rows[0].cells).filter(th => th.offsetParent !== null);
  }

  function rebuild(){
    hdrCG.innerHTML=''; hdrRow.innerHTML='';
    const ths = visibleHeaders(); if(!ths.length) return;

    ths.forEach(th=>{
      const rect=th.getBoundingClientRect();
      const col=document.createElement('col'); col.style.width=px(rect.width); hdrCG.appendChild(col);

      const c=document.createElement('th');
      c.textContent=th.textContent.trim();
      const cs=getComputedStyle(th);
      c.style.paddingLeft=cs.paddingLeft; c.style.paddingRight=cs.paddingRight;
      c.style.textAlign=cs.textAlign; c.style.font=cs.font; c.style.letterSpacing=cs.letterSpacing; c.style.whiteSpace=cs.whiteSpace;
      hdrRow.appendChild(c);
    });
  }

  function syncX(){ inner.style.transform = `translateX(${-wrap.scrollLeft}px)`; }

  function placeAndToggle(){
    const rect=table.getBoundingClientRect();
    const headH=thead.getBoundingClientRect().height||0;
    const topOff=appOffsetPx();
    const wrect=wrap.getBoundingClientRect();
    const show = rect.top<=topOff && (rect.bottom - headH) > topOff;

    sticky.style.top   = px(topOff);
    sticky.style.left  = px(wrect.left);
    sticky.style.width = px(wrect.width);
    sticky.style.display = show ? 'block' : 'none';
    table.classList.toggle('thead-hidden', show);
  }

  wrap.addEventListener('scroll', syncX, {passive:true});
  window.addEventListener('scroll', placeAndToggle, {passive:true});
  window.addEventListener('resize', ()=>{ rebuild(); syncX(); placeAndToggle(); });
  window.addEventListener('table:cols-changed', ()=>{ rebuild(); syncX(); placeAndToggle(); });
  window.addEventListener('table:order-changed', ()=>{ rebuild(); syncX(); placeAndToggle(); });

  const init=()=>{ rebuild(); syncX(); placeAndToggle(); };
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', init); } else { init(); }
  window.addEventListener('load', init);
})();
</script>

<!-- ğŸ” Gyva paieÅ¡ka: â€raÅ¡antâ€œ filtruojam per XHR (be backend pakeitimÅ³) -->
<script>
(function(){
  const form = document.getElementById('search-form');
  const input = form ? form.querySelector('input[name="q"], #id_q') : null;
  const tbody = document.getElementById('results-tbody');
  const paginationBox = document.getElementById('pagination-container');

  if (!input || !tbody) return;

  // iÅ¡jungiam default submit â€“ naudosim live paieÅ¡kÄ…
  form.addEventListener('submit', (e)=> e.preventDefault());

  // helper: 250ms debounce
  let t = null, ctrl = null;
  function debounce(fn, ms){ return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), ms); }; }

  async function runSearch(){
    const url = new URL(window.location.href);
    const q = (input.value || "").trim();
    if (q) url.searchParams.set('q', q); else url.searchParams.delete('q');
    url.searchParams.delete('page'); // nuo pradÅ¾ios

    // abortinam ankstesnÄ¯ requestÄ…
    if (ctrl) ctrl.abort();
    ctrl = new AbortController();

    try{
      const resp = await fetch(url.toString(), { signal: ctrl.signal });
      if (!resp.ok) return;
      const html = await resp.text();

      // parsavimas Ä¯ DOM
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // pakeiÄiam TBODY
      const newBody = doc.querySelector('#results-tbody');
      if (newBody) tbody.innerHTML = newBody.innerHTML;

      // pakeiÄiam paginacijÄ… (visa dÄ—Å¾utÄ—)
      const newPag = doc.querySelector('#pagination-container');
      if (newPag && paginationBox) paginationBox.innerHTML = newPag.innerHTML;

      // atnaujinam donut data script + total ir perpieÅ¡iam
      const curSeg = document.getElementById('segments-data');
      const newSeg = doc.getElementById('segments-data');
      if (curSeg && newSeg) curSeg.textContent = newSeg.textContent;

      const donut = document.getElementById('donut');
      const newDonut = doc.getElementById('donut');
      if (donut && newDonut){
        donut.dataset.total = newDonut.dataset.total || "0";
      }
      renderDonutFromDOM();

      // atnaujink URL be perkrovimo
      history.replaceState({}, "", url.toString());
    }catch(err){
      if (err.name !== "AbortError") console.error(err);
    }
  }

  const onType = debounce(runSearch, 250);
  input.addEventListener('input', onType);

  // ESC â€“ greitam iÅ¡valymui
  input.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape'){
      input.value = '';
      onType();
    }
  });

  // â€IÅ¡valytiâ€œ mygtuko perÄ—mimas (kad per live veikimÄ… neiÅ¡Å¡autÅ³ pilnas reload)
  const clearBtn = document.getElementById('clear-search');
  if (clearBtn){
    clearBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      input.value = '';
      onType();
    });
  }
})();
</script>
{% endblock %}
