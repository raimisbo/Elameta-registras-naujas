{% extends "base.html" %}

{% block title %}Užklausos{% endblock %}

{% block content %}

<style>
  /* ===== LENTELĖS SKAITYMUMO + LYGIAVIMO TUNINGAS ===== */
  /* Leisti kelių eilučių tekstą, gražiai laužyti žodžius */
  #results-table th,
  #results-table td{
    white-space: normal;
    word-break: break-word;
    hyphens: auto;
    line-height: 1.25;
    padding: 8px 10px;
  }

  /* Centruojam visų stulpelių antraštes ir turinį pagal nutylėjimą */
  #results-table thead th{
    text-align: center;
    font-weight: 600;
    border-bottom: 1px solid #e5e7eb;
  }
  #results-table tbody td{
    text-align: center;
    border-bottom: 1px solid #ececec;
  }

  /* Zebra + hover */
  #results-table tbody tr:nth-child(even) td{ background-color: #f7f7f7; }
  #results-table tbody tr:hover td{ background-color: #f0f0f0; }

  /* ===== MINIMALŪS PLOČIAI ===== */
  #results-table [data-col="id"]        { min-width: 84px;  }
  #results-table [data-col="klientas"]  { min-width: 180px; }
  #results-table [data-col="projektas"] { min-width: 180px; }
  #results-table [data-col="detale"]    { min-width: 200px; }
  #results-table [data-col="brezinys"]  { min-width: 140px; font-family: ui-monospace, Menlo, monospace; }
  #results-table [data-col="metalas"]   { min-width: 140px; }
  #results-table [data-col="padengimas"]{ min-width: 160px; }

  #results-table [data-col="specifikacija"] { min-width: 220px; }
  #results-table [data-col="dangos"]        { min-width: 220px; }
  #results-table [data-col="kiekiai"]       { min-width: 120px; } /* buvę right – dabar center */
  #results-table [data-col="matmenys"]      { min-width: 160px; }
  #results-table [data-col="kabinimas"]     { min-width: 160px; }
  #results-table [data-col="pakuote"]       { min-width: 160px; }
  #results-table [data-col="kokybe"]        { min-width: 200px; }
  #results-table [data-col="dok"]           { min-width: 240px; }

  #results-table [data-col="sukurta"]  { min-width: 120px; }
  #results-table [data-col="veiksmai"] { min-width: 140px; text-align: right; white-space: nowrap; }

  /* Tekstiniai stulpeliai skaitomumui paliekami KAIRĖJE (override) */
  #results-table [data-col="klientas"],
  #results-table [data-col="projektas"],
  #results-table [data-col="detale"],
  #results-table [data-col="specifikacija"],
  #results-table [data-col="dangos"],
  #results-table [data-col="pakuote"],
  #results-table [data-col="kokybe"],
  #results-table [data-col="dok"]{
    text-align: left;
  }

  /* Neplėsti „Veiksmų“ mygtukų */
  #results-table [data-col="veiksmai"] .btn{
    display: inline-block;
    /* neredaguojam padding/font-size – išlieka kaip pas tave projekte */
  }

  /* Slenkantis konteineris jau yra .table-wrap */
  .table-wrap{ will-change: transform; }
</style>


<div class="container">

  <!-- Antraštė + donut -->
  <header class="list-header" style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin:16px 0 12px;">
    <h1 style="margin:0">Užklausos</h1>

    <div class="donut" id="donut" data-total="{{ chart_total|default:0 }}" style="position:relative;display:flex;align-items:center;gap:14px;">
      <svg viewBox="0 0 120 120" class="donut-svg" aria-hidden="true" style="width:120px;height:120px;display:block">
        <circle class="ring-bg" cx="60" cy="60" r="54"
                style="fill:none;stroke:#e5e7eb;stroke-width:12;stroke-linecap:round;" />
        <g class="segments"></g>
      </svg>

      <div class="donut-center" style="position:absolute;left:0;top:0;width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;">
        <div class="donut-total" style="font-size:22px;font-weight:700;line-height:1">{{ chart_total|default:0 }}</div>
        <div class="donut-label" style="font-size:12px;color:#6b7280">įrašų</div>
      </div>

      <div class="donut-legend" id="donut-legend" style="display:flex;flex-direction:column;gap:4px;min-width:160px"></div>
    </div>
    {{ chart_segments|json_script:"segments-data" }}
  </header>

  <!-- Stulpelių konfigūracija -->
  <div class="cols-config" id="cols-config" style="display:flex;align-items:center;gap:12px;margin:8px 0 10px">
    <button type="button" class="btn" id="cols-toggle">⚙️ Stulpeliai</button>
    <div class="cols-panel" id="cols-panel"
         style="display:none;gap:12px;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;background:#fff">
      <label><input type="checkbox" data-col="id" checked> ID</label>
      <label><input type="checkbox" data-col="klientas" checked> Klientas</label>
      <label><input type="checkbox" data-col="projektas" checked> Projektas</label>
      <label><input type="checkbox" data-col="detale" checked> Detalė</label>
      <label><input type="checkbox" data-col="brezinys" checked> Brėžinio nr.</label>
      <label><input type="checkbox" data-col="metalas" checked> Metalas</label>
      <label><input type="checkbox" data-col="padengimas" checked> KTL/Milt.</label>

      <!-- NAUJI stulpeliai -->
      <label><input type="checkbox" data-col="specifikacija" checked> Specifikacija</label>
      <label><input type="checkbox" data-col="dangos" checked> Paviršių dangos</label>
      <label><input type="checkbox" data-col="kiekiai" checked> Kiekiai</label>
      <label><input type="checkbox" data-col="matmenys" checked> Matmenys</label>
      <label><input type="checkbox" data-col="kabinimas" checked> Kabinimas</label>
      <label><input type="checkbox" data-col="pakuote" checked> Pakuotė</label>
      <label><input type="checkbox" data-col="kokybe" checked> Testai/Kokybė</label>
      <label><input type="checkbox" data-col="dok" checked> Dokumentai/Pastabos</label>
      <!-- /NAUJI -->

      <label><input type="checkbox" data-col="sukurta" checked> Sukurta</label>
      <label><input type="checkbox" data-col="veiksmai" checked> Veiksmai</label>
    </div>
  </div>

  <!-- Filtrai -->
  <section class="filters-wrap" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px">
    <form method="get" class="filters-form" style="display:flex;flex-direction:column;gap:12px">
      <div class="filters-grid" style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px">
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Paieška</span>{{ filter_form.q }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Klientas</span>{{ filter_form.klientas }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Projektas</span>{{ filter_form.projektas }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Detalė</span>{{ filter_form.detale }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Brėžinio nr.</span>{{ filter_form.brezinio_nr }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Metalas</span>{{ filter_form.metalas }}</label>
        <label class="f" style="display:flex;flex-direction:column;gap:4px"><span>Padengimas</span>{{ filter_form.padengimas }}</label>
      </div>
      <div class="filters-actions" style="display:flex;align-items:center;gap:8px">
        <a class="btn" href="{% url 'detaliu_registras:ivesti_uzklausa' %}">+ Nauja užklausa</a>
        <span style="flex:1"></span>
        <button class="btn" type="submit">Filtruoti</button>
        <a class="btn" href="{% url 'detaliu_registras:uzklausa_list' %}">Išvalyti</a>
      </div>
    </form>
  </section>

  <!-- Lentelė -->
  <section class="table-wrap" style="overflow-x:auto">
    <table id="results-table" class="table js-fixed-head" style="width:100%;border-collapse:collapse;table-layout:fixed">
      <thead>
        <tr>
          <th data-col="id">ID</th>
          <th data-col="klientas">Klientas</th>
          <th data-col="projektas">Projektas</th>
          <th data-col="detale">Detalė</th>
          <th data-col="brezinys">Brėžinio nr.</th>
          <th data-col="metalas">Metalas</th>
          <th data-col="padengimas">KTL/Milt.</th>

          <!-- NAUJI stulpeliai -->
          <th data-col="specifikacija">Specifikacija</th>
          <th data-col="dangos">Paviršių dangos</th>
          <th data-col="kiekiai">Kiekiai</th>
          <th data-col="matmenys">Matmenys</th>
          <th data-col="kabinimas">Kabinimas</th>
          <th data-col="pakuote">Pakuotė</th>
          <th data-col="kokybe">Testai/Kokybė</th>
          <th data-col="dok">Dokumentai/Pastabos</th>
          <!-- /NAUJI -->

          <th data-col="sukurta">Sukurta</th>
          <th data-col="veiksmai" style="text-align:right">Veiksmai</th>
        </tr>
      </thead>
      <tbody>
        {% for u in uzklausos %}
          <tr>
            <td data-col="id"><a href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">#{{ u.pk }}</a></td>
            <td data-col="klientas">{{ u.klientas|default:"—" }}</td>
            <td data-col="projektas">{{ u.projektas|default:"—" }}</td>
            <td data-col="detale">{{ u.detale.pavadinimas|default:"—" }}</td>
            <td data-col="brezinys" style="font-family:ui-monospace,Menlo,monospace">{{ u.detale.brezinio_nr|default:"—" }}</td>
            <td data-col="metalas">
              {% if u.detale.specifikacija %}{{ u.detale.specifikacija.metalas|default:"—" }}{% else %}—{% endif %}
            </td>
            <td data-col="padengimas">
              {% if u.detale.pavirsiu_dangos %}
                {{ u.detale.pavirsiu_dangos.ktl_ec_name|default_if_none:"" }}{% if u.detale.pavirsiu_dangos.ktl_ec_name and u.detale.pavirsiu_dangos.miltelinis_name %} / {% endif %}{{ u.detale.pavirsiu_dangos.miltelinis_name|default_if_none:"" }}
              {% else %}—{% endif %}
            </td>

            <!-- NAUJI stulpeliai (be skliaustų if sąlygose) -->
            <td data-col="specifikacija">
              {% if u.detale.specifikacija %}
                <div>{% if u.detale.specifikacija.metalas %}Metal.: {{ u.detale.specifikacija.metalas }}{% endif %}</div>
                <div>
                  {% if u.detale.specifikacija.storis %}Storis: {{ u.detale.specifikacija.storis }}
                  {% elif u.detale.specifikacija.storis_mm %}Storis: {{ u.detale.specifikacija.storis_mm }} mm{% endif %}
                </div>
                <div>{% if u.detale.specifikacija.spalva %}Spalva: {{ u.detale.specifikacija.spalva }}{% endif %}</div>
              {% else %}—{% endif %}
            </td>

            <td data-col="dangos">
              {% if u.detale.pavirsiu_dangos %}
                <div>{% if u.detale.pavirsiu_dangos.ktl_ec_name %}KTL/EC: {{ u.detale.pavirsiu_dangos.ktl_ec_name }}{% endif %}</div>
                <div>{% if u.detale.pavirsiu_dangos.miltelinis_name %}Milt.: {{ u.detale.pavirsiu_dangos.miltelinis_name }}{% endif %}</div>
                <div>{% if u.detale.pavirsiu_dangos.kiti %}Kita: {{ u.detale.pavirsiu_dangos.kiti }}{% endif %}</div>
              {% else %}—{% endif %}
            </td>

            <td data-col="kiekiai">
              {% if u.kiekis %}{{ u.kiekis }}
              {% elif u.detale.kiekis %}{{ u.detale.kiekis }}
              {% else %}—{% endif %}
            </td>

            <td data-col="matmenys">
              {% if u.detale and u.detale.specifikacija %}
                {% if u.detale.specifikacija.ilgis or u.detale.specifikacija.plotis or u.detale.specifikacija.aukstis %}
                  {{ u.detale.specifikacija.ilgis|default:"" }}×{{ u.detale.specifikacija.plotis|default:"" }}×{{ u.detale.specifikacija.aukstis|default:"" }}
                {% elif u.ilgis or u.plotis or u.aukstis %}
                  {{ u.ilgis|default:"" }}×{{ u.plotis|default:"" }}×{{ u.aukstis|default:"" }}
                {% else %}—{% endif %}
              {% else %}
                {% if u.ilgis or u.plotis or u.aukstis %}
                  {{ u.ilgis|default:"" }}×{{ u.plotis|default:"" }}×{{ u.aukstis|default:"" }}
                {% else %}—{% endif %}
              {% endif %}
            </td>

            <td data-col="kabinimas">
              {% if u.detale.kabinimas %}{{ u.detale.kabinimas }}
              {% elif u.kabinimas %}{{ u.kabinimas }}
              {% else %}—{% endif %}
            </td>

            <td data-col="pakuote">
              {% if u.detale.pakuote %}{{ u.detale.pakuote }}
              {% elif u.pakuote %}{{ u.pakuote }}
              {% else %}—{% endif %}
            </td>

            <td data-col="kokybe">
              {% if u.detale.testai %}{{ u.detale.testai }}
              {% elif u.testai %}{{ u.testai }}
              {% elif u.kokybe %}{{ u.kokybe }}
              {% else %}—{% endif %}
            </td>

            <td data-col="dok">
              {# 1) Dokumentai — jei yra, parodyti iki 3 vnt. #}
              {% if u.detale and u.detale.dokumentai and u.detale.dokumentai.all %}
                {% for d in u.detale.dokumentai.all|slice:":3" %}
                  <div>{{ d }}</div>
                {% endfor %}
              {% endif %}
              {# 2) Pastabos — jei yra, parodyti #}
              {% if u.pastabos %}
                <div>{{ u.pastabos }}</div>
              {% else %}
                {# 3) Jei nėra nei pastabų, nei dokumentų — rodyti brūkšnį #}
                {% if u.detale and u.detale.dokumentai and u.detale.dokumentai.all %}
                  {# yra dokumentų, bet nėra pastabų — nieko papildomai #}
                {% else %}
                  —
                {% endif %}
              {% endif %}
            </td>
            <!-- /NAUJI -->

            <td data-col="sukurta">{{ u.data|date:"Y-m-d" }}</td>
            <td data-col="veiksmai" style="text-align:right">
              <a class="btn" href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">Peržiūrėti</a>
              <a class="btn btn-secondary" href="{% url 'detaliu_registras:redaguoti_uzklausa' u.pk %}">Redaguoti</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="17" style="color:#6b7280;font-style:italic;text-align:center;padding:8px">Įrašų nėra.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  {% if is_paginated %}
    <nav class="pagination" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:12px 0 18px">
      {% if page_obj.has_previous %}
        <a class="page btn btn-secondary" href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">‹</a>
      {% else %}<span class="page btn btn-secondary" style="opacity:.5;pointer-events:none">‹</span>{% endif %}
      <span class="page" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;background:#f3f4f6">Puslapis {{ page_obj.number }} iš {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="page btn btn-secondary" href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">›</a>
      {% else %}<span class="page btn btn-secondary" style="opacity:.5;pointer-events:none">›</span>{% endif %}
    </nav>
  {% endif %}
</div>

<script>
/* ===== Donut (palikta kaip buvo) ===== */
(function() {
  const donut = document.getElementById("donut");
  if (!donut) return;

  const total = parseInt(donut.dataset.total || "0", 10);
  const dataEl = document.getElementById("segments-data");
  let segments = [];
  try { segments = JSON.parse(dataEl?.textContent || "[]"); } catch(e) { segments = []; }

  const svg = donut.querySelector(".donut-svg");
  const g = svg.querySelector(".segments");
  const r = 54, C = 2 * Math.PI * r;
  const COLORS = ["#2563EB","#10B981","#F59E0B","#EF4444","#8B5CF6","#06B6D4","#22C55E","#D946EF"];

  function goToSeg(slug) {
    const url = new URL(window.location.href);
    const current = url.searchParams.get("seg") || "";
    if (current === slug) url.searchParams.delete("seg");
    else url.searchParams.set("seg", slug);
    window.location.href = url.toString();
  }

  if (!total || !segments || !segments.length) {
    const legend = document.getElementById("donut-legend");
    if (legend) legend.innerHTML = '<div style="color:#6b7280">Nėra duomenų grafikai.</div>';
    return;
  }

  let offset = 0;
  segments.forEach((s, i) => {
    const val = Number(s.value || 0);
    if (val <= 0) return;

    const dash = Math.max(0.0001, (val / total) * C);
    const gap  = C - dash;

    const arc = document.createElementNS("http://www.w3.org/2000/svg","circle");
    arc.setAttribute("cx","60"); arc.setAttribute("cy","60"); arc.setAttribute("r", String(r));
    arc.setAttribute("fill","none"); arc.setAttribute("stroke-linecap","round"); arc.setAttribute("stroke-width","12");
    arc.setAttribute("stroke", COLORS[i % COLORS.length]);
    arc.setAttribute("stroke-dasharray", `${dash} ${gap}`);
    arc.setAttribute("stroke-dashoffset", String(offset));
    arc.style.transform = "rotate(-90deg)"; arc.style.transformOrigin = "50% 50%";
    arc.style.cursor = "pointer";
    arc.addEventListener("click", () => goToSeg(s.slug || ""));
    g.appendChild(arc);

    offset -= dash;
  });

  const legend = document.getElementById("donut-legend");
  legend.innerHTML = "";
  segments.forEach((s, i) => {
    const li = document.createElement("div");
    li.className = "legend-item";
    li.style.cssText = "display:flex;align-items:center;gap:8px;padding:2px 4px;border-radius:6px;cursor:pointer";
    li.innerHTML = `
      <span class="legend-dot" style="width:10px;height:10px;border-radius:999px;display:inline-block;background:${COLORS[i % COLORS.length]}"></span>
      <span class="legend-text" style="font-size:13px;color:#374151">${s.label || "—"}: <b>${s.value || 0}</b></span>
    `;
    li.addEventListener("click", () => goToSeg(s.slug || ""));
    legend.appendChild(li);
  });
})();

/* ===== Stulpelių panelė → fiksuotam headeriui siunčiam „table:cols-changed“ ===== */
(function() {
  const STORAGE_KEY = "uzklausos_cols_v1";
  const PANEL_OPEN_KEY = "uzklausos_cols_panel_open";
  const TABLE_ID = "results-table";

  function init() {
    const wrap  = document.getElementById("cols-config");
    if (!wrap) return;

    const btn   = wrap.querySelector("#cols-toggle");
    const panel = wrap.querySelector("#cols-panel");
    if (!btn || !panel) return;

    const savedOpen = localStorage.getItem(PANEL_OPEN_KEY);
    const isOpen = savedOpen === "1";
    panel.style.display = isOpen ? "flex" : "none";

    btn.addEventListener("click", function(e){
      e.preventDefault();
      const nowOpen = panel.style.display === "none";
      panel.style.display = nowOpen ? "flex" : "none";
      try { localStorage.setItem(PANEL_OPEN_KEY, nowOpen ? "1" : "0"); } catch {}
    });

    const checks = panel.querySelectorAll('input[type="checkbox"][data-col]');
    const allCells = document.querySelectorAll('th[data-col], td[data-col]');

    function loadPrefs() {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch { return null; }
    }
    function savePrefs(map) { localStorage.setItem(STORAGE_KEY, JSON.stringify(map)); }
    function currentMap() { const m = {}; checks.forEach(ch => m[ch.dataset.col] = ch.checked); return m; }

    function apply(map) {
      allCells.forEach(el => {
        const key = el.dataset.col;
        el.style.display = (map[key] !== false) ? "" : "none";
      });
      // pranešam fiksuotam headeriui
      window.dispatchEvent(new CustomEvent('table:cols-changed', {
        detail: { tableId: TABLE_ID, map }
      }));
    }

    const saved = loadPrefs();
    if (saved) {
      checks.forEach(ch => { if (saved.hasOwnProperty(ch.dataset.col)) ch.checked = !!saved[ch.dataset.col]; });
      apply(saved);
    } else {
      const m = currentMap(); savePrefs(m); apply(m);
    }

    checks.forEach(ch => ch.addEventListener("change", () => {
      const m = currentMap(); savePrefs(m); apply(m);
    }));
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>

{% include "snippets/columns_dnd.html" %}

{% endblock %}
