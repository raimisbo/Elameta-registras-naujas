{% extends "base.html" %}
{% block title %}Užklausos{% endblock %}

{% block content %}

<style>
  /* Tik kas būtina šiam puslapiui */
  .uzklausos-page .filters-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
  .uzklausos-page #results-table{width:100%;table-layout:fixed;border-collapse:separate;border-spacing:0;background:#fff}
  .uzklausos-page #results-table tbody td{border-bottom:1px solid #ececec;text-align:center;overflow-wrap:anywhere;line-height:1.3;padding:8px 10px}
  .uzklausos-page #results-table tbody tr:nth-child(even) td{background:#f7f7f7}
  .uzklausos-page #results-table tbody tr:hover td{background:#f0f0f0}

  /* Tekstiniai – kairėn */
  .uzklausos-page #results-table [data-col="klientas"],
  .uzklausos-page #results-table [data-col="projektas"],
  .uzklausos-page #results-table [data-col="detale"],
  .uzklausos-page #results-table [data-col="specifikacija"],
  .uzklausos-page #results-table [data-col="dangos"],
  .uzklausos-page #results-table [data-col="pakuote"],
  .uzklausos-page #results-table [data-col="kokybe"],
  .uzklausos-page #results-table [data-col="dok"]{text-align:left}

  /* Min plotis */
  .uzklausos-page #results-table [data-col="id"]{min-width:84px}
  .uzklausos-page #results-table [data-col="klientas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="projektas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="detale"]{min-width:160px}
  .uzklausos-page #results-table [data-col="brezinys"]{min-width:140px;font-family:ui-monospace,Menlo,monospace}
  .uzklausos-page #results-table [data-col="metalas"]{min-width:120px}
  .uzklausos-page #results-table [data-col="padengimas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="specifikacija"]{min-width:160px}
  .uzklausos-page #results-table [data-col="dangos"]{min-width:160px}
  .uzklausos-page #results-table [data-col="kiekiai"]{min-width:110px}
  .uzklausos-page #results-table [data-col="matmenys"]{min-width:140px}
  .uzklausos-page #results-table [data-col="kabinimas"]{min-width:140px}
  .uzklausos-page #results-table [data-col="pakuote"]{min-width:140px}
  .uzklausos-page #results-table [data-col="kokybe"]{min-width:160px}
  .uzklausos-page #results-table [data-col="dok"]{min-width:200px}
  .uzklausos-page #results-table [data-col="sukurta"]{min-width:120px}
  .uzklausos-page #results-table [data-col="veiksmai"]{min-width:140px;text-align:right;white-space:nowrap}

  /* Inkaras: po filtravimo nelįsti po sticky */
  #results-top{scroll-margin-top:calc(var(--app-header-offset,0px) + 8px)}
</style>

<div class="container uzklausos-page">

  <header class="list-header" style="display:flex;align-items:center;gap:16px;justify-content:space-between;margin:16px 0 12px">
    <h1 style="margin:0">Užklausos</h1>

    <!-- Donut -->
    <div id="donut" class="donut" data-total="{{ chart_total|default:0 }}" style="position:relative;display:flex;align-items:center;gap:14px">
      <svg viewBox="0 0 120 120" class="donut-svg" aria-hidden="true" style="width:120px;height:120px;display:block">
        <circle cx="60" cy="60" r="54" style="fill:none;stroke:#e5e7eb;stroke-width:12;stroke-linecap:round"/>
        <g class="segments"></g>
      </svg>
      <div class="donut-center" style="position:absolute;left:0;top:0;width:120px;height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none">
        <div class="donut-total" style="font-size:22px;font-weight:700;line-height:1">{{ chart_total|default:0 }}</div>
        <div class="donut-label" style="font-size:12px;color:#6b7280">įrašų</div>
      </div>
      <div id="donut-legend" style="display:flex;flex-direction:column;gap:4px;min-width:160px"></div>
    </div>
    {{ chart_segments|json_script:"segments-data" }}
  </header>

  <!-- Stulpelių konfigūracija -->
  <div id="cols-config" style="display:flex;align-items:center;gap:12px;margin:8px 0 10px">
    <button type="button" class="btn" id="cols-toggle">⚙️ Stulpeliai</button>
    <div id="cols-panel" style="display:none;gap:12px;flex-wrap:wrap;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;background:#fff">
      <label><input type="checkbox" data-col="id" checked> ID</label>
      <label><input type="checkbox" data-col="klientas" checked> Klientas</label>
      <label><input type="checkbox" data-col="projektas" checked> Projektas</label>
      <label><input type="checkbox" data-col="detale" checked> Detalė</label>
      <label><input type="checkbox" data-col="brezinys" checked> Brėžinio nr.</label>
      <label><input type="checkbox" data-col="metalas" checked> Metalas</label>
      <label><input type="checkbox" data-col="padengimas" checked> KTL/Milt.</label>
      <label><input type="checkbox" data-col="specifikacija" checked> Specifikacija</label>
      <label><input type="checkbox" data-col="dangos" checked> Paviršių dangos</label>
      <label><input type="checkbox" data-col="kiekiai" checked> Kiekiai</label>
      <label><input type="checkbox" data-col="matmenys" checked> Matmenys</label>
      <label><input type="checkbox" data-col="kabinimas" checked> Kabinimas</label>
      <label><input type="checkbox" data-col="pakuote" checked> Pakuotė</label>
      <label><input type="checkbox" data-col="kokybe" checked> Testai/Kokybė</label>
      <label><input type="checkbox" data-col="dok" checked> Dokumentai/Pastabos</label>
      <label><input type="checkbox" data-col="sukurta" checked> Sukurta</label>
      <label><input type="checkbox" data-col="veiksmai" checked> Veiksmai</label>
      <span style="flex:1"></span>
      <button type="button" class="btn btn-secondary" id="cols-reset">Atstatyti tvarką</button>
    </div>
  </div>

  <!-- Filtrai -->
  <section class="filters-wrap" style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-bottom:12px">
    <form method="get" class="filters-form" style="display:flex;flex-direction:column;gap:12px">
      <div class="filters-grid">
        <label class="f"><span>Paieška</span>{{ filter_form.q }}</label>
        <label class="f"><span>Klientas</span>{{ filter_form.klientas }}</label>
        <label class="f"><span>Projektas</span>{{ filter_form.projektas }}</label>
        <label class="f"><span>Detalė</span>{{ filter_form.detale }}</label>
        <label class="f"><span>Brėžinio nr.</span>{{ filter_form.brezinio_nr }}</label>
        <label class="f"><span>Metalas</span>{{ filter_form.metalas }}</label>
        <label class="f"><span>Padengimas</span>{{ filter_form.padengimas }}</label>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <a class="btn" href="{% url 'detaliu_registras:ivesti_uzklausa' %}">+ Nauja užklausa</a>
        <span style="flex:1"></span>
        <button class="btn" type="submit">Filtruoti</button>
        <a class="btn" href="{% url 'detaliu_registras:uzklausa_list' %}">Išvalyti</a>
      </div>
    </form>
  </section>

  <!-- Inkaras prieš lentelę -->
  <div id="results-top"></div>

  <!-- Lentelė -->
  <section class="table-wrap">
    <table id="results-table" class="table">
      <colgroup id="results-colgroup">
        <col data-col="id"><col data-col="klientas"><col data-col="projektas"><col data-col="detale">
        <col data-col="brezinys"><col data-col="metalas"><col data-col="padengimas">
        <col data-col="specifikacija"><col data-col="dangos"><col data-col="kiekiai"><col data-col="matmenys">
        <col data-col="kabinimas"><col data-col="pakuote"><col data-col="kokybe"><col data-col="dok">
        <col data-col="sukurta"><col data-col="veiksmai">
      </colgroup>
      <thead>
        <tr>
          <th data-col="id">ID</th>
          <th data-col="klientas">Klientas</th>
          <th data-col="projektas">Projektas</th>
          <th data-col="detale">Detalė</th>
          <th data-col="brezinys">Brėžinio nr.</th>
          <th data-col="metalas">Metalas</th>
          <th data-col="padengimas">KTL/Milt.</th>
          <th data-col="specifikacija">Specifikacija</th>
          <th data-col="dangos">Paviršių dangos</th>
          <th data-col="kiekiai">Kiekiai</th>
          <th data-col="matmenys">Matmenys</th>
          <th data-col="kabinimas">Kabinimas</th>
          <th data-col="pakuote">Pakuotė</th>
          <th data-col="kokybe">Testai/Kokybė</th>
          <th data-col="dok">Dokumentai/Pastabos</th>
          <th data-col="sukurta">Sukurta</th>
          <th data-col="veiksmai" style="text-align:center">Veiksmai</th>
        </tr>
      </thead>
      <tbody>
        {% for u in uzklausos %}
          <tr>
            <td data-col="id"><a href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">#{{ u.pk }}</a></td>
            <td data-col="klientas">{{ u.klientas|default:"—" }}</td>
            <td data-col="projektas">{{ u.projektas|default:"—" }}</td>
            <td data-col="detale">{{ u.detale.pavadinimas|default:"—" }}</td>
            <td data-col="brezinys">{{ u.detale.brezinio_nr|default:"—" }}</td>
            <td data-col="metalas">{% if u.detale.specifikacija %}{{ u.detale.specifikacija.metalas|default:"—" }}{% else %}—{% endif %}</td>
            <td data-col="padengimas">
              {% if u.detale.pavirsiu_dangos %}
                {{ u.detale.pavirsiu_dangos.ktl_ec_name|default_if_none:"" }}{% if u.detale.pavirsiu_dangos.ktl_ec_name and u.detale.pavirsiu_dangos.miltelinis_name %} / {% endif %}{{ u.detale.pavirsiu_dangos.miltelinis_name|default_if_none:"" }}
              {% else %}—{% endif %}
            </td>
            <td data-col="specifikacija">
              {% if u.detale.specifikacija %}
                <div>{% if u.detale.specifikacija.metalas %}Metal.: {{ u.detale.specifikacija.metalas }}{% endif %}</div>
                <div>{% if u.detale.specifikacija.storis %}Storis: {{ u.detale.specifikacija.storis }}{% elif u.detale.specifikacija.storis_mm %}Storis: {{ u.detale.specifikacija.storis_mm }} mm{% endif %}</div>
                <div>{% if u.detale.specifikacija.spalva %}Spalva: {{ u.detale.specifikacija.spalva }}{% endif %}</div>
              {% else %}—{% endif %}
            </td>
            <td data-col="dangos">
              {% if u.detale.pavirsiu_dangos %}
                <div>{% if u.detale.pavirsiu_dangos.ktl_ec_name %}KTL/EC: {{ u.detale.pavirsiu_dangos.ktl_ec_name }}{% endif %}</div>
                <div>{% if u.detale.pavirsiu_dangos.miltelinis_name %}Milt.: {{ u.detale.pavirsiu_dangos.miltelinis_name }}{% endif %}</div>
                <div>{% if u.detale.pavirsiu_dangos.kiti %}Kita: {{ u.detale.pavirsiu_dangos.kiti }}{% endif %}</div>
              {% else %}—{% endif %}
            </td>
            <td data-col="kiekiai">{% if u.kiekis %}{{ u.kiekis }}{% elif u.detale.kiekis %}{{ u.detale.kiekis }}{% else %}—{% endif %}</td>
            <td data-col="matmenys">
              {% if u.detale and u.detale.specifikacija %}
                {% if u.detale.specifikacija.ilgis or u.detale.specifikacija.plotis or u.detale.specifikacija.aukstis %}
                  {{ u.detale.specifikacija.ilgis|default:"" }}×{{ u.detale.specifikacija.plotis|default:"" }}×{{ u.detale.specifikacija.aukstis|default:"" }}
                {% elif u.ilgis or u.plotis or u.aukstis %}
                  {{ u.ilgis|default:"" }}×{{ u.plotis|default:"" }}×{{ u.aukstis|default:"" }}
                {% else %}—{% endif %}
              {% else %}
                {% if u.ilgis or u.plotis or u.aukstis %}
                  {{ u.ilgis|default:"" }}×{{ u.plotis|default:"" }}×{{ u.aukstis|default:"" }}
                {% else %}—{% endif %}
              {% endif %}
            </td>
            <td data-col="kabinimas">{% if u.detale.kabinimas %}{{ u.detale.kabinimas }}{% elif u.kabinimas %}{{ u.kabinimas }}{% else %}—{% endif %}</td>
            <td data-col="pakuote">{% if u.detale.pakuote %}{{ u.detale.pakuote }}{% elif u.pakuote %}{{ u.pakuote }}{% else %}—{% endif %}</td>
            <td data-col="kokybe">{% if u.detale.testai %}{{ u.detale.testai }}{% elif u.testai %}{{ u.testai }}{% elif u.kokybe %}{{ u.kokybe }}{% else %}—{% endif %}</td>
            <td data-col="dok">
              {% with docs=u.detale.dokumentai.all %}
                {% if docs|length %}{% for d in docs|slice:":3" %}<div>{{ d }}</div>{% endfor %}{% endif %}
              {% endwith %}
              {% if u.pastabos %}<div>{{ u.pastabos }}</div>{% else %}{% with docs=u.detale.dokumentai.all %}{% if docs|length == 0 %}—{% endif %}{% endwith %}{% endif %}
            </td>
            <td data-col="sukurta">{{ u.data|date:"Y-m-d" }}</td>
            <td data-col="veiksmai" style="text-align:right">
              <a class="btn" href="{% url 'detaliu_registras:perziureti_uzklausa' u.pk %}">Peržiūrėti</a>
              <a class="btn" href="{% url 'detaliu_registras:redaguoti_uzklausa' u.pk %}">Redaguoti</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="17" style="color:#6b7280;font-style:italic;text-align:center;padding:8px">Įrašų nėra.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  {% if is_paginated %}
    <nav class="pagination" style="display:flex;gap:8px;align-items:center;justify-content:flex-end;margin:12px 0 18px">
      {% if page_obj.has_previous %}
        <a class="page btn" href="?page={{ page_obj.previous_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">‹</a>
      {% else %}<span class="page btn" style="opacity:.5;pointer-events:none">‹</span>{% endif %}
      <span class="page" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;background:#f3f4f6">Puslapis {{ page_obj.number }} iš {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="page btn" href="?page={{ page_obj.next_page_number }}{% if request.GET %}&{{ request.GET.urlencode|cut:'page='|cut:page_obj.number %}{% endif %}">›</a>
      {% else %}<span class="page btn" style="opacity:.5;pointer-events:none">›</span>{% endif %}
    </nav>
  {% endif %}
</div>

<!-- Donut: sugeneruoja segmentus ir filtruoja su ?seg=, meta į #results-top -->
<script>
(function(){
  const donut=document.getElementById("donut"); if(!donut) return;
  const total=parseInt(donut.dataset.total||"0",10);
  const dataEl=document.getElementById("segments-data");
  let seg=[]; try{ seg=JSON.parse(dataEl?.textContent||"[]"); }catch(_){ seg=[]; }
  if(!total||!seg.length){ const l=document.getElementById("donut-legend"); if(l) l.innerHTML='<div style="color:#6b7280">Nėra duomenų grafikai.</div>'; return; }

  const COLORS=["#2563EB","#10B981","#F59E0B","#EF4444","#8B5CF6","#06B6D4","#22C55E","#D946EF"];
  const g=donut.querySelector(".segments"), r=54, C=2*Math.PI*r;
  function go(slug){
    const u=new URL(location.href);
    const cur=u.searchParams.get("seg")||"";
    if(cur===slug) u.searchParams.delete("seg"); else u.searchParams.set("seg",slug);
    u.searchParams.delete("page"); u.hash="results-top";
    location.href=u.toString();
  }

  let off=0;
  seg.forEach((s,i)=>{
    const v=+s.value||0; if(v<=0) return;
    const dash=Math.max(0.0001,(v/total)*C), gap=C-dash;
    const arc=document.createElementNS("http://www.w3.org/2000/svg","circle");
    arc.setAttribute("cx","60");arc.setAttribute("cy","60");arc.setAttribute("r",String(r));
    arc.setAttribute("fill","none");arc.setAttribute("stroke-linecap","round");arc.setAttribute("stroke-width","12");
    arc.setAttribute("stroke",COLORS[i%COLORS.length]);
    arc.setAttribute("stroke-dasharray",`${dash} ${gap}`); arc.setAttribute("stroke-dashoffset",String(off));
    arc.style.transform="rotate(-90deg)"; arc.style.transformOrigin="50% 50%"; arc.style.cursor="pointer";
    arc.addEventListener("click",()=>go(s.slug||"")); g.appendChild(arc); off-=dash;
  });

  const legend=document.getElementById("donut-legend"); legend.innerHTML="";
  seg.forEach((s,i)=>{
    const div=document.createElement("div");
    div.style.cssText="display:flex;align-items:center;gap:8px;padding:2px 4px;border-radius:6px;cursor:pointer";
    div.innerHTML=`<span style="width:10px;height:10px;border-radius:999px;display:inline-block;background:${COLORS[i%COLORS.length]}"></span>
                   <span style="font-size:13px;color:#374151">${s.label||"—"}: <b>${s.value||0}</b></span>`;
    div.addEventListener("click",()=>go(s.slug||"")); legend.appendChild(div);
  });

  // Jei atėjom su ?seg ir ?page – nuimam page
  try{ const u=new URL(location.href); if(u.searchParams.has('seg')&&u.searchParams.has('page')){u.searchParams.delete('page'); history.replaceState(null,'',u.toString());}}catch(_){}
})();
</script>

<!-- Stulpelių rodyti/slėpti (su COLGROUP pločiais) -->
<script>
(function(){
  const WRAP=document.getElementById("cols-config");
  const TABLE=document.getElementById("results-table");
  const CG=document.getElementById("results-colgroup");
  if(!WRAP||!TABLE||!CG) return;

  const BTN=WRAP.querySelector("#cols-toggle");
  const PANEL=WRAP.querySelector("#cols-panel");
  const RESET=WRAP.querySelector("#cols-reset");
  const KEY=`uzklausos_cols:${TABLE.id||'results-table'}:${location.pathname}`;

  BTN.addEventListener("click",(e)=>{e.preventDefault(); PANEL.style.display=PANEL.style.display==="none"?"flex":"none";});

  function mapFromUI(){
    const m={}; PANEL.querySelectorAll('input[type="checkbox"][data-col]').forEach(ch=> m[ch.dataset.col]=!!ch.checked );
    return m;
  }
  function apply(map){
    Object.keys(map).forEach(k=>{
      const show=!!map[k];
      TABLE.querySelectorAll(`[data-col="${k}"]`).forEach(el=> el.style.display=show?"":"none");
      const col=CG.querySelector(`col[data-col="${k}"]`);
      if(col){ if(show){ col.style.width=col.dataset.width||""; }else{ if(!col.dataset.width) col.dataset.width=col.style.width||""; col.style.width="0px"; } }
    });
    window.dispatchEvent(new Event('table:cols-changed'));
  }
  function load(){ try{return JSON.parse(localStorage.getItem(KEY)||'null');}catch(_){return null;} }
  function save(m){ try{ localStorage.setItem(KEY, JSON.stringify(m)); }catch(_){} }

  PANEL.addEventListener('change',()=>{ const m=mapFromUI(); save(m); apply(m); });
  RESET.addEventListener('click',()=>{ localStorage.removeItem(KEY); localStorage.removeItem(`colOrder:${TABLE.id||'results-table'}:${location.pathname}`); location.reload(); });

  const saved=load();
  if(saved){ PANEL.querySelectorAll('input[data-col]').forEach(ch=>{ if(saved.hasOwnProperty(ch.dataset.col)) ch.checked=!!saved[ch.dataset.col]; }); apply(saved); }
  else { const init=mapFromUI(); save(init); apply(init); }

  // Filtrų forma – išmetam page (visada 1-as puslapis po submit)
  const f=document.querySelector('.filters-form');
  if(f){ f.addEventListener('submit',()=>{ const pg=f.querySelector('input[name="page"]'); if(pg) pg.remove(); }); }
})();
</script>

{% include "snippets/columns_dnd.html" %}
{% endblock %}
