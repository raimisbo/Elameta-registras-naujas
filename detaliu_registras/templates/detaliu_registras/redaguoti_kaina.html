{# templates/detaliu_registras/redaguoti_kaina.html #}
{% extends "base.html" %}
{% block title %}Kainų redagavimas{% endblock %}

{% block content %}
<h1>Kainų redagavimas</h1>
<p style="color:#6b7280">
  Užklausa #{{ uzklausa.id }} —
  <strong>Detalė</strong>: {{ uzklausa.detale.pavadinimas|default:"—" }}
  | Projektas: {{ uzklausa.projektas.pavadinimas|default:"—" }}
</p>

<form method="post" novalidate>
  {% csrf_token %}
  {{ formset.management_form }}

  <div style="border:1px solid #e5e7eb;border-radius:10px;padding:12px;background:#fff">
    <div class="table-responsive" style="overflow:auto">
      <table class="table" style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            {% with f0=formset.forms.0|default:formset.empty_form %}
              {% for f in f0.visible_fields %}
                {% if f.name != 'DELETE' %}
                  <th scope="col" style="text-align:left;padding:8px 10px;border-bottom:1px solid #e5e7eb">{{ f.label }}</th>
                {% endif %}
              {% endfor %}
            {% endwith %}
            <th scope="col" style="text-align:left;padding:8px 10px;border-bottom:1px solid #e5e7eb">Trinti</th>
          </tr>
        </thead>

        <tbody id="kainos-tbody">
          {% for f in formset.forms %}
            <tr>
              {# paslėpti laukeliai (id, valiuta ir kt.) #}
              {% for h in f.hidden_fields %}{{ h }}{% endfor %}

              {% for field in f.visible_fields %}
                {% if field.name != 'DELETE' %}
                  <td style="padding:8px 10px;border-bottom:1px solid #f3f4f6">
                    {{ field.errors }}{{ field }}
                  </td>
                {% endif %}
              {% endfor %}

              <td style="padding:8px 10px;border-bottom:1px solid #f3f4f6">
                {# tik pats checkbox be „Ištrinti“ teksto #}
                {{ f.DELETE.as_widget }}
              </td>
            </tr>
          {% empty %}
            {# jei view nepaduoda extra=1, čia nieko nebus; mygtukas „Pridėti eilutę“ vis tiek veiks #}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" type="button" id="add-row">Pridėti eilutę</button>
      <button class="btn" type="submit">Išsaugoti</button>
      <a class="btn btn-secondary" href="{% url 'detaliu_registras:perziureti_uzklausa' uzklausa.pk %}">Atgal</a>
    </div>
  </div>
</form>

{# šablonas naujai eilutei – naudoja empty_form su __prefix__ #}
<template id="row-template">
  <tr>
    {% with ef=formset.empty_form %}
      {% for h in ef.hidden_fields %}{{ h.as_widget }}{% endfor %}
      {% for field in ef.visible_fields %}
        {% if field.name != 'DELETE' %}
          <td style="padding:8px 10px;border-bottom:1px solid #f3f4f6">{{ field.as_widget }}</td>
        {% endif %}
      {% endfor %}
      <td style="padding:8px 10px;border-bottom:1px solid #f3f4f6">
        {{ ef.DELETE.as_widget }}
      </td>
    {% endwith %}
  </tr>
</template>

<script>
(function(){
  const tbody   = document.getElementById('kainos-tbody');
  const tmpl    = document.getElementById('row-template');
  const addBtn  = document.getElementById('add-row');
  const totalEl = document.querySelector('[name="{{ formset.prefix }}-TOTAL_FORMS"]');

  if(!tbody || !tmpl || !addBtn || !totalEl) return;

  function addRow(){
    const idx = parseInt(totalEl.value || "0", 10);
    let html = tmpl.innerHTML.replaceAll('__prefix__', String(idx));
    const wrap = document.createElement('tbody');
    wrap.innerHTML = html.trim();
    tbody.appendChild(wrap.firstElementChild);
    totalEl.value = String(idx + 1);
  }

  addBtn.addEventListener('click', addRow);
})();
</script>
{% endblock %}
