{% extends "base.html" %}
{% load static %}

{% block title %}Valdyti kainas{% endblock %}

{% block content %}
<div class="detail-wrap">

  <div class="detail-header">
    <div class="detail-header-left">
      <a class="btn-action btn-secondary" href="{% url 'pozicijos:detail' pozicija.pk %}">← Atgal</a>
      <div class="detail-title">
        Valdyti kainas: {{ pozicija.poz_kodas|default:pozicija.id }}
      </div>
    </div>

    <div class="detail-header-actions">
      {# SVARBU: mygtukas nebesubmitina "per form=..." – Safari čia mėgsta iškrėsti fokusų #}
      <button class="btn-action btn-secondary" type="button" id="kainos-submit-top">Išsaugoti</button>
    </div>
  </div>

  <section class="poz-card" style="margin-top:12px;">
    <h2 class="poz-card-title">Filtrai</h2>

    <form id="kainos-filters" method="get" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
      <div class="form-field">
        <label for="id_busena">Būsena</label>
        <select name="busena" id="id_busena">
          <option value="" {% if not busena %}selected{% endif %}>Visos</option>
          <option value="aktuali" {% if busena == "aktuali" %}selected{% endif %}>Aktuali</option>
          <option value="sena" {% if busena == "sena" %}selected{% endif %}>Neaktuali</option>
        </select>
      </div>

      <div class="form-field">
        <label for="id_matas">Matas</label>
        <select name="matas" id="id_matas">
          <option value="" {% if not matas %}selected{% endif %}>Visi</option>
          <option value="vnt" {% if matas == "vnt" %}selected{% endif %}>Vnt.</option>
          <option value="kg" {% if matas == "kg" %}selected{% endif %}>kg</option>
          <option value="komplektas" {% if matas == "komplektas" %}selected{% endif %}>Komplektas</option>
        </select>
      </div>

      <div class="form-field">
        <button class="btn-action btn-secondary" type="submit">Taikyti</button>
        <a class="btn-action btn-secondary" href="{% url 'pozicijos:kainos_list' pozicija.pk %}">Išvalyti</a>
      </div>
    </form>
  </section>

  <form method="post" id="kainos-form" action="{% url 'pozicijos:kainos_list' pozicija.pk %}{% if busena or matas %}?{% if busena %}busena={{ busena }}{% endif %}{% if busena and matas %}&{% endif %}{% if matas %}matas={{ matas }}{% endif %}{% endif %}">
    {% csrf_token %}

    {# Realus submit mygtukas pačios formos viduje – kad submit visada pasiimtų formset duomenis #}
    <button type="submit" id="kainos-submit-real" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Išsaugoti</button>

    <input type="hidden" name="_busena" value="{{ busena }}">
    <input type="hidden" name="_matas" value="{{ matas }}">

    <section class="poz-card" style="margin-top:12px;">
      <h2 class="poz-card-title">Kainos</h2>

      {% include "pozicijos/components/kainos_formset.html" with formset=formset kainos_can_delete=kainos_can_delete %}
    </section>
  </form>

</div>

<script>
(function () {
  const topBtn = document.getElementById('kainos-submit-top');
  const form = document.getElementById('kainos-form');
  const realBtn = document.getElementById('kainos-submit-real');

  if (!topBtn || !form) return;

  topBtn.addEventListener('click', function () {
    if (typeof form.requestSubmit === 'function') {
      form.requestSubmit();
    } else if (realBtn) {
      realBtn.click();
    } else {
      form.submit();
    }
  });
})();
</script>
{% endblock %}
