{# pozicijos/templates/pozicijos/components/kainos_formset.html #}

<div class="kainos-formset" id="kainos-formset-{{ formset.prefix }}" data-prefix="{{ formset.prefix }}">

  {{ formset.management_form }}

  {% if formset.non_form_errors %}
    <div class="errorlist nonform" style="margin-bottom:8px;color:#b91c1c;">
      {% for err in formset.non_form_errors %}
        <div>{{ err }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="kainos-head">
    <div class="kainos-head__text">Kainų eilutės sudaro galutinę kainą.</div>
    <button type="button" class="btn btn-secondary" id="kainos-add-row-{{ formset.prefix }}">+ Pridėti eilutę</button>
  </div>

  <div class="kainos-table-wrap">
    <table class="table zebra kainos-table">
      <thead>
        <tr>
          <th class="col-kaina">Kaina €</th>
          <th class="col-matas">Matas</th>
          <th class="col-qty">Nuo</th>
          <th class="col-qty">Iki</th>
          <th class="col-gal">Galiojimas</th>
          <th class="col-bus">Būsena</th>
          <th class="col-past">Pastabos</th>
          <th class="col-hist">Ist.</th>
          <th class="col-del">Šal.</th>
        </tr>
      </thead>

      <tbody id="kainu-formset-body-{{ formset.prefix }}">
        {% for form in formset %}
          {% with st=form.busena_ui.value %}
          <tr class="kaina-row {% if st == 'aktuali' %}kaina-row--aktuali{% else %}kaina-row--neaktuali{% endif %}">
            <td class="cell-kaina">
              {{ form.id }}
              {{ form.kaina }}
              {% if form.kaina.errors %}<div class="errorlist">{{ form.kaina.errors }}</div>{% endif %}
            </td>

            <td class="cell-matas">
              {{ form.matas }}
              {% if form.matas.errors %}<div class="errorlist">{{ form.matas.errors }}</div>{% endif %}
            </td>

            <td class="cell-qty">
              {{ form.kiekis_nuo }}
              {% if form.kiekis_nuo.errors %}<div class="errorlist">{{ form.kiekis_nuo.errors }}</div>{% endif %}
            </td>

            <td class="cell-qty">
              {{ form.kiekis_iki }}
              {% if form.kiekis_iki.errors %}<div class="errorlist">{{ form.kiekis_iki.errors }}</div>{% endif %}
            </td>

            <td class="cell-gal">
              <div class="date-stack">
                {{ form.galioja_nuo }}
                {{ form.galioja_iki }}
              </div>
            </td>

            <td class="cell-bus">
              {{ form.busena_ui }}
              {% if form.busena_ui.errors %}<div class="errorlist">{{ form.busena_ui.errors }}</div>{% endif %}
            </td>

            <td class="cell-past">
              {{ form.pastaba }}
              {% if form.pastaba.errors %}<div class="errorlist">{{ form.pastaba.errors }}</div>{% endif %}
            </td>

            <td class="cell-hist" style="text-align:center;">
              {% if form.instance.pk %}
                <a class="hist-link" href="{% url 'pozicijos:kaina_history' form.instance.pk %}">Ist.</a>
              {% else %}
                —
              {% endif %}
            </td>

            <td class="cell-del" style="text-align:center;">
              {{ form.DELETE }}
            </td>
          </tr>
          {% endwith %}
        {% empty %}
          <tr data-empty-row="1">
            <td colspan="9" style="text-align:center;color:#6b7280;">Nėra kainų eilučių.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<style>
  .kainos-head{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:8px;
  }
  .kainos-head__text{ font-size:14px; color:#4b5563; }

  .kainos-table-wrap{
    overflow:auto;
    max-width:100%;
  }

  .kainos-table{
    width:100%;
    min-width:1040px; /* + vienas stulpelis */
    table-layout:fixed;
  }

  /* sticky paskutinis stulpelis (Šal.) */
  .kainos-table th:last-child,
  .kainos-table td:last-child{
    position: sticky;
    right: 0;
    z-index: 2;
    background: inherit;
    border-left: 1px solid #e5e7eb;
    vertical-align:top;
    white-space:normal;
    word-break:break-word;
  }
  .kainos-table thead th:last-child{ z-index: 3; }

  /* plotis: suveržiam kitus, Pastabos pasiima likutį */
  .col-kaina{ width:90px; }
  .col-matas{ width:120px; }
  .col-qty{ width:80px; }
  .col-gal{ width:140px; }
  .col-bus{ width:110px; }
  .col-hist{ width:60px; }
  .col-del{ width:55px; }

  .date-stack{ display:flex; flex-direction:column; gap:4px; }

  .kainos-table input,
  .kainos-table select,
  .kainos-table textarea{
    width:100%;
    box-sizing:border-box;
  }

  /* Pastabos: auga pagal tekstą */
  .kainos-table td textarea{
    min-height:34px;
    resize:none;
    overflow:hidden;
  }

  .hist-link{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:2px 6px;
    border:1px solid #d1d5db;
    border-radius:6px;
    text-decoration:none;
    color:#111827;
    font-size:0.85rem;
    background:#fff;
  }
  .hist-link:hover{ filter:brightness(0.98); }

  .kaina-row--aktuali td{ background:#ecfdf5; }
  .kaina-row--neaktuali td{ background:#f9fafb; color:#6b7280; }
</style>

<script>
(function () {
  function autoGrow(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = (el.scrollHeight) + 'px';
  }

  function bootOne(root) {
    const prefix = root.dataset.prefix;
    const body = document.getElementById('kainu-formset-body-' + prefix);
    const addBtn = document.getElementById('kainos-add-row-' + prefix);
    const tmpl = document.getElementById('kainos-empty-template-' + prefix);

    const totalInput =
      root.querySelector('#id_' + prefix + '-TOTAL_FORMS') ||
      root.querySelector('input[name="' + prefix + '-TOTAL_FORMS"]');

    if (!body || !addBtn || !totalInput || !tmpl) return;

    function initRow(row) {
      const ta = row.querySelector('textarea[data-autoresize="1"]');
      if (ta) {
        autoGrow(ta);
        ta.addEventListener('input', function(){ autoGrow(ta); });
      }
    }

    function removeEmptyRowIfPresent() {
      const empty = body.querySelector('tr[data-empty-row="1"]');
      if (empty) empty.remove();
    }

    body.querySelectorAll('tr.kaina-row').forEach(initRow);

    addBtn.addEventListener('click', function () {
      removeEmptyRowIfPresent();

      const i = parseInt(totalInput.value || '0', 10) || 0;
      const html = tmpl.innerHTML.replace(/__prefix__/g, String(i));

      const tmp = document.createElement('tbody');
      tmp.innerHTML = html.trim();

      const row = tmp.querySelector('tr');
      if (!row) return;

      body.appendChild(row);
      totalInput.value = String(i + 1);
      initRow(row);
    });
  }

  function bootAll() {
    document.querySelectorAll('.kainos-formset[data-prefix]').forEach(bootOne);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bootAll);
  } else {
    bootAll();
  }
})();
</script>

{# empty form template turi būti apačioje, kad JS galėtų pridėti eilutę #}
<template id="kainos-empty-template-{{ formset.prefix }}">
  {% with f=formset.empty_form %}
  <tr class="kaina-row kaina-row--neaktuali">
    <td class="cell-kaina">{{ f.id }}{{ f.kaina }}</td>
    <td class="cell-matas">{{ f.matas }}</td>
    <td class="cell-qty">{{ f.kiekis_nuo }}</td>
    <td class="cell-qty">{{ f.kiekis_iki }}</td>
    <td class="cell-gal"><div class="date-stack">{{ f.galioja_nuo }}{{ f.galioja_iki }}</div></td>
    <td class="cell-bus">{{ f.busena_ui }}</td>
    <td class="cell-past">{{ f.pastaba }}</td>
    <td class="cell-hist" style="text-align:center;">—</td>
    <td class="cell-del" style="text-align:center;">{{ f.DELETE }}</td>
  </tr>
  {% endwith %}
</template>
