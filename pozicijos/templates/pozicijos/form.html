{# pozicijos/templates/pozicijos/form.html #}
{% extends "base.html" %}

{% block title %}
  {% if pozicija %}Redaguoti poziciją {{ pozicija.poz_kodas }}{% else %}Nauja pozicija{% endif %}
{% endblock %}

{% block page_css %}
<style>
  .poz-form-page { background:#f3f3f3; }
  .poz-form-container { max-width:1200px; margin:0 auto; padding:16px 20px 32px; }

  .poz-form-header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:16px; }
  .poz-form-header h1{ margin:0 0 4px; font-size:1.3rem; font-weight:600; }
  .poz-form-header-sub{ margin:0; font-size:0.9rem; color:#666; }

  .poz-form-actions-top{ display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end; }

  .poz-form-grid{ display:grid; grid-template-columns:minmax(0,1fr) minmax(0,1fr); gap:16px; align-items:flex-start; }

  .poz-form-page .poz-card{
    background:#f9fafb;
    border:1px solid #e5e7eb;
    border-radius:6px;
    padding:12px 14px 10px;
    box-shadow:0 1px 3px rgba(15,23,42,0.06);
  }
  .poz-card--full{ grid-column:1 / -1; }

  .poz-card-title{ margin:0 0 8px; font-size:0.95rem; font-weight:600; color:#333; }

  .field-row{
    display:grid;
    grid-template-columns:minmax(0,36%) minmax(0,64%);
    column-gap:8px;
    align-items:flex-start;
    font-size:0.9rem;
    margin-bottom:6px;
  }
  .field-label{ color:#777; padding-top:4px; }

  .field-control input,
  .field-control select,
  .field-control textarea{
    width:100%;
    box-sizing:border-box;
    padding:4px 6px;
    font-size:0.9rem;
  }
  .field-control input[type="checkbox"]{ width:auto; padding:0; }

  .field-errors{ margin-top:2px; font-size:0.8rem; color:#b91c1c; }
  .field-help{ font-size:0.78rem; color:#9ca3af; margin-top:2px; }

  .inline-checkboxes{ display:flex; flex-wrap:wrap; gap:12px; margin:6px 0 4px; }
  .inline-checkboxes label{ display:inline-flex; align-items:center; gap:6px; white-space:nowrap; font-size:0.9rem; cursor:pointer; }

  .subblock{ margin-top:8px; padding:8px 10px; border:1px dashed #d1d5db; border-radius:6px; background:#fff; }

  /* Maskavimo aprašymas: tik vertikaliai auga */
  #id_maskavimas{
    resize:none;
    overflow:hidden;
    min-height:48px;
  }

  /* Atlikimo terminas: skaičius + sufiksas */
  .with-suffix{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .with-suffix input{
    max-width:160px;
  }
  .unit-suffix{
    font-size:0.88rem;
    color:#6b7280;
    white-space:nowrap;
  }

  @media (max-width: 900px) {
    .poz-form-grid { grid-template-columns:1fr; }
    .poz-card, .poz-card--full { grid-column:1 / -1; }
  }
</style>
{% endblock %}

{% block body_class %}poz-form-page{% endblock %}

{% block content %}
<div class="poz-form-container">
  <div class="poz-form-header">
    <div>
      <h1>{% if pozicija %}Redaguoti poziciją{% else %}Nauja pozicija{% endif %}</h1>
      {% if pozicija %}
        <p class="poz-form-header-sub">
          {{ pozicija.poz_kodas }} – {{ pozicija.poz_pavad|default:"Be pavadinimo" }}
        </p>
      {% endif %}
    </div>
    <div class="poz-form-actions-top">
      <a href="{% url 'pozicijos:list' %}" class="btn btn-secondary">Atgal į sąrašą</a>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="flash flash-error">{{ form.non_field_errors }}</div>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="poz-form-grid">

      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Pagrindinė informacija</h2>

        <div class="field-row">
          <div class="field-label">{{ form.klientas.label }}</div>
          <div class="field-control">
            {{ form.klientas }}
            {% if form.klientas.errors %}<div class="field-errors">{{ form.klientas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.projektas.label }}</div>
          <div class="field-control">
            {{ form.projektas }}
            {% if form.projektas.errors %}<div class="field-errors">{{ form.projektas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.poz_kodas.label }}</div>
          <div class="field-control">
            {{ form.poz_kodas }}
            {% if form.poz_kodas.errors %}<div class="field-errors">{{ form.poz_kodas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.poz_pavad.label }}</div>
          <div class="field-control">
            {{ form.poz_pavad }}
            {% if form.poz_pavad.errors %}<div class="field-errors">{{ form.poz_pavad.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Specifikacija</h2>

        <div class="field-row">
          <div class="field-label">{{ form.metalas.label }}</div>
          <div class="field-control">
            {{ form.metalas }}
            {% if form.metalas.errors %}<div class="field-errors">{{ form.metalas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.plotas.label }}</div>
          <div class="field-control">
            {{ form.plotas }}
            {% if form.plotas.errors %}<div class="field-errors">{{ form.plotas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.svoris.label }}</div>
          <div class="field-control">
            {{ form.svoris }}
            {% if form.svoris.errors %}<div class="field-errors">{{ form.svoris.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Kabinimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.kabinimo_budas.label }}</div>
          <div class="field-control">
            {{ form.kabinimo_budas }}
            {% if form.kabinimo_budas.errors %}<div class="field-errors">{{ form.kabinimo_budas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.kabinimas_reme.label }}</div>
          <div class="field-control">
            {{ form.kabinimas_reme }}
            {% if form.kabinimas_reme.errors %}<div class="field-errors">{{ form.kabinimas_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.detaliu_kiekis_reme.label }}</div>
          <div class="field-control">
            {{ form.detaliu_kiekis_reme }}
            {% if form.detaliu_kiekis_reme.errors %}<div class="field-errors">{{ form.detaliu_kiekis_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.faktinis_kiekis_reme.label }}</div>
          <div class="field-control">
            {{ form.faktinis_kiekis_reme }}
            {% if form.faktinis_kiekis_reme.errors %}<div class="field-errors">{{ form.faktinis_kiekis_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# PASLAUGA: checkbox’ai + Miltų detalizacija #}
      <section class="poz-card">
        <h2 class="poz-card-title">Paslauga</h2>

        <div class="inline-checkboxes">
          <label>{{ form.paslauga_ktl }} <span>{{ form.paslauga_ktl.label }}</span></label>
          <label>{{ form.paslauga_miltai }} <span>{{ form.paslauga_miltai.label }}</span></label>
          <label>{{ form.paslauga_paruosimas }} <span>{{ form.paslauga_paruosimas.label }}</span></label>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.paruosimas.label }}</div>
          <div class="field-control">
            {{ form.paruosimas }}
            {% if form.paruosimas.errors %}<div class="field-errors">{{ form.paruosimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.padengimas.label }}</div>
          <div class="field-control">
            {{ form.padengimas }}
            {% if form.padengimas.errors %}<div class="field-errors">{{ form.padengimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.padengimo_standartas.label }}</div>
          <div class="field-control">
            {{ form.padengimo_standartas }}
            {% if form.padengimo_standartas.errors %}<div class="field-errors">{{ form.padengimo_standartas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.spalva.label }}</div>
          <div class="field-control">
            {{ form.spalva }}
            {% if form.spalva.errors %}<div class="field-errors">{{ form.spalva.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div id="miltai-subblock" class="subblock" style="display:none;">
          <div class="field-row">
            <div class="field-label">{{ form.miltu_kodas.label }}</div>
            <div class="field-control">
              {{ form.miltu_kodas }}
              {% if form.miltu_kodas.errors %}<div class="field-errors">{{ form.miltu_kodas.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_spalva.label }}</div>
            <div class="field-control">
              {{ form.miltu_spalva }}
              {% if form.miltu_spalva.errors %}<div class="field-errors">{{ form.miltu_spalva.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_tiekejas.label }}</div>
            <div class="field-control">
              {{ form.miltu_tiekejas }}
              {% if form.miltu_tiekejas.errors %}<div class="field-errors">{{ form.miltu_tiekejas.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_blizgumas.label }}</div>
            <div class="field-control">
              {{ form.miltu_blizgumas }}
              {% if form.miltu_blizgumas.errors %}<div class="field-errors">{{ form.miltu_blizgumas.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_kaina.label }}</div>
            <div class="field-control">
              {{ form.miltu_kaina }}
              {% if form.miltu_kaina.errors %}<div class="field-errors">{{ form.miltu_kaina.errors|striptags }}</div>{% endif %}
            </div>
          </div>
        </div>
      </section>

      {# MASKAVIMAS #}
      <section class="poz-card">
        <h2 class="poz-card-title">Maskavimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.maskavimo_tipas.label }}</div>
          <div class="field-control">
            {{ form.maskavimo_tipas }}
            {% if form.maskavimo_tipas.errors %}<div class="field-errors">{{ form.maskavimo_tipas.errors|striptags }}</div>{% endif %}
            <div class="field-help">Pasirinkite „Yra“, jei reikalingas maskavimas.</div>
          </div>
        </div>

        <div class="field-row" id="maskavimas-row" style="display:none;">
          <div class="field-label">{{ form.maskavimas.label }}</div>
          <div class="field-control">
            {{ form.maskavimas }}
            {% if form.maskavimas.errors %}<div class="field-errors">{{ form.maskavimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Pakavimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.pakavimo_tipas.label }}</div>
          <div class="field-control">
            {{ form.pakavimo_tipas }}
            {% if form.pakavimo_tipas.errors %}<div class="field-errors">{{ form.pakavimo_tipas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.pakavimas.label }}</div>
          <div class="field-control">
            {{ form.pakavimas }}
            {% if form.pakavimas.errors %}<div class="field-errors">{{ form.pakavimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.instrukcija.label }}</div>
          <div class="field-control">
            {{ form.instrukcija }}
            {% if form.instrukcija.errors %}<div class="field-errors">{{ form.instrukcija.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Terminai</h2>
        <div class="field-row">
          <div class="field-label">{{ form.atlikimo_terminas.label }}</div>
          <div class="field-control">
            <div class="with-suffix">
              {{ form.atlikimo_terminas }}
              <span class="unit-suffix">Darbo dienos</span>
            </div>
            {% if form.atlikimo_terminas.errors %}<div class="field-errors">{{ form.atlikimo_terminas.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Testai / kokybė</h2>
        <div class="field-row">
          <div class="field-label">{{ form.testai_kokybe.label }}</div>
          <div class="field-control">
            {{ form.testai_kokybe }}
            {% if form.testai_kokybe.errors %}<div class="field-errors">{{ form.testai_kokybe.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# KAINOS BLOKAS: turi būti ir kuriant, ir redaguojant #}
      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Kaina</h2>

        {% if kainos_formset %}
          {% include "pozicijos/components/kainos_formset.html" with formset=kainos_formset show_help=True %}
          {% if kainos_formset.non_form_errors %}
            <div class="field-errors" style="margin-top:8px;">
              {{ kainos_formset.non_form_errors|striptags }}
            </div>
          {% endif %}
        {% else %}
          <p style="color:#6b7280;margin:0;">Kainų formset nepaduotas iš view (kainos_formset).</p>
        {% endif %}
      </section>

      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Pastabos</h2>
        <div class="field-row">
          <div class="field-label">{{ form.pastabos.label }}</div>
          <div class="field-control">
            {{ form.pastabos }}
            {% if form.pastabos.errors %}<div class="field-errors">{{ form.pastabos.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

    </div>

    <div class="poz-form-footer" style="margin-top:16px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
      {% if pozicija %}
        <a href="{% url 'pozicijos:detail' pozicija.id %}" class="btn btn-secondary">Atgal į pozicijos kortelę</a>
      {% else %}
        <a href="{% url 'pozicijos:list' %}" class="btn btn-secondary">Atgal į sąrašą</a>
      {% endif %}
      <button type="submit" class="btn btn-primary">
        {% if pozicija %}Išsaugoti{% else %}Sukurti{% endif %}
      </button>
    </div>

    {% if suggestions %}
      {% for field_name, values in suggestions.items %}
        <datalist id="dl-{{ field_name }}">
          {% for v in values %}
            <option value="{{ v }}"></option>
          {% endfor %}
        </datalist>
      {% endfor %}
    {% endif %}
  </form>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {

  // --- Maskavimas: Yra / Nėra + auto-grow textarea ---
  var masTipas = document.getElementById('id_maskavimo_tipas');
  var masRow   = document.getElementById('maskavimas-row');
  var masTxt   = document.getElementById('id_maskavimas');

  function autoGrow(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = (el.scrollHeight) + 'px';
  }

  function syncMaskavimasUI() {
    if (!masTipas || !masRow) return;
    var val = (masTipas.value || '').toLowerCase();
    var show = (val === 'yra');
    masRow.style.display = show ? '' : 'none';
    if (!show && masTxt) {
      masTxt.value = '';
      autoGrow(masTxt);
    }
    if (show && masTxt) autoGrow(masTxt);
  }

  if (masTipas) masTipas.addEventListener('change', syncMaskavimasUI);
  if (masTxt) masTxt.addEventListener('input', function(){ autoGrow(masTxt); });

  // --- Paslauga: Miltų detalizacija rodoma tik jei paslauga_miltai pažymėta ---
  var chkMiltai = document.getElementById('id_paslauga_miltai');
  var miltaiBox = document.getElementById('miltai-subblock');

  function syncMiltaiUI() {
    if (!chkMiltai || !miltaiBox) return;
    miltaiBox.style.display = chkMiltai.checked ? '' : 'none';
  }
  if (chkMiltai) chkMiltai.addEventListener('change', syncMiltaiUI);

  // init
  syncMaskavimasUI();
  if (masTxt) autoGrow(masTxt);
  syncMiltaiUI();
});
</script>
{% endblock %}
