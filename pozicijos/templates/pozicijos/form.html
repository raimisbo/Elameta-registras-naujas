{# pozicijos/templates/pozicijos/form.html #}
{% extends "base.html" %}

{% block title %}
  {% if pozicija %}Redaguoti poziciją {{ pozicija.poz_kodas }}{% else %}Nauja pozicija{% endif %}
{% endblock %}

{% block page_css %}
<style>
  .poz-form-page { background:#f3f3f3; }

  .poz-form-container {
    max-width:1200px;
    margin:0 auto;
    padding:16px 20px 32px;
  }

  .poz-form-header {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:16px;
  }

  .poz-form-header h1 {
    margin:0 0 4px;
    font-size:1.3rem;
    font-weight:600;
  }

  .poz-form-header-sub {
    margin:0;
    font-size:0.9rem;
    color:#666;
  }

  .poz-form-actions-top {
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:flex-end;
  }

  .poz-form-grid {
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
  }

  .poz-form-page .poz-card {
    background:#f9fafb;
    border:1px solid #e5e7eb;
    border-radius:6px;
    padding:12px 14px 10px;
    box-shadow:0 1px 3px rgba(15,23,42,0.06);
  }

  .poz-card--full { grid-column:1 / -1; }

  .poz-card-title {
    margin:0 0 8px;
    font-size:0.95rem;
    font-weight:600;
    color:#333;
  }

  .field-row {
    display:grid;
    grid-template-columns:minmax(0,36%) minmax(0,64%);
    column-gap:8px;
    align-items:flex-start;
    font-size:0.9rem;
    margin-bottom:6px;
  }

  .field-label { color:#777; padding-top:4px; }

  .field-control input,
  .field-control select,
  .field-control textarea {
    width:100%;
    box-sizing:border-box;
    padding:4px 6px;
    font-size:0.9rem;
  }

  .field-control input[type="checkbox"],
  .field-control input[type="radio"] {
    width:auto;
    padding:0;
  }

  .field-errors {
    margin-top:2px;
    font-size:0.8rem;
    color:#b91c1c;
  }

  .field-help {
    font-size:0.78rem;
    color:#9ca3af;
    margin-top:2px;
  }

  .inline-checkboxes {
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-bottom:4px;
  }

  .inline-checkboxes label {
    display:inline-flex;
    align-items:center;
    gap:4px;
    white-space:nowrap;
    font-size:0.9rem;
    cursor:pointer;
  }

  .milt-details-title {
    margin:8px 0 4px;
    font-size:0.85rem;
    font-weight:600;
    color:#374151;
  }

  .poz-form-footer {
    margin-top:16px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
  }

  .poz-form-footer .btn-primary {
    background:#2563eb;
    border-color:#2563eb;
    color:#fff;
  }

  .poz-form-footer .btn-secondary {
    background:#f3f4f6;
    border-color:#d1d5db;
    color:#111827;
  }

  /* Kainos bloko pagalbinis stilius, kad mygtukas neliptų ir lentelė turėtų tvarką */
  .kainos-block-wrap { margin-top:6px; }

  @media (max-width: 900px) {
    .poz-form-grid { grid-template-columns:1fr; }
    .poz-card, .poz-card--full { grid-column:1 / -1; }
  }
</style>
{% endblock %}

{% block body_class %}poz-form-page{% endblock %}

{% block content %}
<div class="poz-form-container">
  <div class="poz-form-header">
    <div>
      <h1>{% if pozicija %}Redaguoti poziciją{% else %}Nauja pozicija{% endif %}</h1>
      {% if pozicija %}
        <p class="poz-form-header-sub">
          {{ pozicija.poz_kodas }} – {{ pozicija.poz_pavad|default:"Be pavadinimo" }}
        </p>
      {% endif %}
    </div>
    <div class="poz-form-actions-top">
      <a href="{% url 'pozicijos:list' %}" class="btn btn-secondary">Atgal į sąrašą</a>
    </div>
  </div>

  {% if form.non_field_errors %}
    <div class="flash flash-error">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="poz-form-grid">

      {# 1. Pagrindinė informacija #}
      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Pagrindinė informacija</h2>

        <div class="field-row">
          <div class="field-label">{{ form.klientas.label }}</div>
          <div class="field-control">
            {{ form.klientas }}
            {% if form.klientas.errors %}<div class="field-errors">{{ form.klientas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.projektas.label }}</div>
          <div class="field-control">
            {{ form.projektas }}
            {% if form.projektas.errors %}<div class="field-errors">{{ form.projektas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.poz_kodas.label }}</div>
          <div class="field-control">
            {{ form.poz_kodas }}
            {% if form.poz_kodas.errors %}<div class="field-errors">{{ form.poz_kodas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.poz_pavad.label }}</div>
          <div class="field-control">
            {{ form.poz_pavad }}
            {% if form.poz_pavad.errors %}<div class="field-errors">{{ form.poz_pavad.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# 2. Specifikacija #}
      <section class="poz-card">
        <h2 class="poz-card-title">Specifikacija</h2>

        <div class="field-row">
          <div class="field-label">{{ form.metalas.label }}</div>
          <div class="field-control">
            {{ form.metalas }}
            {% if form.metalas.errors %}<div class="field-errors">{{ form.metalas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.plotas.label }}</div>
          <div class="field-control">
            {{ form.plotas }}
            {% if form.plotas.errors %}<div class="field-errors">{{ form.plotas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.svoris.label }}</div>
          <div class="field-control">
            {{ form.svoris }}
            {% if form.svoris.errors %}<div class="field-errors">{{ form.svoris.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# 3. Kabinimas #}
      <section class="poz-card">
        <h2 class="poz-card-title">Kabinimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.kabinimo_budas.label }}</div>
          <div class="field-control">
            {{ form.kabinimo_budas }}
            {% if form.kabinimo_budas.errors %}<div class="field-errors">{{ form.kabinimo_budas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.kabinimas_reme.label }}</div>
          <div class="field-control">
            {{ form.kabinimas_reme }}
            {% if form.kabinimas_reme.errors %}<div class="field-errors">{{ form.kabinimas_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.detaliu_kiekis_reme.label }}</div>
          <div class="field-control">
            {{ form.detaliu_kiekis_reme }}
            {% if form.detaliu_kiekis_reme.errors %}<div class="field-errors">{{ form.detaliu_kiekis_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.faktinis_kiekis_reme.label }}</div>
          <div class="field-control">
            {{ form.faktinis_kiekis_reme }}
            {% if form.faktinis_kiekis_reme.errors %}<div class="field-errors">{{ form.faktinis_kiekis_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# 4. Paslauga #}
      <section class="poz-card">
        <h2 class="poz-card-title">Paslauga</h2>

        <div class="field-row">
          <div class="field-label">Paslaugos</div>
          <div class="field-control">
            <div class="inline-checkboxes">
              <label><input type="checkbox" id="id_paslauga_ktl"> KTL</label>
              <label><input type="checkbox" id="id_paslauga_milt"> Miltelinis dažymas</label>
              <label><input type="checkbox" id="id_paslauga_paruosimas"> Paruošimas (Chemetall)</label>
            </div>
            <div class="field-help">
              Galima žymėti <strong>KTL + Miltelinis dažymas</strong> arba <strong>Paruošimas + Miltelinis dažymas</strong>.
              KTL ir Paruošimas kartu – negalima.
            </div>
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.paruosimas.label }}</div>
          <div class="field-control">
            {{ form.paruosimas }}
            {% if form.paruosimas.errors %}<div class="field-errors">{{ form.paruosimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.padengimas.label }}</div>
          <div class="field-control">
            {{ form.padengimas }}
            {% if form.padengimas.errors %}<div class="field-errors">{{ form.padengimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.padengimo_standartas.label }}</div>
          <div class="field-control">
            {{ form.padengimo_standartas }}
            {% if form.padengimo_standartas.errors %}<div class="field-errors">{{ form.padengimo_standartas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.spalva.label }}</div>
          <div class="field-control">
            {{ form.spalva }}
            {% if form.spalva.errors %}<div class="field-errors">{{ form.spalva.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div id="milt-details-block" style="display:none; margin-top:8px;">
          <div class="milt-details-title">Miltelinis dažymas – detalės</div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_kodas.label|default:"Miltelių kodas" }}</div>
            <div class="field-control">{{ form.miltu_kodas }}</div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_spalva.label|default:"Miltelių spalva" }}</div>
            <div class="field-control">{{ form.miltu_spalva }}</div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_tiekejas.label|default:"Miltelių tiekėjas" }}</div>
            <div class="field-control">{{ form.miltu_tiekejas }}</div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_blizgumas.label|default:"Blizgumas" }}</div>
            <div class="field-control">{{ form.miltu_blizgumas }}</div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_kaina.label|default:"Miltelių kaina" }}</div>
            <div class="field-control">
              {{ form.miltu_kaina }}
              {% if form.miltu_kaina.errors %}<div class="field-errors">{{ form.miltu_kaina.errors|striptags }}</div>{% endif %}
            </div>
          </div>
        </div>
      </section>

      {# 5. Maskavimas #}
      <section class="poz-card">
        <h2 class="poz-card-title">Maskavimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.maskavimo_tipas.label }}</div>
          <div class="field-control">
            {{ form.maskavimo_tipas }}
            <div class="field-help">Pasirinkite: Įprastas arba Specialus.</div>
            {% if form.maskavimo_tipas.errors %}<div class="field-errors">{{ form.maskavimo_tipas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.maskavimas.label }}</div>
          <div class="field-control">
            {{ form.maskavimas }}
            {% if form.maskavimas.errors %}<div class="field-errors">{{ form.maskavimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# 6. Pakavimas #}
      <section class="poz-card">
        <h2 class="poz-card-title">Pakavimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.pakavimo_tipas.label }}</div>
          <div class="field-control">
            {{ form.pakavimo_tipas }}
            <div class="field-help">Palaidas, Standartinis, Geras arba Individualus.</div>
            {% if form.pakavimo_tipas.errors %}<div class="field-errors">{{ form.pakavimo_tipas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.pakavimas.label }}</div>
          <div class="field-control">
            {{ form.pakavimas }}
            {% if form.pakavimas.errors %}<div class="field-errors">{{ form.pakavimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.instrukcija.label }}</div>
          <div class="field-control">
            {{ form.instrukcija }}
            {% if form.instrukcija.errors %}<div class="field-errors">{{ form.instrukcija.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# 7. Terminai #}
      <section class="poz-card">
        <h2 class="poz-card-title">Terminai</h2>

        <div class="field-row">
          <div class="field-label">{{ form.atlikimo_terminas.label }}</div>
          <div class="field-control">
            {{ form.atlikimo_terminas }}
            {% if form.atlikimo_terminas.errors %}<div class="field-errors">{{ form.atlikimo_terminas.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# 8. Testai / kokybė #}
      <section class="poz-card">
        <h2 class="poz-card-title">Testai / kokybė</h2>

        <div class="field-row">
          <div class="field-label">{{ form.testai_kokybe.label }}</div>
          <div class="field-control">
            {{ form.testai_kokybe }}
            {% if form.testai_kokybe.errors %}<div class="field-errors">{{ form.testai_kokybe.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      {# 9. Kaina – KainosEilute formset (tas pats create/edit) #}
      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Kaina</h2>

        <div class="kainos-block-wrap">
          {% if kainos_formset %}
            {% include "pozicijos/components/kainos_formset.html" with formset=kainos_formset add_button_id="kainos-add-row" %}
          {% else %}
            <div class="field-help" style="color:#b91c1c;">
              Trūksta <strong>kainos_formset</strong> kontekste. Patikrink views.py (pozicija_create / pozicija_edit).
            </div>
          {% endif %}
        </div>
      </section>

      {# 10. Pastabos #}
      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Pastabos</h2>

        <div class="field-row">
          <div class="field-label">{{ form.pastabos.label }}</div>
          <div class="field-control">
            {{ form.pastabos }}
            {% if form.pastabos.errors %}<div class="field-errors">{{ form.pastabos.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

    </div>

    <div class="poz-form-footer">
      {% if pozicija %}
        <a href="{% url 'pozicijos:detail' pozicija.id %}" class="btn btn-secondary">
          Atgal į pozicijos kortelę
        </a>
      {% else %}
        <a href="{% url 'pozicijos:list' %}" class="btn btn-secondary">
          Atgal į sąrašą
        </a>
      {% endif %}

      <button type="submit" class="btn btn-primary">
        {% if pozicija %}Išsaugoti{% else %}Sukurti{% endif %}
      </button>
    </div>

    {# Datalist'ai iš suggestions #}
    {% if suggestions %}
      {% for field_name, values in suggestions.items %}
        <datalist id="dl-{{ field_name }}">
          {% for v in values %}
            <option value="{{ v }}"></option>
          {% endfor %}
        </datalist>
      {% endfor %}
    {% endif %}
  </form>
</div>
{% endblock %}

{% block page_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- PASLAUGA: KTL / Miltelinis / Paruošimas ---
  var cbKtl  = document.getElementById('id_paslauga_ktl');
  var cbMilt = document.getElementById('id_paslauga_milt');
  var cbPar  = document.getElementById('id_paslauga_paruosimas');

  var fldPar = document.getElementById('id_paruosimas');
  var fldPad = document.getElementById('id_padengimas');
  var fldStd = document.getElementById('id_padengimo_standartas');

  var miltBlock = document.getElementById('milt-details-block');

  function updateMiltBlock() {
    if (!cbMilt || !miltBlock) return;
    miltBlock.style.display = cbMilt.checked ? 'block' : 'none';
  }

  function handleKtlChange() {
    if (!cbKtl || !fldPar || !fldPad || !fldStd) return;
    if (cbKtl.checked) {
      if (cbPar) cbPar.checked = false;
      if (!fldPar.value) fldPar.value = 'Paruošimas Chemetall';
      if (!fldPad.value) fldPad.value = 'KTL';
      if (!fldStd.value) fldStd.value = 'BASF CG 570';
    }
  }

  function handleParuosimasChange() {
    if (!cbPar || !fldPar) return;
    if (cbPar.checked) {
      if (cbKtl) cbKtl.checked = false;
      if (!fldPar.value) fldPar.value = 'Paruošimas Chemetall';
    }
  }

  function syncPaslaugosFromFields() {
    var par = (fldPar && fldPar.value ? fldPar.value : '').toLowerCase();
    var pad = (fldPad && fldPad.value ? fldPad.value : '').toLowerCase();

    if (cbKtl) cbKtl.checked = (pad === 'ktl');
    if (cbPar) cbPar.checked = (!cbKtl || !cbKtl.checked) && par.indexOf('chemetall') !== -1;
    if (cbMilt) cbMilt.checked = (pad === 'miltelinis dažymas' || pad === 'miltelinis dazymas');
    updateMiltBlock();
  }

  if (cbKtl || cbMilt || cbPar) {
    syncPaslaugosFromFields();
    if (cbKtl) cbKtl.addEventListener('change', function () { handleKtlChange(); updateMiltBlock(); });
    if (cbPar) cbPar.addEventListener('change', function () { handleParuosimasChange(); updateMiltBlock(); });
    if (cbMilt) cbMilt.addEventListener('change', updateMiltBlock);
  }

  // --- Pakavimas: auto aprašymai ---
  var pakTipas = document.getElementById('id_pakavimo_tipas');
  var pakApr   = document.getElementById('id_pakavimas');
  if (pakTipas && pakApr) {
    var PAK_TEMPLATES = {
      'palaidas': 'Palaidas pakavimas pagal standartinę procedūrą.',
      'standartinis': 'Standartinis pakavimas: kartoninė dėžė, apsauga nuo pažeidimų.',
      'geras': 'Pagerintas pakavimas su papildoma apsauga ir atskyrimu.',
      'individualus': 'Individualus pakavimas pagal kliento poreikius.'
    };
    pakTipas.addEventListener('change', function () {
      var val = pakTipas.value;
      var tmpl = PAK_TEMPLATES[val];
      if (tmpl && !pakApr.value.trim()) pakApr.value = tmpl;
    });
  }

  // --- Maskavimas: auto aprašymai ---
  var masTipas = document.getElementById('id_maskavimo_tipas');
  var masApr   = document.getElementById('id_maskavimas');
  if (masTipas && masApr) {
    var MAS_TEMPLATES = {
      'iprastas': 'Įprastas maskavimas pagal standartinę schemą.',
      'specialus': 'Specialus maskavimas pagal atskirą susitarimą ir brėžinio nurodymus.'
    };
    masTipas.addEventListener('change', function () {
      var val = masTipas.value;
      var tmpl = MAS_TEMPLATES[val];
      if (tmpl && !masApr.value.trim()) masApr.value = tmpl;
    });
  }
});
</script>
{% endblock %}
