{# pozicijos/templates/pozicijos/form.html #}
{% extends "base.html" %}

{% block title %}
  {% if pozicija %}Redaguoti poziciją {{ pozicija.poz_kodas }}{% else %}Nauja pozicija{% endif %}
{% endblock %}

{% block page_css %}
<style>
  .poz-form-page { background:#f3f3f3; }
  .poz-form-container { max-width:1200px; margin:0 auto; padding:16px 20px 32px; }

  .poz-header { display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom:12px; }
  .poz-title { margin:0; font-size:1.35rem; font-weight:700; }
  .poz-subtitle{ margin-top:4px; color:#6b7280; font-size:0.9rem; }

  .poz-actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .btn{ border:1px solid #d1d5db; background:#fff; padding:7px 12px; border-radius:8px; cursor:pointer; text-decoration:none; color:#111827; font-size:0.9rem; }
  .btn-primary{ background:#111827; color:#fff; border-color:#111827; }
  .btn-secondary{ background:#fff; }
  .btn:hover{ filter:brightness(0.98); }

  .poz-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 980px){
    .poz-grid{ grid-template-columns:1fr; }
  }

  .poz-card{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:12px 12px 10px;
    box-shadow:0 1px 0 rgba(0,0,0,0.03);
  }
  .poz-card--full{ grid-column:1 / -1; }
  .poz-card-title{
    margin:0 0 10px;
    font-size:1rem;
    font-weight:700;
    border-bottom:1px solid #f3f4f6;
    padding-bottom:6px;
  }

  .field-row{ display:grid; grid-template-columns: 220px 1fr; gap:10px; align-items:flex-start; margin:8px 0; }
  .field-label{ color:#374151; font-size:0.88rem; padding-top:6px; }
  .field-control input[type="text"],
  .field-control input[type="number"],
  .field-control input[type="date"],
  .field-control select,
  .field-control textarea{
    width:100%;
    border:1px solid #d1d5db;
    border-radius:8px;
    box-sizing:border-box;
    padding:4px 6px;
    font-size:0.9rem;
  }
  .field-control input[type="checkbox"]{ width:auto; padding:0; }

  .field-errors{ margin-top:2px; font-size:0.8rem; color:#b91c1c; }
  .field-help{ font-size:0.78rem; color:#9ca3af; margin-top:2px; }

  .inline-checkboxes{ display:flex; flex-wrap:wrap; gap:12px; margin:6px 0 4px; }
  .inline-checkboxes label{ display:inline-flex; align-items:center; gap:6px; white-space:nowrap; font-size:0.9rem; cursor:pointer; }

  .subblock{ margin-top:8px; padding:8px 10px; border:1px dashed #d1d5db; border-radius:6px; background:#fff; }

  /* Maskavimo aprašymas: tik vertikaliai auga */
  textarea { resize: vertical; }
</style>
{% endblock %}

{% block content %}
<div class="poz-form-page">
  <div class="poz-form-container">

    <div class="poz-header">
      <div>
        <h1 class="poz-title">
          {% if pozicija %}Pozicija {{ pozicija.poz_kodas|default:pozicija.id }}{% else %}Nauja pozicija{% endif %}
        </h1>
        <div class="poz-subtitle">Redagavimo forma.</div>
      </div>

      <div class="poz-actions">
        <a class="btn btn-secondary" href="{% url 'pozicijos:list' %}">Grįžti</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="poz-card" style="border-color:#fecaca;background:#fff1f2;">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="poz-grid">

      <section class="poz-card">
        <h2 class="poz-card-title">Pagrindiniai</h2>

        <div class="field-row">
          <div class="field-label">{{ form.klientas.label }}</div>
          <div class="field-control">
            {{ form.klientas }}
            {% if form.klientas.errors %}<div class="field-errors">{{ form.klientas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.projektas.label }}</div>
          <div class="field-control">
            {{ form.projektas }}
            {% if form.projektas.errors %}<div class="field-errors">{{ form.projektas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.poz_kodas.label }}</div>
          <div class="field-control">
            {{ form.poz_kodas }}
            {% if form.poz_kodas.errors %}<div class="field-errors">{{ form.poz_kodas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.poz_pavad.label }}</div>
          <div class="field-control">
            {{ form.poz_pavad }}
            {% if form.poz_pavad.errors %}<div class="field-errors">{{ form.poz_pavad.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Detalė</h2>

        <div class="field-row">
          <div class="field-label">{{ form.metalas.label }}</div>
          <div class="field-control">
            {{ form.metalas }}
            {% if form.metalas.errors %}<div class="field-errors">{{ form.metalas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.plotas.label }}</div>
          <div class="field-control">
            {{ form.plotas }}
            {% if form.plotas.errors %}<div class="field-errors">{{ form.plotas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.svoris.label }}</div>
          <div class="field-control">
            {{ form.svoris }}
            {% if form.svoris.errors %}<div class="field-errors">{{ form.svoris.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        {# Matmenys XYZ (mm) - NAUJA #}
        <div class="field-row">
          <div class="field-label">{{ form.x_mm.label }}</div>
          <div class="field-control">
            {{ form.x_mm }}
            {% if form.x_mm.errors %}<div class="field-errors">{{ form.x_mm.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.y_mm.label }}</div>
          <div class="field-control">
            {{ form.y_mm }}
            {% if form.y_mm.errors %}<div class="field-errors">{{ form.y_mm.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.z_mm.label }}</div>
          <div class="field-control">
            {{ form.z_mm }}
            {% if form.z_mm.errors %}<div class="field-errors">{{ form.z_mm.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">Matmenys (xyz)</div>
          <div class="field-control">
            <div id="matmenys-xyz-preview" style="padding-top:6px;">
              {% if pozicija %}{{ pozicija.matmenys_xyz }}{% else %}—{% endif %}
            </div>
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Kabinimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.kabinimo_budas.label }}</div>
          <div class="field-control">
            {{ form.kabinimo_budas }}
            {% if form.kabinimo_budas.errors %}<div class="field-errors">{{ form.kabinimo_budas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.kabinimas_reme.label }}</div>
          <div class="field-control">
            {{ form.kabinimas_reme }}
            {% if form.kabinimas_reme.errors %}<div class="field-errors">{{ form.kabinimas_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.detaliu_kiekis_reme.label }}</div>
          <div class="field-control">
            {{ form.detaliu_kiekis_reme }}
            {% if form.detaliu_kiekis_reme.errors %}<div class="field-errors">{{ form.detaliu_kiekis_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.faktinis_kiekis_reme.label }}</div>
          <div class="field-control">
            {{ form.faktinis_kiekis_reme }}
            {% if form.faktinis_kiekis_reme.errors %}<div class="field-errors">{{ form.faktinis_kiekis_reme.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Paslauga</h2>

        <div class="inline-checkboxes">
          <label>{{ form.paslauga_ktl }} <span>{{ form.paslauga_ktl.label }}</span></label>
          <label>{{ form.paslauga_miltai }} <span>{{ form.paslauga_miltai.label }}</span></label>
          <label>{{ form.paslauga_paruosimas }} <span>{{ form.paslauga_paruosimas.label }}</span></label>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.paruosimas.label }}</div>
          <div class="field-control">
            {{ form.paruosimas }}
            {% if form.paruosimas.errors %}<div class="field-errors">{{ form.paruosimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.padengimas.label }}</div>
          <div class="field-control">
            {{ form.padengimas }}
            {% if form.padengimas.errors %}<div class="field-errors">{{ form.padengimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.padengimo_standartas.label }}</div>
          <div class="field-control">
            {{ form.padengimo_standartas }}
            {% if form.padengimo_standartas.errors %}<div class="field-errors">{{ form.padengimo_standartas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.padengimo_storis_um.label }}</div>
          <div class="field-control">
            {{ form.padengimo_storis_um }}
            {% if form.padengimo_storis_um.errors %}<div class="field-errors">{{ form.padengimo_storis_um.errors|striptags }}</div>{% endif %}
            <div class="field-help">µm (mikronai), pvz. 60.00–120.00</div>
          </div>
        </div>


        <div class="field-row" id="row-spalva-top">
          <div class="field-label">{{ form.spalva.label }}</div>
          <div class="field-control">
            {{ form.spalva }}
            {% if form.spalva.errors %}<div class="field-errors">{{ form.spalva.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div id="miltai-subblock" class="subblock" style="display:none;">
          <div class="field-row">
            <div class="field-label">{{ form.miltu_kodas.label }}</div>
            <div class="field-control">
              {{ form.miltu_kodas }}
              {% if form.miltu_kodas.errors %}<div class="field-errors">{{ form.miltu_kodas.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_spalva.label }}</div>
            <div class="field-control">
              {{ form.miltu_spalva }}
              {% if form.miltu_spalva.errors %}<div class="field-errors">{{ form.miltu_spalva.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_tiekejas.label }}</div>
            <div class="field-control">
              {{ form.miltu_tiekejas }}
              {% if form.miltu_tiekejas.errors %}<div class="field-errors">{{ form.miltu_tiekejas.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_blizgumas.label }}</div>
            <div class="field-control">
              {{ form.miltu_blizgumas }}
              {% if form.miltu_blizgumas.errors %}<div class="field-errors">{{ form.miltu_blizgumas.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="field-row">
            <div class="field-label">{{ form.miltu_kaina.label }}</div>
            <div class="field-control">
              {{ form.miltu_kaina }}
              {% if form.miltu_kaina.errors %}<div class="field-errors">{{ form.miltu_kaina.errors|striptags }}</div>{% endif %}
            </div>
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.paslaugu_pastabos.label }}</div>
          <div class="field-control">
            {{ form.paslaugu_pastabos }}
            {% if form.paslaugu_pastabos.errors %}<div class="field-errors">{{ form.paslaugu_pastabos.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Maskavimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.maskavimo_tipas.label }}</div>
          <div class="field-control">
            {{ form.maskavimo_tipas }}
            {% if form.maskavimo_tipas.errors %}<div class="field-errors">{{ form.maskavimo_tipas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row" id="maskavimas-row" style="display:none;">
          <div class="field-label">{{ form.maskavimas.label }}</div>
          <div class="field-control">
            {{ form.maskavimas }}
            {% if form.maskavimas.errors %}<div class="field-errors">{{ form.maskavimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Terminai</h2>
        <div class="field-row">
          <div class="field-label">{{ form.atlikimo_terminas.label }}</div>
          <div class="field-control">
            {{ form.atlikimo_terminas }}
            {% if form.atlikimo_terminas.errors %}<div class="field-errors">{{ form.atlikimo_terminas.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Testai / kokybė</h2>
        <div class="field-row">
          <div class="field-label">{{ form.testai_kokybe.label }}</div>
          <div class="field-control">
            {{ form.testai_kokybe }}
            {% if form.testai_kokybe.errors %}<div class="field-errors">{{ form.testai_kokybe.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Pakavimas</h2>

        <div class="field-row">
          <div class="field-label">{{ form.pakavimo_tipas.label }}</div>
          <div class="field-control">
            {{ form.pakavimo_tipas }}
            {% if form.pakavimo_tipas.errors %}<div class="field-errors">{{ form.pakavimo_tipas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.pakavimas.label }}</div>
          <div class="field-control">
            {{ form.pakavimas }}
            {% if form.pakavimas.errors %}<div class="field-errors">{{ form.pakavimas.errors|striptags }}</div>{% endif %}
          </div>
        </div>

        <div class="field-row">
          <div class="field-label">{{ form.instrukcija.label }}</div>
          <div class="field-control">
            {{ form.instrukcija }}
            {% if form.instrukcija.errors %}<div class="field-errors">{{ form.instrukcija.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

      <section class="poz-card">
        <h2 class="poz-card-title">Papildomos paslaugos</h2>

        <div class="field-row">
          <div class="field-label">{{ form.papildomos_paslaugos.label }}</div>
          <div class="field-control">
            {{ form.papildomos_paslaugos }}
            {% if form.papildomos_paslaugos.errors %}<div class="field-errors">{{ form.papildomos_paslaugos.errors|striptags }}</div>{% endif %}
            <div class="field-help">Pasirinkus „Yra“ – atsiras aprašymo laukas.</div>
          </div>
        </div>

        <div class="field-row" id="papildomos-paslaugos-aprasymas-row" style="display:none;">
          <div class="field-label">{{ form.papildomos_paslaugos_aprasymas.label }}</div>
          <div class="field-control">
            {{ form.papildomos_paslaugos_aprasymas }}
            {% if form.papildomos_paslaugos_aprasymas.errors %}<div class="field-errors">{{ form.papildomos_paslaugos_aprasymas.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>


      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Kainos</h2>
        {% if pozicija and pozicija.pk %}
          {% include "pozicijos/components/kainos_formset.html" with formset=kainos_formset show_history_links=1 %}
        {% else %}
          {% include "pozicijos/components/kainos_formset.html" with formset=kainos_formset %}
        {% endif %}
      </section>

      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Pastabos</h2>
        <div class="field-row">
          <div class="field-label">{{ form.pastabos.label }}</div>
          <div class="field-control">
            {{ form.pastabos }}
            {% if form.pastabos.errors %}<div class="field-errors">{{ form.pastabos.errors|striptags }}</div>{% endif %}
          </div>
        </div>
      </section>

    </div>

    <div class="poz-actions" style="margin-top:12px;">
      <button type="submit" class="btn btn-primary">Išsaugoti</button>
    </div>

  </form>

</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {

  // --- Auto-grow textarea (pagal data-autoresize="1") ---
  function autoGrow(el) {
    if (!el) return;
    el.style.height = 'auto';
    el.style.height = (el.scrollHeight) + 'px';
  }

  document.querySelectorAll('textarea[data-autoresize="1"]').forEach(function(el){
    autoGrow(el);
    el.addEventListener('input', function(){ autoGrow(el); });
  });

  // --- Maskavimas: Yra / Nėra ---
  var masTipas = document.getElementById('id_maskavimo_tipas');
  var masRow   = document.getElementById('maskavimas-row');
  var masTxt   = document.getElementById('id_maskavimas');

  function syncMaskavimasUI() {
    if (!masTipas || !masRow) return;
    var val = (masTipas.value || '').toLowerCase();
    var show = (val === 'yra');
    masRow.style.display = show ? '' : 'none';
    if (!show && masTxt) {
      masTxt.value = '';
      autoGrow(masTxt);
    }
    if (show && masTxt) autoGrow(masTxt);
  }

  if (masTipas) masTipas.addEventListener('change', syncMaskavimasUI);

  // --- Paslauga: KTL / Miltai / Paruošimas ---
  var chkKTL = document.getElementById('id_paslauga_ktl');
  var chkMiltai = document.getElementById('id_paslauga_miltai');
  var chkPar = document.getElementById('id_paslauga_paruosimas');

  var inpPar = document.getElementById('id_paruosimas');
  var inpPad = document.getElementById('id_padengimas');
  var inpStd = document.getElementById('id_padengimo_standartas');
  var inpSpalva = document.getElementById('id_spalva');

  var miltaiBox = document.getElementById('miltai-subblock');
  var rowSpalvaTop = document.getElementById('row-spalva-top');

  function setVal(el, val) {
    if (!el) return;
    el.value = val;
  }

  function syncPaslaugosUI(changedEl) {
    if (!chkKTL || !chkMiltai || !chkPar) return;

    var ktl = !!chkKTL.checked;
    var miltai = !!chkMiltai.checked;

    // KTL ir Miltai kartu – UI lygmenyje paliekam paskutinį pasirinkimą
    if (ktl && miltai) {
      if (changedEl === chkKTL) {
        chkMiltai.checked = false;
        miltai = false;
      } else {
        chkKTL.checked = false;
        ktl = false;
      }
    }

    // Jei KTL arba Miltai – Paruošimas prisideda automatiškai
    if (ktl || miltai) {
      chkPar.checked = true;
    }

    // Tik Paruošimas -> default Gardobond 24T (tik jei tuščia)
    var parOnly = !!chkPar.checked && !ktl && !miltai;
    if (parOnly && inpPar && !((inpPar.value || '').trim())) {
      setVal(inpPar, 'Gardobond 24T');
    }

    // KTL -> automatinės reikšmės
    if (ktl) {
      if (inpPad) setVal(inpPad, 'KTL BASF CG 570');
      if (inpStd) setVal(inpStd, '');
      if (inpSpalva) setVal(inpSpalva, 'Juoda RAL 9005');
    }

    // Miltai UI: rodom subbloką, slepiam spalvą viršuje
    if (miltaiBox) miltaiBox.style.display = miltai ? '' : 'none';
    if (rowSpalvaTop) rowSpalvaTop.style.display = miltai ? 'none' : '';

    // Miltai atveju – išvalom viršutinę spalvą, kad neliktų "paslėpta"
    if (miltai && inpSpalva) setVal(inpSpalva, '');
  }

  function bind(el) {
    if (!el) return;
    el.addEventListener('change', function(){ syncPaslaugosUI(el); });
  }
  bind(chkKTL);
  bind(chkMiltai);
  bind(chkPar);

  // --- Papildomos paslaugos: Taip/Ne ---
  var ppSel = document.getElementById('id_papildomos_paslaugos');
  var ppRow = document.getElementById('papildomos-paslaugos-aprasymas-row');
  var ppTxt = document.getElementById('id_papildomos_paslaugos_aprasymas');

  function syncPapildomosPaslaugosUI() {
    if (!ppSel || !ppRow) return;
    var val = (ppSel.value || '').toLowerCase();
    var show = (val === 'taip');
    ppRow.style.display = show ? '' : 'none';
    if (!show && ppTxt) {
      ppTxt.value = '';
      autoGrow(ppTxt);
    }
    if (show && ppTxt) autoGrow(ppTxt);
  }

  if (ppSel) ppSel.addEventListener('change', syncPapildomosPaslaugosUI);

  // --- Matmenys XYZ preview (mm) ---
  var xEl = document.getElementById('id_x_mm');
  var yEl = document.getElementById('id_y_mm');
  var zEl = document.getElementById('id_z_mm');
  var xyzPreview = document.getElementById('matmenys-xyz-preview');

  function fmtDim(v) {
    v = (v || '').toString().trim();
    return v ? v : '—';
  }

  function syncXYZ() {
    if (!xyzPreview) return;

    var x = xEl ? fmtDim(xEl.value) : '—';
    var y = yEl ? fmtDim(yEl.value) : '—';
    var z = zEl ? fmtDim(zEl.value) : '—';

    if (x === '—' && y === '—' && z === '—') {
      xyzPreview.textContent = '—';
      return;
    }
    xyzPreview.textContent = x + '×' + y + '×' + z + ' mm';
  }

  if (xEl) xEl.addEventListener('input', syncXYZ);
  if (yEl) yEl.addEventListener('input', syncXYZ);
  if (zEl) zEl.addEventListener('input', syncXYZ);

  // init
  syncMaskavimasUI();
  syncPaslaugosUI(null);
  syncPapildomosPaslaugosUI();
  syncXYZ();
});
</script>

{% endblock %}
