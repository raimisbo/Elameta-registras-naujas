{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if pozicija %}
    Redaguoti poziciją {{ pozicija.poz_kodas|default:pozicija.id }}
  {% else %}
    Nauja pozicija
  {% endif %}
{% endblock %}

{% block page_css %}
<style>
  .pozicija-form-page {
    background:#f3f3f3;
  }

  .pozicija-form-page .poz-form-container {
    max-width:1200px;
    margin:0 auto;
    padding:16px 20px 32px;
  }

  .pozicija-form-page .form-header-bar {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:16px;
  }

  .pozicija-form-page .form-header-main {
    min-width:0;
  }

  .pozicija-form-page .form-header-title {
    margin:0 0 4px;
    font-size:1.35rem;
    font-weight:600;
  }

  .pozicija-form-page .form-header-sub {
    margin:0;
    font-size:0.9rem;
    color:#666;
  }

  .pozicija-form-page .form-header-actions {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    justify-content:flex-end;
  }

  .pozicija-form-page .btn-action {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    font-size:0.85rem;
    border-radius:4px;
    border:1px solid #ccc;
    background:#fff;
    color:#333;
    text-decoration:none;
    cursor:pointer;
    white-space:nowrap;
  }

  .pozicija-form-page .btn-action:hover {
    background:#f0f0f0;
  }

  .pozicija-form-page .btn-primary {
    border-color:#2563eb;
    background:#2563eb;
    color:#fff;
  }

  .pozicija-form-page .btn-primary:hover {
    background:#1d4ed8;
  }

  .pozicija-form-page .btn-secondary {
    background:#e5e7eb;
    border-color:#d1d5db;
  }

  .pozicija-form-page .poz-form-grid {
    display:grid;
    grid-template-columns:minmax(0,1.1fr) minmax(0,1fr);
    gap:16px;
    align-items:flex-start;
  }

  .pozicija-form-page .poz-form-column {
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  .pozicija-form-page fieldset.poz-fieldset {
    border:1px solid #e5e7eb;
    border-radius:6px;
    padding:10px 12px 8px;
    background:#fff;
  }

  .pozicija-form-page fieldset.poz-fieldset legend {
    padding:0 4px;
    font-size:0.9rem;
    font-weight:600;
    color:#374151;
  }

  .pozicija-form-page .poz-field-row {
    display:grid;
    grid-template-columns:minmax(0,38%) minmax(0,62%);
    column-gap:8px;
    align-items:flex-start;
    font-size:0.9rem;
    padding:3px 0;
  }

  .pozicija-form-page .poz-field-label {
    color:#555;
    padding-top:4px;
  }

  .pozicija-form-page .poz-field-widget {
    min-width:0;
  }

  .pozicija-form-page .poz-field-widget input,
  .pozicija-form-page .poz-field-widget select,
  .pozicija-form-page .poz-field-widget textarea {
    width:100%;
    box-sizing:border-box;
    padding:5px 7px;
    border-radius:4px;
    border:1px solid #d1d5db;
    font-size:0.9rem;
    font-family:inherit;
  }

  .pozicija-form-page .poz-field-widget textarea {
    min-height:70px;
    resize:vertical;
  }

  .pozicija-form-page .field-errors {
    margin-top:2px;
    font-size:0.78rem;
    color:#b91c1c;
  }

  .pozicija-form-page .non-field-errors {
    margin-bottom:12px;
    padding:8px 10px;
    border-radius:6px;
    border:1px solid #fecaca;
    background:#fef2f2;
    color:#7f1d1d;
    font-size:0.88rem;
  }

  .pozicija-form-page .form-footer {
    margin-top:20px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
  }

  .pozicija-form-page .form-footer-left {
    font-size:0.8rem;
    color:#6b7280;
  }

  .pozicija-form-page .form-footer-right {
    display:flex;
    gap:8px;
  }

  @media (max-width: 900px) {
    .pozicija-form-page .poz-form-grid {
      grid-template-columns:1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="pozicija-form-page">
  <div class="poz-form-container">
    <div class="form-header-bar">
      <div class="form-header-main">
        <h1 class="form-header-title">
          {% if pozicija %}
            Redaguoti poziciją
            {% if pozicija.poz_kodas %}{{ pozicija.poz_kodas }}{% else %}#{{ pozicija.id }}{% endif %}
          {% else %}
            Nauja pozicija
          {% endif %}
        </h1>
        {% if pozicija %}
          <p class="form-header-sub">
            Klientas: {{ pozicija.klientas|default:"—" }}{% if pozicija.projektas %} · Projektas: {{ pozicija.projektas }}{% endif %}
          </p>
        {% endif %}
      </div>
      <div class="form-header-actions">
        {% if pozicija %}
          <a href="{% url 'pozicijos:detail' pozicija.id %}" class="btn-action btn-secondary">Atgal į poziciją</a>
        {% else %}
          <a href="{% url 'pozicijos:list' %}" class="btn-action btn-secondary">Atgal į sąrašą</a>
        {% endif %}
      </div>
    </div>

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="non-field-errors">
          {% for err in form.non_field_errors %}
            <div>{{ err }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="poz-form-grid">
        <div class="poz-form-column">

          {# 1. Pagrindinė informacija #}
          <fieldset class="poz-fieldset">
            <legend>Pagrindinė informacija</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.klientas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.klientas }}
                {% if form.klientas.errors %}
                  <div class="field-errors">
                    {% for e in form.klientas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.projektas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.projektas }}
                {% if form.projektas.errors %}
                  <div class="field-errors">
                    {% for e in form.projektas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.poz_kodas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.poz_kodas }}
                {% if form.poz_kodas.errors %}
                  <div class="field-errors">
                    {% for e in form.poz_kodas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.poz_pavad.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.poz_pavad }}
                {% if form.poz_pavad.errors %}
                  <div class="field-errors">
                    {% for e in form.poz_pavad.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

          {# 2. Specifikacija #}
          <fieldset class="poz-fieldset">
            <legend>Specifikacija</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.metalas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.metalas }}
                {% if form.metalas.errors %}
                  <div class="field-errors">
                    {% for e in form.metalas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.plotas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.plotas }}
                {% if form.plotas.errors %}
                  <div class="field-errors">
                    {% for e in form.plotas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.svoris.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.svoris }}
                {% if form.svoris.errors %}
                  <div class="field-errors">
                    {% for e in form.svoris.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.testai_kokybe.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.testai_kokybe }}
                {% if form.testai_kokybe.errors %}
                  <div class="field-errors">
                    {% for e in form.testai_kokybe.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

          {# 3. Kabinimas #}
          <fieldset class="poz-fieldset">
            <legend>Kabinimas</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.kabinimo_budas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.kabinimo_budas }}
                {% if form.kabinimo_budas.errors %}
                  <div class="field-errors">
                    {% for e in form.kabinimo_budas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.kabinimas_reme.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.kabinimas_reme }}
                {% if form.kabinimas_reme.errors %}
                  <div class="field-errors">
                    {% for e in form.kabinimas_reme.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.detaliu_kiekis_reme.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.detaliu_kiekis_reme }}
                {% if form.detaliu_kiekis_reme.errors %}
                  <div class="field-errors">
                    {% for e in form.detaliu_kiekis_reme.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.faktinis_kiekis_reme.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.faktinis_kiekis_reme }}
                {% if form.faktinis_kiekis_reme.errors %}
                  <div class="field-errors">
                    {% for e in form.faktinis_kiekis_reme.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

          {# 4. Paslauga (buvęs "Paviršius / dažymas") #}
          <fieldset class="poz-fieldset">
            <legend>Paslauga</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.paruosimas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.paruosimas }}
                {% if form.paruosimas.errors %}
                  <div class="field-errors">
                    {% for e in form.paruosimas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.padengimas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.padengimas }}
                {% if form.padengimas.errors %}
                  <div class="field-errors">
                    {% for e in form.padengimas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.padengimo_standartas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.padengimo_standartas }}
                {% if form.padengimo_standartas.errors %}
                  <div class="field-errors">
                    {% for e in form.padengimo_standartas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.spalva.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.spalva }}
                {% if form.spalva.errors %}
                  <div class="field-errors">
                    {% for e in form.spalva.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

        </div>

        <div class="poz-form-column">

          {# 5. Maskavimas – atskiras blokas #}
          <fieldset class="poz-fieldset">
            <legend>Maskavimas</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.maskavimas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.maskavimas }}
                {% if form.maskavimas.errors %}
                  <div class="field-errors">
                    {% for e in form.maskavimas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

          {# 6. Terminai #}
          <fieldset class="poz-fieldset">
            <legend>Terminai</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.atlikimo_terminas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.atlikimo_terminas }}
                {% if form.atlikimo_terminas.errors %}
                  <div class="field-errors">
                    {% for e in form.atlikimo_terminas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

          {# 7. Pakavimas #}
          <fieldset class="poz-fieldset">
            <legend>Pakavimas</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.pakavimas.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.pakavimas }}
                {% if form.pakavimas.errors %}
                  <div class="field-errors">
                    {% for e in form.pakavimas.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.instrukcija.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.instrukcija }}
                {% if form.instrukcija.errors %}
                  <div class="field-errors">
                    {% for e in form.instrukcija.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.pakavimo_dienos_norma.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.pakavimo_dienos_norma }}
                {% if form.pakavimo_dienos_norma.errors %}
                  <div class="field-errors">
                    {% for e in form.pakavimo_dienos_norma.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.pak_po_ktl.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.pak_po_ktl }}
                {% if form.pak_po_ktl.errors %}
                  <div class="field-errors">
                    {% for e in form.pak_po_ktl.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.pak_po_milt.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.pak_po_milt }}
                {% if form.pak_po_milt.errors %}
                  <div class="field-errors">
                    {% for e in form.pak_po_milt.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

          {# 8. Kaina #}
          <fieldset class="poz-fieldset">
            <legend>Kaina</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.kaina_eur.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.kaina_eur }}
                {% if form.kaina_eur.errors %}
                  <div class="field-errors">
                    {% for e in form.kaina_eur.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

          {# 9. Pastabos #}
          <fieldset class="poz-fieldset">
            <legend>Pastabos</legend>
            <div class="poz-field-row">
              <div class="poz-field-label">{{ form.pastabos.label_tag }}</div>
              <div class="poz-field-widget">
                {{ form.pastabos }}
                {% if form.pastabos.errors %}
                  <div class="field-errors">
                    {% for e in form.pastabos.errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </fieldset>

        </div>
      </div>

      <div class="form-footer">
        <div class="form-footer-left">
          {% if pozicija %}
            Sukurta: {% if pozicija.created %}{{ pozicija.created|date:"Y-m-d H:i" }}{% else %}—{% endif %},
            atnaujinta: {% if pozicija.updated %}{{ pozicija.updated|date:"Y-m-d H:i" }}{% else %}—{% endif %}
          {% else %}
            Nauja pozicija (dar neišsaugota)
          {% endif %}
        </div>
        <div class="form-footer-right">
          {% if pozicija %}
            <a href="{% url 'pozicijos:detail' pozicija.id %}" class="btn-action btn-secondary">Atšaukti</a>
          {% else %}
            <a href="{% url 'pozicijos:list' %}" class="btn-action btn-secondary">Atšaukti</a>
          {% endif %}
          <button type="submit" class="btn-action btn-primary">Išsaugoti</button>
        </div>
      </div>
    </form>

    {# Datalist'ai iš suggestions – kad veiktų pasiūlymai #}
    {% if suggestions %}
      {% for field_name, values in suggestions.items %}
        <datalist id="suggest-{{ field_name }}">
          {% for v in values %}
            <option value="{{ v }}"></option>
          {% endfor %}
        </datalist>
      {% endfor %}
    {% endif %}
  </div>
</div>
{% endblock %}
