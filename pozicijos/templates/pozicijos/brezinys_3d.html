{% load static %}
<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8">
  <title>3D peržiūra – {{ brezinys.pavadinimas|default:brezinys.filename }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    html, body { height: 100%; margin: 0; background: #0b1220; color: #e5e7eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif; }

    .topbar {
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      background: #111827;
      border-bottom: 1px solid rgba(255,255,255,.08);
      box-sizing: border-box;
      gap: 12px;
    }

    .topbar .left, .topbar .right { display:flex; gap:10px; align-items:center; }
    .topbar .title { min-width: 0; text-align: center; flex: 1; }
    .topbar .title .main { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .topbar .title .sub  { font-size: 12px; opacity: .8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .ui-btn, .ui-link {
      color: #93c5fd;
      text-decoration: none;
      font-size: 13px;
      border: 1px solid rgba(147,197,253,.35);
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      background: transparent;
      cursor: pointer;
      user-select: none;
    }
    .ui-btn:hover, .ui-link:hover { background: rgba(147,197,253,.08); }
    .ui-btn.is-on {
      background: rgba(147,197,253,.10);
      border-color: rgba(147,197,253,.60);
    }

    #viewer {
      height: calc(100vh - 52px);
      width: 100%;
    }

    /* Status box */
    #status {
      position: fixed;
      left: 12px;
      bottom: 12px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      max-width: min(720px, calc(100vw - 24px));
      display: none;
      white-space: pre-wrap;
      z-index: 9999;
    }

    /* Measure overlay (markers + line) */
    #measureOverlay {
      position: fixed;
      left: 0;
      top: 52px;
      width: 100vw;
      height: calc(100vh - 52px);
      pointer-events: none;
      display: none;
      z-index: 9000;
    }

    .mpt {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(147,197,253,.85);
      border: 2px solid rgba(255,255,255,.75);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25);
      transform: translate(-9999px, -9999px);
    }

    #measureSvg {
      position:absolute;
      left:0; top:0;
      width:100%;
      height:100%;
    }
  </style>

  <script src="{% static 'pozicijos/js/o3dv.min.js' %}"></script>
  <script>
    const STEP_MODEL_URL = "{{ brezinys.failas.url|escapejs }}";

    // Jei vienetai “ne tie” – koreguok čia:
    // Pvz. jei modelio vienetai yra mm, palik 1.0 ir "mm".
    // Jei nori metrais iš mm: scale = 0.001, unit = "m".
    const MEASURE_SCALE = 1.0;
    const MEASURE_UNIT  = "mm";

    function setStatus(msg, show = true) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.display = show ? 'block' : 'none';
    }

    function fmt(n, d=3) {
      if (typeof n !== 'number' || !isFinite(n)) return String(n);
      return n.toFixed(d);
    }

    function dist3(a, b) {
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const dz = b.z - a.z;
      return Math.sqrt(dx*dx + dy*dy + dz*dz);
    }

    window.addEventListener('load', () => {
      const OVNS = window.OV || (typeof OV !== 'undefined' ? OV : null);
      if (!OVNS) {
        setStatus("O3DV nepasiekiamas: nerastas global OV.\nPatikrink, ar /static/pozicijos/js/o3dv.min.js tikrai užsikrauna be JS klaidų.");
        return;
      }
      if (!OVNS.EmbeddedViewer) {
        setStatus("O3DV įkeltas, bet nerastas OV.EmbeddedViewer.\nTai reiškia, kad o3dv.min.js build'as ne tas, kurio tikisi šitas šablonas.");
        return;
      }
      if (!STEP_MODEL_URL) {
        setStatus("Tuščias STEP_MODEL_URL (brezinys.failas.url). Patikrink, ar brėžiniui priskirtas failas.");
        return;
      }

      const parent = document.getElementById('viewer');
      const overlay = document.getElementById('measureOverlay');
      const p1el = document.getElementById('mpt1');
      const p2el = document.getElementById('mpt2');
      const line = document.getElementById('mline');

      let isLoaded = false;

      // Measure state
      let measureOn = false;
      let P1 = null, P2 = null;          // 3D points {x,y,z}
      let S1 = null, S2 = null;          // screen points {x,y} (local canvas coords)
      let innerViewer = null;
      let navigation = null;

      function showOverlay(on) {
        overlay.style.display = on ? 'block' : 'none';
      }

      function setMarker(el, s) {
        if (!s) {
          el.style.transform = 'translate(-9999px, -9999px)';
          return;
        }
        el.style.transform = `translate(${s.x}px, ${s.y}px) translate(-5px, -5px)`;
      }

      function setLine(a, b) {
        if (!a || !b) {
          line.setAttribute('x1', '-9999');
          line.setAttribute('y1', '-9999');
          line.setAttribute('x2', '-9999');
          line.setAttribute('y2', '-9999');
          return;
        }
        line.setAttribute('x1', String(a.x));
        line.setAttribute('y1', String(a.y));
        line.setAttribute('x2', String(b.x));
        line.setAttribute('y2', String(b.y));
      }

      function clearMeasure(keepMode=false) {
        P1 = null; P2 = null;
        S1 = null; S2 = null;
        setMarker(p1el, null);
        setMarker(p2el, null);
        setLine(null, null);

        const btnClear = document.getElementById('btnClear');
        btnClear.style.display = (measureOn ? 'inline-block' : 'none');

        if (keepMode && measureOn) {
          setStatus("Matavimas: spausk 1 tašką ant modelio, tada 2 tašką.\nESC – išjungti. \"Išvalyti\" – nuvalyti.");
        } else if (!measureOn) {
          setStatus("", false);
        }
      }

      function setMeasureMode(on) {
        measureOn = on;

        const btn = document.getElementById('btnMeasure');
        const btnClear = document.getElementById('btnClear');

        btn.classList.toggle('is-on', measureOn);
        btnClear.style.display = measureOn ? 'inline-block' : 'none';

        if (measureOn) {
          showOverlay(true);
          clearMeasure(true);
        } else {
          showOverlay(false);
          clearMeasure(false);
        }
      }

      function onMeasureClick(button, mouseCoords) {
        // mouseCoords yra local canvas coords (Coord2D su x/y)
        if (!measureOn) {
          // jei ateityje turėsi kažkokį click handlerį – čia galima būtų jį kviesti
          return;
        }

        // tik kairys pelės mygtukas
        if (button !== 1) {
          return;
        }

        if (!isLoaded || !innerViewer) {
          setStatus("Modelis dar kraunasi… palauk, kol užsikraus.");
          return;
        }

        // Paimam sankirtą su modeliu (mesh + line)
        let isect = null;
        try {
          // Viewer klasė turi GetMeshIntersectionUnderMouse
          isect = innerViewer.GetMeshIntersectionUnderMouse(OVNS.IntersectionMode.MeshAndLine, mouseCoords);
        } catch (e) {
          setStatus("Nepavyko atlikti picking (GetMeshIntersectionUnderMouse).\n" + (e && e.message ? e.message : String(e)));
          return;
        }

        if (!isect || !isect.point) {
          setStatus("Nepataikei ant modelio. Bandyk spustelėti ant geometrijos (ne fone).");
          return;
        }

        // 3D taškas (THREE.Vector3) -> plain object
        const pt = { x: isect.point.x, y: isect.point.y, z: isect.point.z };

        // Ekrano koordinatės overlay’ui: naudojam mouseCoords (local coords)
        const sc = { x: mouseCoords.x, y: mouseCoords.y };

        if (!P1) {
          P1 = pt; S1 = sc;
          setMarker(p1el, S1);
          setStatus(
            "Matavimas: pasirinktas 1 taškas.\n" +
            `P1: X=${fmt(P1.x)} Y=${fmt(P1.y)} Z=${fmt(P1.z)}\n` +
            "Dabar spausk 2 tašką."
          );
          return;
        }

        if (!P2) {
          P2 = pt; S2 = sc;
          setMarker(p2el, S2);
          setLine(S1, S2);

          const d = dist3(P1, P2);
          const dScaled = d * MEASURE_SCALE;

          setStatus(
            "Matavimas: parinkti 2 taškai.\n" +
            `Atstumas: ${fmt(dScaled, 2)} ${MEASURE_UNIT} (raw: ${fmt(d, 6)})\n\n` +
            `P1: X=${fmt(P1.x)} Y=${fmt(P1.y)} Z=${fmt(P1.z)}\n` +
            `P2: X=${fmt(P2.x)} Y=${fmt(P2.y)} Z=${fmt(P2.z)}\n\n` +
            "\"Išvalyti\" – naujam matavimui. ESC – išjungti matavimą."
          );
          return;
        }

        // Jei jau turim 2 taškus – trečias click pradeda iš naujo (patogu)
        clearMeasure(true);
        P1 = pt; S1 = sc;
        setMarker(p1el, S1);
        setStatus(
          "Matavimas: pasirinktas 1 taškas.\n" +
          `P1: X=${fmt(P1.x)} Y=${fmt(P1.y)} Z=${fmt(P1.z)}\n` +
          "Dabar spausk 2 tašką."
        );
      }

      try {
        const embedded = new OVNS.EmbeddedViewer(parent, {
          backgroundColor : new OVNS.RGBAColor(11, 18, 32, 255),
          defaultColor    : new OVNS.RGBColor(200, 200, 200),
          onModelLoaded: () => {
            isLoaded = true;
            if (measureOn) {
              setStatus("Matavimas: spausk 1 tašką ant modelio, tada 2 tašką.\nESC – išjungti. \"Išvalyti\" – nuvalyti.");
            } else {
              setStatus("", false);
            }
          },
          onModelLoadFailed: () => {
            setStatus("Nepavyko užkrauti modelio.\nPatikrink /static/pozicijos/o3dv/ext/occt-import-js/ (worker/wasm) ir ar STEP failas pasiekiamas.");
          }
        });

        // Užkrovimas
        embedded.LoadModelFromUrlList([STEP_MODEL_URL]);

        // Prieigos taškai
        innerViewer = embedded.GetViewer();      // Viewer
        navigation = innerViewer.navigation;     // Navigation

        // Įstatom click handlerį per Navigation (naudojam jų click detector)
        const prevClick = navigation.onMouseClick;
        navigation.SetMouseClickHandler((button, mouseCoords) => {
          // jei matavimas išjungtas – atiduodam ankstesniam handleriui (jei buvo)
          if (!measureOn) {
            if (typeof prevClick === 'function') prevClick(button, mouseCoords);
            return;
          }
          onMeasureClick(button, mouseCoords);
        });

        // Resize
        window.addEventListener('resize', () => {
          try { embedded.Resize(); } catch (e) {}
        });

        // UI mygtukai
        document.getElementById('btnMeasure').addEventListener('click', () => {
          setMeasureMode(!measureOn);
        });
        document.getElementById('btnClear').addEventListener('click', () => {
          clearMeasure(true);
        });

        // ESC – išjungti matavimą
        window.addEventListener('keydown', (ev) => {
          if (ev.key === 'Escape' && measureOn) {
            setMeasureMode(false);
          }
        });

        // Start state
        setMeasureMode(false);
      } catch (e) {
        setStatus("Klaida inicijuojant 3D peržiūrą:\n" + (e && e.message ? e.message : String(e)));
      }
    });
  </script>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <a class="ui-link" href="{% url 'pozicijos:detail' pozicija.id %}">Atgal</a>
    </div>

    <div class="title">
      <div class="main">{{ pozicija.poz_kodas }} – {{ pozicija.poz_pavad|default:"Be pavadinimo" }}</div>
      <div class="sub">{{ brezinys.pavadinimas|default:brezinys.filename }}</div>
    </div>

    <div class="right">
      <button id="btnClear" class="ui-btn" type="button" style="display:none;">Išvalyti</button>
      <button id="btnMeasure" class="ui-btn" type="button">Matuoti</button>
      <a class="ui-link" href="{{ brezinys.failas.url }}" target="_blank" rel="noopener">Atsisiųsti</a>
    </div>
  </div>

  <div id="viewer"></div>

  <!-- Overlay: markeriai + linija -->
  <div id="measureOverlay">
    <svg id="measureSvg" xmlns="http://www.w3.org/2000/svg">
      <line id="mline" x1="-9999" y1="-9999" x2="-9999" y2="-9999"
            stroke="rgba(147,197,253,.95)" stroke-width="2" />
    </svg>
    <div id="mpt1" class="mpt"></div>
    <div id="mpt2" class="mpt"></div>
  </div>

  <div id="status"></div>
</body>
</html>
