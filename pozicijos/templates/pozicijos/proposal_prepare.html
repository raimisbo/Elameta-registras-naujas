{# pozicijos/templates/pozicijos/proposal_prepare.html #}
{% extends "base.html" %}

{% block title %}Pasiūlymo paruošimas – {{ pozicija.poz_kodas }}{% endblock %}

{% block content %}
<h1>Pasiūlymo paruošimas</h1>

<p>
  Pozicija: <strong>{{ pozicija.poz_kodas }}</strong> — {{ pozicija.poz_pavad }}
</p>

<form id="proposal-form" method="get" action="">
  <div class="box" style="max-width:520px;display:flex;flex-direction:column;gap:12px">

    <label style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" name="show_prices" value="1"
             {% if show_prices %}checked{% endif %}>
      Rodyti kainas
    </label>

    <label style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" name="show_drawings" value="1"
             {% if show_drawings %}checked{% endif %}>
      Rodyti brėžinių miniatiūras
    </label>

    <label>
      Pastabos:<br>
      <textarea name="notes" rows="4" style="width:100%">{{ notes }}</textarea>
    </label>

    <div style="display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;">
      <a href="{% url 'pozicijos:detail' pozicija.pk %}" class="btn btn-secondary">Atgal</a>

      {# Mygtuko „Atnaujinti“ NEBĖRA – varnelės persiunčia formą automatiškai #}

      <a href="#" class="btn btn-secondary"
         id="btn-preview-html"
         data-base-url="{% url 'pozicijos:pdf' pozicija.pk %}">
        Peržiūra (HTML)
      </a>
      <a href="#" class="btn"
         id="btn-pdf"
         data-base-url="{% url 'pozicijos:pdf' pozicija.pk %}">
        PDF
      </a>
    </div>
  </div>
</form>
{% endblock %}

{% block page_js %}
<script>
  (function() {
    const form = document.getElementById('proposal-form');
    if (!form) return;

    const notesField = form.querySelector('textarea[name="notes"]');
    const showPricesField = form.querySelector('input[name="show_prices"]');
    const showDrawingsField = form.querySelector('input[name="show_drawings"]');

    function buildParams() {
      const params = new URLSearchParams();

      if (showPricesField && showPricesField.checked) {
        params.set('show_prices', '1');
      }
      if (showDrawingsField && showDrawingsField.checked) {
        params.set('show_drawings', '1');
      }
      if (notesField) {
        const notesVal = notesField.value.trim();
        if (notesVal) {
          params.set('notes', notesVal);
        }
      }
      return params.toString();
    }

    // automatinis submit, kai keičiasi varnelės
    form.addEventListener('change', function (e) {
      const t = e.target;
      if (!t || !t.name) return;
      if (t.name === 'show_prices' || t.name === 'show_drawings') {
        form.submit();
      }
    });

    function attachButton(id, extraParam) {
      const btn = document.getElementById(id);
      if (!btn) return;
      const baseUrl = btn.getAttribute('data-base-url');
      if (!baseUrl) return;

      btn.addEventListener('click', function (e) {
        e.preventDefault();

        const qsStr = buildParams();
        const finalParams = new URLSearchParams(qsStr);

        if (extraParam) {
          Object.keys(extraParam).forEach(function (key) {
            finalParams.set(key, extraParam[key]);
          });
        }

        let url = baseUrl;
        const finalQs = finalParams.toString();
        if (finalQs) {
          url += '?' + finalQs;
        }
        window.location.href = url;
      });
    }

    attachButton('btn-preview-html', {preview: '1'});
    attachButton('btn-pdf', null);
  })();
</script>
{% endblock %}
