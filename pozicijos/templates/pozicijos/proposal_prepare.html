{# pozicijos/templates/pozicijos/proposal_prepare.html #}
{% extends "base.html" %}

{% block title %}Pasiūlymo paruošimas – {{ pozicija.poz_kodas }}{% endblock %}

{% block content %}
<h1>Pasiūlymo paruošimas</h1>

<p>
  Pozicija: <strong>{{ pozicija.poz_kodas }}</strong> — {{ pozicija.poz_pavad }}
</p>

<form id="proposal-form" method="get" action="">
  <div class="box" style="max-width:520px;display:flex;flex-direction:column;gap:12px">

    <label style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" name="show_prices" value="1"
             {% if show_prices %}checked{% endif %}>
      Rodyti kainas
    </label>

    <label style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" name="show_drawings" value="1"
             {% if show_drawings %}checked{% endif %}>
      Rodyti brėžinių miniatiūras
    </label>

    <label>
      Pastabos:<br>
      <textarea name="notes" rows="4" style="width:100%">{{ notes }}</textarea>
    </label>

    <div style="display:flex;gap:10px;margin-top:4px;flex-wrap:wrap;">
      <a href="{% url 'pozicijos:detail' pozicija.pk %}" class="btn btn-secondary">Atgal</a>

      {# Mygtuko „Atnaujinti“ NEBĖRA – varnelės persiunčia formą automatiškai #}

      {% if qs %}
        <a class="btn btn-secondary"
           href="{% url 'pozicijos:pdf' pozicija.pk %}?{{ qs }}&preview=1">
          Peržiūra (HTML)
        </a>
        <a class="btn"
           href="{% url 'pozicijos:pdf' pozicija.pk %}?{{ qs }}">
          PDF
        </a>
      {% else %}
        <a class="btn btn-secondary"
           href="{% url 'pozicijos:pdf' pozicija.pk %}?preview=1">
          Peržiūra (HTML)
        </a>
        <a class="btn"
           href="{% url 'pozicijos:pdf' pozicija.pk %}">
          PDF
        </a>
      {% endif %}
    </div>
  </div>
</form>
{% endblock %}

{% block page_js %}
<script>
  (function() {
    const form = document.getElementById('proposal-form');
    if (!form) return;

    // automatinis submit, kai keičiasi varnelės
    form.addEventListener('change', function (e) {
      const t = e.target;
      if (!t || !t.name) return;
      if (t.name === 'show_prices' || t.name === 'show_drawings') {
        form.submit();
      }
    });
  })();
</script>
{% endblock %}
