{% extends "base.html" %}
{% load static %}

{% block title %}Pozicija {{ pozicija.poz_kodas|default:pozicija.id }}{% endblock %}
{% block body_class %}pozicija-detail-page{% endblock %}

{% block page_css %}
<style>
  .pozicija-detail-page {
    background:#f3f3f3;
  }

  .pozicija-detail-page .poz-detail-container {
    max-width:1200px;
    margin:0 auto;
    padding:16px 20px 32px;
  }

  .pozicija-detail-page .detail-header-bar {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:16px;
  }

  .pozicija-detail-page .detail-header-main {
    min-width:0;
  }

  .pozicija-detail-page .detail-header-title {
    margin:0 0 4px;
    font-size:1.35rem;
    font-weight:600;
  }

  .pozicija-detail-page .detail-header-sub {
    margin:0;
    font-size:0.9rem;
    color:#666;
  }

  .pozicija-detail-page .detail-header-actions {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    justify-content:flex-end;
  }

  .pozicija-detail-page .btn-action {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    font-size:0.85rem;
    border-radius:4px;
    border:1px solid #ccc;
    background:#fff;
    color:#333;
    text-decoration:none;
    cursor:pointer;
    white-space:nowrap;
  }

  .pozicija-detail-page .btn-action:hover {
    background:#f0f0f0;
  }

  .pozicija-detail-page .btn-action.btn-secondary {
    background:#e7f0ff;
    border-color:#b6c9f0;
  }

  .pozicija-detail-page .btn-action.btn-secondary:hover {
    background:#d7e4ff;
  }

  .pozicija-detail-page .poz-cards-grid {
    display:grid;
    grid-template-columns:minmax(0,1.5fr) minmax(0,1.2fr);
    gap:16px;
    align-items:stretch;   /* Brėžiniai išsitempia iki kairės kolonos aukščio */
  }

  .pozicija-detail-page .poz-card {
    background:#fff;
    border:1px solid #e1e1e1;
    border-radius:6px;
    padding:12px 14px 10px;
    box-shadow:0 1px 2px rgba(0,0,0,.04);
  }

  .pozicija-detail-page .poz-card--full {
    grid-column:1 / -1;
  }

  .pozicija-detail-page .poz-card-title {
    margin:0 0 8px;
    font-size:0.95rem;
    font-weight:600;
    color:#333;
  }

  .pozicija-detail-page .poz-fields {
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .pozicija-detail-page .poz-field-row {
    display:grid;
    grid-template-columns:minmax(0,42%) minmax(0,58%);
    column-gap:8px;
    align-items:flex-start;
    font-size:0.9rem;
    padding:2px 0;
  }

  .pozicija-detail-page .poz-field-label {
    color:#777;
    text-align:left;
  }

  .pozicija-detail-page .poz-field-value {
    color:#222;
    word-wrap:break-word;
    overflow-wrap:anywhere;
  }

  /* MIRKSINČIAI reikšmei (Faktinis kiekis rėme) */
  .pozicija-detail-page .poz-field-value--blink-red {
    color:#b91c1c;
    font-weight:600;
    animation: blinkRed 1s steps(2, start) infinite;
  }

  @keyframes blinkRed {
    0%, 49%   { color:#b91c1c; }
    50%, 100% { color:#fecaca; }
  }

  .pozicija-detail-page .poz-empty {
    margin:4px 0 0;
    font-size:0.88rem;
    color:#999;
    font-style:italic;
  }

  /* Pastabos */
  .pozicija-detail-page .poz-notes-text {
    font-size:0.9rem;
    line-height:1.4;
    white-space:pre-wrap;
  }

  /* Kainų lentelė */
  .pozicija-detail-page .poz-price-table-wrapper {
    margin-top:8px;
    overflow-x:auto;
  }

  .pozicija-detail-page .poz-price-table {
    width:100%;
    border-collapse:collapse;
    font-size:0.88rem;
  }

  .pozicija-detail-page .poz-price-table th,
  .pozicija-detail-page .poz-price-table td {
    border:1px solid #e1e1e1;
    padding:4px 6px;
    text-align:left;
    white-space:nowrap;
  }

  .pozicija-detail-page .poz-price-table th {
    background:#f5f5f5;
    font-weight:600;
  }

  .pozicija-detail-page .poz-price-table tbody tr:nth-child(even) td {
    background:#fafafa;
  }

  .pozicija-detail-page .poz-price-table tbody tr:hover td {
    background:#f0f4ff;
  }

  .pozicija-detail-page .poz-card-footer {
    margin-top:8px;
    display:flex;
    justify-content:flex-end;
  }

  /* Kairės viršutinės kolonos wrapperis (Klientas/Projektas + Detalė) */
  .pozicija-detail-page .poz-col-left {
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  /* Brėžinių blokas */
  .pozicija-detail-page .poz-brez-grid {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }

  .pozicija-detail-page .poz-brez-item {
    width:130px;
    border:1px solid #e1e1e1;
    border-radius:4px;
    padding:4px;
    background:#fafafa;
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .pozicija-detail-page .poz-brez-thumb-wrap {
    width:100%;
    aspect-ratio:4/3;
    border-radius:3px;
    overflow:hidden;
    background:#fff;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .pozicija-detail-page .poz-brez-thumb {
    max-width:100%;
    max-height:100%;
    display:block;
  }

  .pozicija-detail-page .poz-brez-thumb-stp {
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:1.1rem;
    font-weight:600;
    letter-spacing:1px;
    border:1px dashed #cbd5f5;
    background:#eef2ff;
    color:#4b5563;
    text-transform:uppercase;
  }

  .pozicija-detail-page .poz-brez-title {
    font-size:0.8rem;
    font-weight:500;
    color:#333;
    word-wrap:break-word;
  }

  .pozicija-detail-page .poz-brez-actions {
    display:flex;
    flex-wrap:wrap;
    gap:4px;
    align-items:center;
  }

  .pozicija-detail-page .btn-ghost-sm,
  .pozicija-detail-page .btn-link-sm {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:3px 8px;
    font-size:0.78rem;
    border-radius:999px;
    border:1px solid #cbd5f5;
    background:#eef2ff;
    color:#1e40af;
    cursor:pointer;
    text-decoration:none;
    line-height:1.2;
  }

  .pozicija-detail-page .btn-ghost-sm:hover {
    background:#e0e7ff;
  }

  .pozicija-detail-page .btn-link-sm {
    border-color:#fecaca;
    background:#fef2f2;
    color:#b91c1c;
  }

  .pozicija-detail-page .btn-link-sm:hover {
    background:#fee2e2;
  }

  /* Upload form po brėžiniais */
  .pozicija-detail-page .poz-brez-upload-form {
    margin-top:10px;
    padding-top:8px;
    border-top:1px dashed #e5e7eb;
  }

  .pozicija-detail-page .poz-brez-upload-row {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    align-items:center;
  }

  .pozicija-detail-page .poz-brez-upload-row input[type="text"] {
    flex:1 1 180px;
    min-width:0;
    padding:4px 6px;
    font-size:0.85rem;
    border-radius:4px;
    border:1px solid #d1d5db;
  }

  .pozicija-detail-page .poz-brez-upload-row input[type="file"] {
    flex:1 1 220px;
    font-size:0.85rem;
  }

  .pozicija-detail-page .poz-brez-upload-help {
    margin-top:4px;
    font-size:0.78rem;
    color:#6b7280;
  }

  .pozicija-detail-page .poz-meta {
    font-size:0.88rem;
  }

  .pozicija-detail-page .poz-meta-row {
    display:flex;
    justify-content:space-between;
    gap:8px;
  }

  .pozicija-detail-page .poz-meta-label {
    color:#777;
  }

  .pozicija-detail-page .poz-meta-value {
    color:#222;
  }

  @media (max-width: 900px) {
    .pozicija-detail-page .detail-header-bar {
      flex-direction:column;
      align-items:flex-start;
    }

    .pozicija-detail-page .poz-cards-grid {
      grid-template-columns:1fr;
    }

    .pozicija-detail-page .poz-card,
    .pozicija-detail-page .poz-card--full,
    .pozicija-detail-page .poz-col-left {
      grid-column:1 / -1;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="pozicija-detail-page">
  <div class="poz-detail-container">
    <div class="detail-header-bar">
      <div class="detail-header-main">
        <h1 class="detail-header-title">
          {% if pozicija.poz_kodas %}{{ pozicija.poz_kodas }} – {% endif %}{{ pozicija.poz_pavad|default:"Be pavadinimo" }}
        </h1>
        <p class="detail-header-sub">
          Klientas: {{ pozicija.klientas|default:"—" }}{% if pozicija.projektas %} · Projektas: {{ pozicija.projektas }}{% endif %}
        </p>
      </div>
      <div class="detail-header-actions">
        <a href="{% url 'pozicijos:edit' pozicija.id %}" class="btn-action">Redaguoti</a>
        <a href="{% url 'pozicijos:proposal_prepare' pozicija.id %}" class="btn-action btn-secondary">Pasiūlymas</a>
        <a href="{% url 'pozicijos:list' %}" class="btn-action">Atgal į sąrašą</a>
      </div>
    </div>

    <div class="poz-cards-grid">

      {# KAIRĖ viršuje: Klientas/Projektas + Detalė #}
      <div class="poz-col-left">

        <section class="poz-card">
          <h2 class="poz-card-title">Klientas / projektas</h2>
          <div class="poz-fields">
            <div class="poz-field-row">
              <span class="poz-field-label">Klientas</span>
              <span class="poz-field-value">{{ pozicija.klientas|default:"—" }}</span>
            </div>
            <div class="poz-field-row">
              <span class="poz-field-label">Projektas</span>
              <span class="poz-field-value">{{ pozicija.projektas|default:"—" }}</span>
            </div>
            <div class="poz-field-row">
              <span class="poz-field-label">Pozicijos kodas</span>
              <span class="poz-field-value">{{ pozicija.poz_kodas|default:"—" }}</span>
            </div>
            <div class="poz-field-row">
              <span class="poz-field-label">Pozicijos pavadinimas</span>
              <span class="poz-field-value">{{ pozicija.poz_pavad|default:"—" }}</span>
            </div>
          </div>
        </section>

        <section class="poz-card poz-card--detail">
          <h2 class="poz-card-title">Detalė</h2>
          <div class="poz-fields">
            <div class="poz-field-row">
              <span class="poz-field-label">Metalas</span>
              <span class="poz-field-value">{{ pozicija.metalas|default:"—" }}</span>
            </div>
            <div class="poz-field-row">
              <span class="poz-field-label">Plotas</span>
              <span class="poz-field-value">
                {% if pozicija.plotas %}{{ pozicija.plotas }}{% else %}—{% endif %}
              </span>
            </div>
            <div class="poz-field-row">
              <span class="poz-field-label">Svoris</span>
              <span class="poz-field-value">
                {% if pozicija.svoris %}{{ pozicija.svoris }}{% else %}—{% endif %}
              </span>
            </div>
            <div class="poz-field-row">
              <span class="poz-field-label">Testai / kokybė</span>
              <span class="poz-field-value">{{ pozicija.testai_kokybe|default:"—" }}</span>
            </div>
          </div>
        </section>

      </div>

      {# DEŠINĖ viršuje: Brėžiniai #}
      <section class="poz-card poz-card--brez">
        <h2 class="poz-card-title">Brėžiniai</h2>

        {% if breziniai %}
          <div class="poz-brez-grid">
            {% for brez in breziniai %}
              <div class="poz-brez-item">
                <a href="{{ brez.failas.url }}" target="_blank" class="poz-brez-thumb-wrap">
                  {% if brez.thumb_url %}
                    <img src="{{ brez.thumb_url }}"
                         alt="{{ brez.pavadinimas|default:'Brėžinys' }}"
                         class="poz-brez-thumb">
                  {% else %}
                    {% if brez.ext %}
                      {% with e=brez.ext|lower %}
                        {% if e == "stp" or e == "step" %}
                          <div class="poz-brez-thumb-stp">STP</div>
                        {% else %}
                          <img src="{{ brez.failas.url }}"
                               alt="{{ brez.pavadinimas|default:'Brėžinys' }}"
                               class="poz-brez-thumb">
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <img src="{{ brez.failas.url }}"
                           alt="{{ brez.pavadinimas|default:'Brėžinys' }}"
                           class="poz-brez-thumb">
                    {% endif %}
                  {% endif %}
                </a>

                <div class="poz-brez-title">
                  {{ brez.pavadinimas|default:brez.filename }}
                </div>

                <div class="poz-brez-actions">
                  {% if brez.ext %}
                    {% with e=brez.ext|lower %}
                      {% if e == "stp" or e == "step" %}
                        <a href="{% url 'pozicijos:brezinys_3d' pozicija.id brez.id %}"
                           target="_blank"
                           class="btn-ghost-sm">3D</a>
                      {% endif %}
                    {% endwith %}
                  {% endif %}

                  <form method="post"
                        action="{% url 'pozicijos:brezinys_delete' pozicija.id brez.id %}"
                        onsubmit="return confirm('Ar tikrai šalinti brėžinį?');">
                    {% csrf_token %}
                    <button type="submit" class="btn-link-sm">Šalinti</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="poz-empty">Nėra brėžinių.</p>
        {% endif %}

        <form method="post"
              action="{% url 'pozicijos:brezinys_upload' pozicija.id %}"
              enctype="multipart/form-data"
              class="poz-brez-upload-form">
          {% csrf_token %}
          <div class="poz-brez-upload-row">
            <input type="text"
                   name="pavadinimas"
                   placeholder="Brėžinio pavadinimas (nebūtina)">
            <input type="file"
                   name="failas"
                   accept=".pdf,.png,.jpg,.jpeg,.stp,.step,.dwg,.dxf"
                   required>
            <button type="submit" class="btn-action btn-secondary">Pridėti brėžinį</button>
          </div>
          <div class="poz-brez-upload-help">
            Leidžiami PDF, PNG, JPG, STP/STEP ir kiti brėžinių failai.
          </div>
        </form>
      </section>

      {# 4. Kabinimas #}
      <section class="poz-card">
        <h2 class="poz-card-title">Kabinimas</h2>
        <div class="poz-fields">
          <div class="poz-field-row">
            <span class="poz-field-label">Kabinimo būdas</span>
            <span class="poz-field-value">{{ pozicija.kabinimo_budas|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Kabinimas rėme</span>
            <span class="poz-field-value">{{ pozicija.kabinimas_reme|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Detalių kiekis rėme</span>
            <span class="poz-field-value">
              {% if pozicija.detaliu_kiekis_reme %}{{ pozicija.detaliu_kiekis_reme }}{% else %}—{% endif %}
            </span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Faktinis kiekis rėme</span>
            {% with det=pozicija.detaliu_kiekis_reme fak=pozicija.faktinis_kiekis_reme %}
              {% if det != fak %}
                <span class="poz-field-value poz-field-value--blink-red">
              {% else %}
                <span class="poz-field-value">
              {% endif %}
                  {% if fak %}
                    {{ fak }}
                  {% else %}
                    —
                  {% endif %}
                </span>
            {% endwith %}
          </div>
        </div>
      </section>

      {# 5. Dažymas #}
      <section class="poz-card">
        <h2 class="poz-card-title">Dažymas</h2>
        <div class="poz-fields">
          <div class="poz-field-row">
            <span class="poz-field-label">Paruošimas</span>
            <span class="poz-field-value">{{ pozicija.paruosimas|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Padengimas</span>
            <span class="poz-field-value">{{ pozicija.padengimas|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Padengimo standartas</span>
            <span class="poz-field-value">{{ pozicija.padengimo_standartas|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Spalva</span>
            <span class="poz-field-value">{{ pozicija.spalva|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Maskavimas</span>
            <span class="poz-field-value">{{ pozicija.maskavimas|default:"—" }}</span>
          </div>
        </div>
      </section>

      {# 6. Pakavimas #}
      <section class="poz-card">
        <h2 class="poz-card-title">Pakavimas</h2>
        <div class="poz-fields">
          <div class="poz-field-row">
            <span class="poz-field-label">Pakavimas</span>
            <span class="poz-field-value">{{ pozicija.pakavimas|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Instrukcija</span>
            <span class="poz-field-value">{{ pozicija.instrukcija|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Pakavimo dienos norma</span>
            <span class="poz-field-value">
              {% if pozicija.pakavimo_dienos_norma %}{{ pozicija.pakavimo_dienos_norma }}{% else %}—{% endif %}
            </span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Pakavimas po KTL</span>
            <span class="poz-field-value">{{ pozicija.pak_po_ktl|default:"—" }}</span>
          </div>
          <div class="poz-field-row">
            <span class="poz-field-label">Pakavimas po milt. dažymo</span>
            <span class="poz-field-value">{{ pozicija.pak_po_milt|default:"—" }}</span>
          </div>
        </div>
      </section>

      {# 7. Terminai #}
      <section class="poz-card">
        <h2 class="poz-card-title">Terminai</h2>
        <div class="poz-fields">
          <div class="poz-field-row">
            <span class="poz-field-label">Atlikimo terminas</span>
            <span class="poz-field-value">
              {% if pozicija.atlikimo_terminas %}
                {{ pozicija.atlikimo_terminas|date:"Y-m-d" }}
              {% else %}
                —
              {% endif %}
            </span>
          </div>
        </div>
      </section>

      {# 8. Kaina #}
      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Kaina</h2>
        <div class="poz-fields">
          <div class="poz-field-row">
            <span class="poz-field-label">Bendra kaina</span>
            <span class="poz-field-value">
              {% if pozicija.kaina_eur %}
                {{ pozicija.kaina_eur }}&nbsp;€
              {% else %}
                —
              {% endif %}
            </span>
          </div>
        </div>

        {% if kainos_akt %}
          <div class="poz-price-table-wrapper">
            <table class="poz-price-table">
              <thead>
                <tr>
                  <th>Matas</th>
                  <th>Kiekis</th>
                  <th>Kaina</th>
                  <th>Galioja</th>
                  <th>Pastaba</th>
                </tr>
              </thead>
              <tbody>
                {% for eil in kainos_akt %}
                  <tr>
                    <td>{{ eil.matas|default:"—" }}</td>
                    <td>
                      {% if eil.yra_fiksuota %}
                        {% if eil.fiksuotas_kiekis %}
                          {{ eil.fiksuotas_kiekis }} (fiksuotas)
                        {% else %}
                          Fiksuotas kiekis
                        {% endif %}
                      {% else %}
                        {% if eil.kiekis_nuo or eil.kiekis_iki %}
                          {% if eil.kiekis_nuo %}{{ eil.kiekis_nuo }}{% endif %}
                          ..
                          {% if eil.kiekis_iki %}{{ eil.kiekis_iki }}{% endif %}
                        {% else %}
                          —
                        {% endif %}
                      {% endif %}
                    </td>
                    <td>
                      {% if eil.kaina %}
                        {{ eil.kaina }}&nbsp;€
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>
                      {% if eil.galioja_nuo or eil.galioja_iki %}
                        {% if eil.galioja_nuo %}{{ eil.galioja_nuo|date:"Y-m-d" }}{% endif %}
                        –
                        {% if eil.galioja_iki %}{{ eil.galioja_iki|date:"Y-m-d" }}{% endif %}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>{{ eil.pastaba|default:"—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="poz-empty">Nėra aktualių kainų eilučių.</p>
        {% endif %}

        <div class="poz-card-footer">
          <a href="{% url 'pozicijos:kainos_list' pozicija.id %}" class="btn-action btn-secondary">Valdyti kainas</a>
        </div>
      </section>

      {# 9. Sistemos informacija #}
      <section class="poz-card">
        <h2 class="poz-card-title">Sistemos informacija</h2>
        <div class="poz-meta">
          <div class="poz-meta-row">
            <span class="poz-meta-label">Sukurta</span>
            <span class="poz-meta-value">
              {% if pozicija.created %}
                {{ pozicija.created|date:"Y-m-d H:i" }}
              {% else %}
                —
              {% endif %}
            </span>
          </div>
          <div class="poz-meta-row">
            <span class="poz-meta-label">Atnaujinta</span>
            <span class="poz-meta-value">
              {% if pozicija.updated %}
                {{ pozicija.updated|date:"Y-m-d H:i" }}
              {% else %}
                —
              {% endif %}
            </span>
          </div>
          <div class="poz-meta-row">
            <span class="poz-meta-label">Brėžinių skaičius</span>
            <span class="poz-meta-value">
              {% if pozicija.brez_count is not None %}
                {{ pozicija.brez_count }}
              {% else %}
                —
              {% endif %}
            </span>
          </div>
          <div class="poz-meta-row">
            <span class="poz-meta-label">Dokumentų skaičius</span>
            <span class="poz-meta-value">
              {% if pozicija.dok_count is not None %}
                {{ pozicija.dok_count }}
              {% else %}
                —
              {% endif %}
            </span>
          </div>
        </div>
      </section>

      {# 10. Pastabos #}
      <section class="poz-card poz-card--full">
        <h2 class="poz-card-title">Pastabos</h2>
        {% if pozicija.pastabos %}
          <div class="poz-notes-text">
            {{ pozicija.pastabos|linebreaksbr }}
          </div>
        {% else %}
          <p class="poz-empty">Nėra pastabų.</p>
        {% endif %}
      </section>

    </div>
  </div>
</div>
{% endblock %}
