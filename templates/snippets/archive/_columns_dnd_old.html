{# templates/pozicijos/snippets/columns_dnd.html #}
<style>
  /* Paprastas šoninis stalčius */
  .cols-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.15);opacity:0;pointer-events:none;transition:opacity .2s;}
  .cols-drawer{position:fixed;top:0;right:-380px;width:360px;max-width:90vw;height:100%;background:#fff;
    box-shadow:-6px 0 18px rgba(0,0,0,.12);transition:right .25s;display:flex;flex-direction:column;}
  .cols-backdrop.open{opacity:1;pointer-events:auto;}
  .cols-drawer.open{right:0;}
  .cols-head{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid #e5e5e5;}
  .cols-body{padding:1rem;display:flex;flex-direction:column;gap:.75rem;overflow:auto;}
  .cols-actions{display:flex;gap:.5rem;flex-wrap:wrap;}
  .cols-search{width:100%;padding:.45rem .55rem;border:1px solid #ddd;border-radius:6px;}
  .cols-list{display:flex;flex-direction:column;gap:.25rem;}
  .col-item{display:flex;align-items:center;gap:.6rem;padding:.3rem .4rem;border-radius:6px;cursor:grab;user-select:none;}
  .col-item:active{cursor:grabbing;}
  .col-item.drag-over{outline:2px dashed #bbb;}
  .col-item input[type="checkbox"]{transform:translateY(1px);}
  .cols-foot{padding: .8rem 1rem;border-top:1px solid #e5e5e5;display:flex;justify-content:flex-end;}
  .btn{display:inline-flex;align-items:center;gap:.35rem;padding:.42rem .65rem;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer;}
  .btn:hover{background:#f8f8f8;}
</style>

<div id="colsBackdrop" class="cols-backdrop" aria-hidden="true"></div>
<aside id="colsPanel" class="cols-drawer" aria-hidden="true">
  <div class="cols-head">
    <strong>Stulpeliai</strong>
    <button type="button" id="colsClose" class="btn" aria-label="Uždaryti">✕</button>
  </div>

  <div class="cols-body">
    <input id="colsSearch" class="cols-search" type="search" placeholder="Filtruoti pagal pavadinimą…">
    <div class="cols-actions">
      <button type="button" id="colsDefaults" class="btn">Numatytieji</button>
      <button type="button" id="colsSelectAllBtn" class="btn">Pažymėti visus</button>
      <button type="button" id="colsSelectNone" class="btn">Nuimti visus</button>
    </div>
    <div id="colsList" class="cols-list" aria-live="polite"></div>
  </div>

  <div class="cols-foot">
    <button type="button" id="colsDone" class="btn">Uždaryti</button>
  </div>
</aside>

<script>
(function(){
  const drawer = document.getElementById('colsPanel');
  const backdrop = document.getElementById('colsBackdrop');
  const btnOpen = document.getElementById('openCols'); // jei turi išorėje
  const btnClose = document.getElementById('colsClose');
  const btnDone  = document.getElementById('colsDone');
  const btnDefaults = document.getElementById('colsDefaults');
  const btnAll = document.getElementById('colsSelectAllBtn');
  const btnNone = document.getElementById('colsSelectNone');
  const listEl = document.getElementById('colsList');
  const searchEl = document.getElementById('colsSearch');

  // ---- Šaltiniai: ALL_COLUMNS ir DEFAULT_COLS (jei yra) ----
  // ALL_COLUMNS: [{key:"...", label:"..."}, ...]
  // Jei nėra, bandome perskaityti iš #results-table thead th[data-key]
  function readColumnsFromTable(){
    const tbl = document.getElementById('results-table') || document.querySelector('table');
    const ths = tbl ? Array.from(tbl.querySelectorAll('thead th')) : [];
    return ths.map((th,i)=>({ key: th.dataset.key || (th.getAttribute('data-key')) || th.textContent.trim() || ('col_'+(i+1)),
                              label: th.textContent.trim() || th.dataset.label || th.getAttribute('aria-label') || ('Stulpelis '+(i+1)) }));
  }
  const ALL_COLUMNS = Array.isArray(window.ALL_COLUMNS) && window.ALL_COLUMNS.length ? window.ALL_COLUMNS.slice() : readColumnsFromTable();
  const DEFAULT_COLS = Array.isArray(window.DEFAULT_COLS) && window.DEFAULT_COLS.length ? window.DEFAULT_COLS.slice() : ALL_COLUMNS.map(c=>c.key);

  function getVisibleCols(){
    try{
      const raw = localStorage.getItem('poz_cols');
      if (!raw) return DEFAULT_COLS.slice();
      const arr = JSON.parse(raw);
      return (Array.isArray(arr) && arr.length) ? arr : DEFAULT_COLS.slice();
    }catch(e){ return DEFAULT_COLS.slice(); }
  }
  function setVisibleCols(cols){
    localStorage.setItem('poz_cols', JSON.stringify(cols));
  }

  // ---- UI valdymas ----
  function openDrawer(){
    drawer.classList.add('open');
    backdrop.classList.add('open');
    drawer.setAttribute('aria-hidden','false');
  }
  function closeDrawer(){
    drawer.classList.remove('open');
    backdrop.classList.remove('open');
    drawer.setAttribute('aria-hidden','true');
  }

  if (btnOpen) btnOpen.addEventListener('click', openDrawer);
  btnClose.addEventListener('click', closeDrawer);
  btnDone.addEventListener('click', closeDrawer);
  backdrop.addEventListener('click', closeDrawer);

  // ---- Sąrašo piešimas + DnD ----
  function makeItem(col, checked){
    const li = document.createElement('div');
    li.className = 'col-item';
    li.draggable = true;
    li.dataset.key = col.key;
    li.innerHTML = `<input type="checkbox" ${checked?'checked':''} aria-label="Rodyti ${col.label}">
                    <span>${col.label}</span>`;
    // drag
    li.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', col.key); li.classList.add('dragging'); });
    li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
    li.addEventListener('dragover', (e)=>{ e.preventDefault(); li.classList.add('drag-over'); });
    li.addEventListener('dragleave', ()=> li.classList.remove('drag-over'));
    li.addEventListener('drop', (e)=>{
      e.preventDefault();
      li.classList.remove('drag-over');
      const srcKey = e.dataTransfer.getData('text/plain');
      const dstKey = li.dataset.key;
      if (!srcKey || !dstKey || srcKey===dstKey) return;

      // Perstatom ALL_COLUMNS tvarką
      const si = ALL_COLUMNS.findIndex(c=>c.key===srcKey);
      const di = ALL_COLUMNS.findIndex(c=>c.key===dstKey);
      if (si<0 || di<0) return;
      const [moved] = ALL_COLUMNS.splice(si,1);
      ALL_COLUMNS.splice(di,0,moved);

      // Perstatom ir matomų stulpelių (poz_cols) tvarką, bet tik tie, kurie pažymėti
      const vis = getVisibleCols().filter(k=>ALL_COLUMNS.some(c=>c.key===k));
      const sVisIdx = vis.indexOf(srcKey);
      const dVisIdx = vis.indexOf(dstKey);
      if (sVisIdx>-1 && dVisIdx>-1){
        const [mv] = vis.splice(sVisIdx,1);
        vis.splice(dVisIdx,0,mv);
        setVisibleCols(vis);
        announceChange();
      }
      renderList(); // perpiešiam UI
    });

    // checkbox
    li.querySelector('input[type="checkbox"]').addEventListener('change', (e)=>{
      const vis = getVisibleCols();
      const k = col.key;
      if (e.target.checked){
        if (!vis.includes(k)) vis.push(k);
      }else{
        const i = vis.indexOf(k);
        if (i>=0) vis.splice(i,1);
      }
      setVisibleCols(vis);
      announceChange();
    });

    return li;
  }

  function renderList(){
    const term = (searchEl.value||"").trim().toLowerCase();
    const visible = new Set(getVisibleCols());
    listEl.innerHTML = '';
    ALL_COLUMNS.forEach(col=>{
      if (term && !String(col.label||col.key).toLowerCase().includes(term)) return;
      listEl.appendChild(makeItem(col, visible.has(col.key)));
    });
  }

  searchEl.addEventListener('input', renderList);

  // ---- Veiksmai: numatytieji / visi / nuimti ----
  btnDefaults.addEventListener('click', ()=>{
    setVisibleCols(DEFAULT_COLS.slice());
    announceChange(); renderList();
  });

  btnAll.addEventListener('click', ()=>{
    const all = ALL_COLUMNS.map(c=>c.key);
    setVisibleCols(all);
    announceChange(); renderList();
  });

  btnNone.addEventListener('click', ()=>{
    setVisibleCols([]);
    announceChange(); renderList();
  });

  // ---- Skelbiam pokytį: tegul klausosi sąrašas ir sticky ----
  function announceChange(){
    window.dispatchEvent(new Event('poz:cols-changed'));
    if (typeof window.applySticky === 'function') {
      try { window.applySticky(); } catch(_) {}
    }
  }

  // ---- Pirmas piešimas ----
  renderList();

  // Jei sąrašo šone jau yra „Stulpeliai“ mygtukas, paliekam jį; jeigu nėra, nepaisom.
})();
</script>
