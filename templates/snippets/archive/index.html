{% extends "base.html" %}
{% load static %}

{% block title %}Pradinis{% endblock %}
{% block body_class %}compact-top{% endblock %}
{% block global_links %}{% endblock %}

{% block page_css %}
<style>
  :root{
    --chart-h:clamp(120px,18vw,220px);
  }

  /* Viršutinė juosta: mygtukai KAIRĖJE, grafikas DEŠINĖJE */
  .header-right .header-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin:4px 0;
  }
  .header-right .top-links{
    display:flex; gap:8px; flex-wrap:nowrap; align-items:center;
  }
  .btn{display:inline-block;border:1px solid #d0d7de;border-radius:6px;
       padding:4px 8px;background:#f6f8fa;color:#111;text-decoration:none;font-size:14px}
  .btn:hover{background:#eef1f4}

  .header-right .chart-wrap{
    flex:0 0 30%;   /* rezervuoja max 30% pločio */
    min-width:200px;
    display:flex; justify-content:flex-end;
  }
  #detaliuGrafikas{
    width:100%!important;
    height:var(--chart-h)!important;
    display:block;
  }
</style>
{% endblock %}

{% block header_right %}
<div class="header-top">
  <!-- KAIRĖJE: 2 mygtukai -->
  <div class="top-links">
    <a class="btn" href="{% url 'detaliu_registras:ivesti_uzklausa' %}">Įvesti užklausą</a>
    <a class="btn" href="{% url 'detaliu_registras:uzklausa_list' %}">Peržiūrėti užklausas</a>
  </div>

  <!-- DEŠINĖJE: grafikas -->
  <div class="chart-wrap">
    <canvas id="detaliuGrafikas"></canvas>
  </div>
</div>
{% endblock %}

{% block content %}
<h1>Pradinis</h1>

<div class="card pad">
  <h3 class="section-title">Naujausios užklausos</h3>
  <div class="table-wrap">
    <table id="uzklausu-lentele">
      <thead>
        <tr class="labels">
          <th>ID</th>
          <th>Klientas</th>
          <th>Projektas</th>
          <th>Detalė</th>
          <th>Brėžinio Nr.</th>
          <th>Užklausos data</th>
          <th>Pastabos</th>
          <th>Veiksmai</th>
        </tr>
        <tr class="filters">
          <th><input oninput="filterTable(0)" placeholder="ID"></th>
          <th><input oninput="filterTable(1)" placeholder="Klientas"></th>
          <th><input oninput="filterTable(2)" placeholder="Projektas"></th>
          <th><input oninput="filterTable(3)" placeholder="Detalė"></th>
          <th><input oninput="filterTable(4)" placeholder="Brėžinys"></th>
          <th><input oninput="filterTable(5)" placeholder="Data"></th>
          <th><input oninput="filterTable(6)" placeholder="Pastabos"></th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for uzklausa in uzklausos %}
          <tr>
            <td>#{{ uzklausa.id }}</td>
            <td>{{ uzklausa.klientas.vardas }}</td>
            <td>{{ uzklausa.projektas.pavadinimas }}</td>
            <td>{{ uzklausa.detale.pavadinimas }}</td>
            <td>{{ uzklausa.detale.brezinio_nr }}</td>
            <td>{{ uzklausa.projektas.uzklausos_data }}</td>
            <td class="notes-cell">{{ uzklausa.detale.pastabos }}</td>
            <td><a class="btn" href="{% url 'detaliu_registras:perziureti_uzklausa' uzklausa_id=uzklausa.id %}">Peržiūrėti</a></td>
          </tr>
        {% empty %}
          <tr><td colspan="8" style="text-align:center;color:#6a737d">Įrašų nėra</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block page_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function filterTable(col){
    const t=document.getElementById("uzklausu-lentele"); if(!t) return;
    const v=((t.tHead&&t.tHead.rows[1]&&t.tHead.rows[1].cells[col].querySelector("input")||{}).value||"").toLowerCase();
    [...t.tBodies[0].rows].forEach(r=>{
      const txt=(r.cells[col]?.innerText||"").toLowerCase();
      r.style.display=txt.includes(v)?"":"none";
    });
  }

  (function(){
    const raw = {{ klientu_duomenys_json|default:"[]"|safe }};
    const el = document.getElementById('detaliuGrafikas'); if(!el) return;

    const items = raw.map(r => ({
      name: r.klientas__vardas || r.vardas || "Nenurodyta",
      count: Number(r.uzklausu_kiekis ?? r.kiekis ?? 0)
    })).filter(i => i.count > 0);

    function randomColors(n){
      const start=Math.random()*360, g=137.508, colors=[], hovers=[];
      for(let i=0;i<n;i++){
        const h=(start+i*g)%360;
        colors.push(`hsl(${h.toFixed(1)},70%,55%)`);
        hovers.push(`hsl(${h.toFixed(1)},70%,45%)`);
      }
      return {colors, hovers};
    }
    const {colors, hovers} = randomColors(items.length);

    const chart = new Chart(el.getContext('2d'), {
      type:'doughnut',
      data:{
        labels: items.map(i=>i.name),
        datasets:[{
          data: items.map(i=>i.count),
          backgroundColor: colors,
          hoverBackgroundColor: hovers,
          borderWidth: 0
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false, cutout:'55%',
        plugins:{
          legend:{
            position:'right',
            labels:{ boxWidth:10, padding:8 },
            onClick:(e, item, legend)=>{
              const c=legend.chart, i=item.index;
              c.toggleDataVisibility(i); c.update();
            }
          },
          tooltip:{ callbacks:{ label:(c)=>`${c.label}: ${c.formattedValue}` } }
        },
        onClick:(evt, els)=>{
          if(!els?.length) return;
          const i = els[0].index;
          const name = chart.data.labels[i] || '';
          const url = "{% url 'detaliu_registras:uzklausa_list' %}?q=" + encodeURIComponent(name);
          window.location.href = url;
        }
      }
    });
  })();
</script>
{% endblock %}
